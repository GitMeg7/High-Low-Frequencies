---
title: "CO2_Flux"
author: "Mégane"
date: "2023-03-20"
output: html_document
---

# Air--Sea CO2 Flux (2007-2022) -- Article DE CARLO

Data : - pCO2 water (uatm) - pCO2 air (ppm) - wind speed 10m (m/s)

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
```


```{r importation data pCO2 water, echo=FALSE, warning=FALSE, message=FALSE}

###Importation des donnees
##Data pCO2 water
#a partir de janvier 2007 jusqu'a janvier 2022

SOMLIT_carbo_chemistry <- read_csv("../Data/data_pH_steeve.csv")

#differenciation surface / 50m

SOMLIT_carbo_chemistry_surf <- SOMLIT_carbo_chemistry %>% 
  dplyr::filter(depth==0) %>% 
  select(sampling_date, salinity, temperature, ta, dic, NO2, NO3, Chla, pH_calc, pCO2) %>% 
  rename(pCO2_water_uatm = pCO2, datetime = sampling_date) %>%
  mutate(salinity = case_when(salinity < 35 ~ NA_real_ , TRUE ~ salinity))

SOMLIT_carbo_chemistry_50m <- SOMLIT_carbo_chemistry %>% 
  dplyr::filter(depth==50)
##

```

## Importation data pCO2 atmosphere (ICOS)
→ 5 sites
→ Frequency : hourly
→ Selection of data taken at 09:00 AM

1 : Monte Cimone (8m) - 2011-2022
2 : Plateau Rosa (10m) - 2007-2022
3 : Corse Ersa (40m) - 2013-2020
4 : Observatoire Haute Provence (10m) - 2014-2020
5 : Lampedusa (10) - 2006-2022

```{r importation data air Monte Cimone (8m), echo=FALSE, warning=FALSE, message=FALSE}
#unity (umol/mol, soit ppm)
#a 1atm (surface), ppm = uatm

### MONTE CIMONE
atmospheric_co2_MONTE_CIMONE <- read_delim("../Data/atmospheric_co2_MONTE_CIMONE_fev_2011_2022.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
atmospheric_co2_MONTE_CIMONE <- atmospheric_co2_MONTE_CIMONE %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>%
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  filter(time == "09:00")

#data sorting :
atmospheric_co2_MONTE_CIMONE <- atmospheric_co2_MONTE_CIMONE %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_MC = co2) %>% 
  mutate(CO2_MC = case_when(CO2_MC == -999.990 ~ NA_real_ , TRUE ~ CO2_MC)) %>%
  select(datetime, CO2_MC)

####################

### PLATEAU ROSA
atmospheric_co2_PLATEAU_ROSA <- read_delim("../Data/atmospheric_co2_PLATEAU_ROSA_2007_2022.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
atmospheric_co2_PLATEAU_ROSA <- atmospheric_co2_PLATEAU_ROSA %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  filter(time == "09:00")

#data sorting :
atmospheric_co2_PLATEAU_ROSA <- atmospheric_co2_PLATEAU_ROSA %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_PR = co2) %>% 
  mutate(CO2_PR = case_when(CO2_PR == -999.990 ~ NA_real_ , TRUE ~ CO2_PR)) %>% 
  select(datetime, CO2_PR)

####################

#CORSE ERSA
atmospheric_co2_CORSE <- read_delim("../Data/atmospheric_co2_CORSE_RAW_2013_2020.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
atmospheric_co2_CORSE <- atmospheric_co2_CORSE %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  filter(time == "09:00")

#data sorting :
atmospheric_co2_CORSE <- atmospheric_co2_CORSE %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_CORSE = co2) %>% 
  mutate(CO2_CORSE = case_when(CO2_CORSE == -999.990 ~ NA_real_ , TRUE ~ CO2_CORSE)) %>% 
  select(datetime, CO2_CORSE)

####################

#OBSERVATOIRE HAUTE PROVENCE
atmospheric_co2_HAUTE_PROV <- read_delim("../Data/atmospheric_co2_HAUTE_PROVENCE_RAW_2014_2020.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
atmospheric_co2_HAUTE_PROV <- atmospheric_co2_HAUTE_PROV %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  filter(time == "09:00")

#data sorting :
atmospheric_co2_HAUTE_PROV <- atmospheric_co2_HAUTE_PROV %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_HP = co2) %>% 
  mutate(CO2_HP = case_when(CO2_HP == -999.990 ~ NA_real_ , TRUE ~ CO2_HP)) %>% 
  select(datetime, CO2_HP)

#LAMPEDUSA
atmospheric_co2_LAMPEDUSA <- read_delim("../Data/atmospheric_co2_LAMPEDUSA_2006_2022.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
atmospheric_co2_LAMPEDUSA <- atmospheric_co2_LAMPEDUSA %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  filter(time == "09:00")

#data sorting :
atmospheric_co2_LAMPEDUSA <- atmospheric_co2_LAMPEDUSA %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_LAMP = co2) %>% 
  mutate(CO2_LAMP = case_when(CO2_LAMP == -999.990 ~ NA_real_ , TRUE ~ CO2_LAMP)) %>% 
  select(datetime, CO2_LAMP)

##
```


##Visualisation 5 sites atmospheric pCO2

```{r Visualisation 5 sites atmospheric pCO2, echo=FALSE, warning=FALSE, message=FALSE}

#rajouter calcul pour dry mol fraction conversion to ppm

#creation column for legend
pCO2_atmos_long <- pCO2_atmos %>% 
  rename(Corsica = CO2_CORSE, `Haute Provence` = CO2_HP, Lampedusa = CO2_LAMP, `Monte Cimone` = CO2_MC, `Plateau Rosa` = CO2_PR) %>% 
  pivot_longer(cols=Lampedusa:`Haute Provence`, names_to = "Legend", values_to = "value")

#plot
pCO2_atmos_long %>% 
  ggplot() +
  ggtitle("Atmospheric pCO2 of 5 sites (ICOS) according to time (with NA values)") +
  geom_point(aes(x=datetime, y=value, color= Legend), size=0.5) +
  scale_y_continuous(name="Atmospheric pCO2 (µatm") + 
  scale_x_datetime(name="")




```


##Visualisation 5 sites atmospheric pCO2 NA values

```{r summary 5 sites atmospheric pCO2 NA values, echo=FALSE, warning=FALSE, message=FALSE}

#merge of 5 sites data : pCO2_air
pCO2_atmos <- left_join(atmospheric_co2_LAMPEDUSA, atmospheric_co2_MONTE_CIMONE, by="datetime")
pCO2_atmos <- left_join(pCO2_atmos, atmospheric_co2_PLATEAU_ROSA, by="datetime") 
pCO2_atmos <- left_join(pCO2_atmos, atmospheric_co2_CORSE, by="datetime")
pCO2_atmos <- left_join(pCO2_atmos, atmospheric_co2_HAUTE_PROV, by="datetime")

#summary :
summary(pCO2_atmos)
#faire plutot 1 par 1 et regrouper toutes les tables dans un mm chunck


```


### 1 : Lampedusa site (2006-2022)
Number of NA : 1805


```{r visualisation LAMPEDUSA NA values, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6,fig.height=4,fig.align='right'}

#LAMPEDUSA : 1805 NA
ggplot_na_distribution(pCO2_atmos$CO2_LAMP, x_axis_labels = pCO2_atmos$datetime, xlab = "", ylab="Atmospheric pCO2 (µatm)",
                       title="Lampedusa site - atmospheric pCO2 (2006-2022)")

#plot nb NA par années
atmospheric_co2_LAMPEDUSA_NA_plot <- atmospheric_co2_LAMPEDUSA %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

atmospheric_co2_LAMPEDUSA_NA_plot$CO2_LAMP[is.na(atmospheric_co2_LAMPEDUSA_NA_plot$CO2_LAMP)] <- "NA"

atmospheric_co2_LAMPEDUSA_NA_plot %>% 
  dplyr::filter(CO2_LAMP == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  ggtitle("NA occurences by year - Lampedusa site") +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA number", limits = c(0,300), breaks = seq(0, 300, 50))

```
### 2 : Plateau Rosa site (2007-2022)
Number of NA : 1354

```{r visualisation PLATEAU ROSA NA values, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6,fig.height=4,fig.align=right'}

#PLATEAU ROSA : 1354 NA
ggplot_na_distribution(pCO2_atmos$CO2_PR, x_axis_labels = pCO2_atmos$datetime, xlab = "", ylab="Atmospheric pCO2 (µatm)",
                       title="Plateau Rosa site - atmospheric pCO2 (2007-2022)")

#plot nb NA par années
atmospheric_co2_PLATEAU_ROSA_NA_plot <- atmospheric_co2_PLATEAU_ROSA %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

atmospheric_co2_PLATEAU_ROSA_NA_plot$CO2_PR[is.na(atmospheric_co2_PLATEAU_ROSA_NA_plot$CO2_PR)] <- "NA"

atmospheric_co2_PLATEAU_ROSA_NA_plot %>% 
  dplyr::filter(CO2_PR == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  ggtitle("NA occurences by year - Plateau Rosa site") +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA number", limits = c(0,200), breaks = seq(0, 200, 50))

```

### 3 : Monte Cimone site (2011-2022)
Number of NA : 2356

```{r visualisation MONTE CIMONE NA values, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6,fig.height=4, fig.align='right'}

#MONTE CIMONE : 2356 NA
ggplot_na_distribution(pCO2_atmos$CO2_MC, x_axis_labels = pCO2_atmos$datetime, xlab = "", ylab="Atmospheric pCO2 (µatm)",
                       title="Monte Cimone site - atmospheric pCO2 (2007-2022)")

#plot nb NA par années
atmospheric_co2_PLATEAU_ROSA_NA_plot <- atmospheric_co2_PLATEAU_ROSA %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

atmospheric_co2_PLATEAU_ROSA_NA_plot$CO2_PR[is.na(atmospheric_co2_PLATEAU_ROSA_NA_plot$CO2_PR)] <- "NA"

atmospheric_co2_PLATEAU_ROSA_NA_plot %>% 
  dplyr::filter(CO2_PR == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  ggtitle("NA occurences by year - Monte Cimone site") +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA number", limits = c(0,200), breaks = seq(0, 200, 50))

```

### 4 : Corsica site (2013-2022)
Number of NA : 3398

```{r visualisation CORSICA NA values, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6,fig.height=4,fig.align='right'}

#CORSICA : 3398 NA
ggplot_na_distribution(pCO2_atmos$CO2_CORSE, x_axis_labels = pCO2_atmos$datetime, xlab = "", ylab="Atmospheric pCO2 (µatm)",
                       title="Corsica site - atmospheric pCO2 (2013-2022)")

#plot nb NA par années
atmospheric_co2_CORSICA_NA_plot <- atmospheric_co2_CORSE %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

atmospheric_co2_CORSICA_NA_plot$CO2_CORSE[is.na(atmospheric_co2_CORSICA_NA_plot$CO2_CORSE)] <- "NA"

atmospheric_co2_CORSICA_NA_plot %>% 
  dplyr::filter(CO2_CORSE == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  ggtitle("NA occurences by year - Corsica site") +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA number", limits = c(0,150), breaks = seq(0, 150, 50))

```


### 5 : Haute-Provence observatory site (2014-2022)
Number of NA : 3086

```{r visualisation HAUTE PROVENCE NA values, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6,fig.height=4,fig.align='right'}

#HAUTE PROVENCE : 3086 NA
ggplot_na_distribution(pCO2_atmos$CO2_HP, x_axis_labels = pCO2_atmos$datetime, xlab = "", ylab="Atmospheric pCO2 (µatm)",
                       title="Haute Provence site - atmospheric pCO2 (2014-2022)")

#plot nb NA par années
atmospheric_co2_HP_NA_plot <- atmospheric_co2_HAUTE_PROV %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

atmospheric_co2_HP_NA_plot$CO2_HP[is.na(atmospheric_co2_HP_NA_plot$CO2_HP)] <- "NA"

atmospheric_co2_HP_NA_plot %>% 
  dplyr::filter(CO2_HP == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  ggtitle("NA occurences by year - Haute Provence site") +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA number", limits = c(0,50), breaks = seq(0, 50, 50))


```
## Cross interpolations of 5 sites atmospheric data

### Cross interpolation between Corsica and Haute Provence datasets :

```{r Cross interpolations of Corsica-Haute Provence, echo=FALSE, warning=FALSE, message=FALSE}

pCO2_atmos$CO2_CORSE[is.na(pCO2_atmos$CO2_CORSE)] <- "NA"
pCO2_atmos$CO2_HP[is.na(pCO2_atmos$CO2_HP)] <- "NA"

pCO2_atmos_2 <- pCO2_atmos %>% 
  mutate(CORSE_HP = case_when(CO2_CORSE == "NA" ~ CO2_HP, TRUE ~ CO2_CORSE)) %>% 
  mutate(CORSE_HP = as.numeric(CORSE_HP))

summary(pCO2_atmos_2)

#mettre NA au format 
atmospheric_co2_PLATEAU_ROSA$CO2_ppm[is.na(atmospheric_co2_PLATEAU_ROSA$CO2_ppm)] <- "NA"

join_Rosa_Lamp <- left_join(atmospheric_co2_PLATEAU_ROSA, atmospheric_co2_LAMPEDUSA, 
                  by = "datetime")

join_Rosa_Lamp <- join_Rosa_Lamp %>% 
  mutate(CO2_ppm.y2 = as.character(CO2_ppm.y)) %>% 
  mutate(CO2_ppm_join = case_when(CO2_ppm.x == "NA" ~ CO2_ppm.y2, TRUE ~ CO2_ppm.x)) %>% 
  mutate(CO2_ppm_join2 = as.double(CO2_ppm_join))


#au propre mix Plateau Rosa with Lampedusa:
join_Rosa_Lamp <- join_Rosa_Lamp %>%
  mutate(CO2_ppm = CO2_ppm_join2) %>% 
  select(datetime, CO2_ppm)

#summary(join_Rosa_Lamp$CO2_ppm) plus que 141 NA


```


```{r interpolation NA Rosa-Lamp par data MONTE CIMONE, echo=FALSE, warning=FALSE, message=FALSE}

#mettre NA au format 
join_Rosa_Lamp$CO2_ppm[is.na(join_Rosa_Lamp$CO2_ppm)] <- "NA"

#join Rosa-Lamp _ MONTE CIMONE
join_Rosa_Lamp_MC <- left_join(join_Rosa_Lamp, atmospheric_co2_MONTE_CIMONE, 
                  by = "datetime")

join_Rosa_Lamp_MC <- join_Rosa_Lamp_MC %>% 
  mutate(CO2_ppm.y2 = as.character(CO2_ppm.y)) %>% 
  mutate(CO2_ppm_join = case_when(CO2_ppm.x == "NA" ~ CO2_ppm.y2, TRUE ~ CO2_ppm.x)) %>% 
  mutate(CO2_ppm_join2 = as.double(CO2_ppm_join))

#summary(join_Rosa_Lamp_MC$CO2_ppm_join2)

#au propre mix Plateau Rosa / Lampedusa with Monte Cimone:
Data_air_CO2 <- join_Rosa_Lamp_MC %>%
  mutate(CO2_ppm = CO2_ppm_join2) %>% 
  select(datetime, CO2_ppm)


```


```{r NA distribution Data air CO2, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

##visualisation NA 
Data_air_CO2_NA_plot <- ggplot_na_distribution(Data_air_CO2$CO2_ppm)
Data_air_CO2_NA_plot
#statsNA(Data_air_CO2$CO2_ppm)
#ggplot_na_gapsize(Data_air_CO2$CO2_ppm, orientation="vertical")

#plot nb NA par années
Data_air_CO2_NA_plot_year <- Data_air_CO2 %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

Data_air_CO2_NA_plot_year$CO2_ppm[is.na(Data_air_CO2_NA_plot_year$CO2_ppm)] <- "NA"

Data_air_CO2_NA_plot_year %>% 
  dplyr::filter(CO2_ppm == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA occurences", limits = c(0,50), breaks = seq(0, 50, 5))

##

```


```{r linear interpolation Data air CO2, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

Data_air_CO2_interpol <- na_interpolation(Data_air_CO2$CO2_ppm, option = "linear")

ggplot_na_imputations(x_with_na = Data_air_CO2$CO2_ppm, x_with_imputations = Data_air_CO2_interpol)

#creation data frame Data pCO2 air (ppm) interpolee
Data_air_CO2_interpol <- data.frame(datetime = Data_air_CO2$datetime, pCO2_ppm = Data_air_CO2_interpol) # 0 NA



```

```{r conversion dry mol fraction pCO2 air}

Data_air_CO2_interpol <- Data_air_CO2_interpol %>% 
  mutate(pCO2_good = x2pCO2(S=35, T=25, Patm=1.0, xCO2=pCO2_ppm))

```




```{r data wind speed, echo=FALSE, warning=FALSE, message=FALSE}
##Data wind speed (10m)
#importation data wind speed (10m) Azur buoy (1999-2022)
#measured at 3.80 m height, then roughly extrapolated to 10 m by adding 10%
#unity : m/s (1999-2021)
#unity : knot (2022)
#2022 : que le mois de janvier
#observations toutes les heures

Azur_wind_1999 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_1999.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2000 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2000.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2001 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2001.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2002 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2002.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2003 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2003.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2004 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2004.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2005 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2005.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2006 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2006.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2007 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2007.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2008 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2008.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2009 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2009.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2010 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2010.dat", 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE)

Azur_wind_2011 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2011.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2011 <- Azur_wind_2011 %>% rename(date=X1, `wind speed`=X2)

Azur_wind_2012 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2012.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2012 <- Azur_wind_2012 %>% rename(date=X1, `wind speed`=X2)

Azur_wind_2013 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2013.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2013 <- Azur_wind_2013 %>% rename(date=X1, `wind speed`=X2)

Azur_wind_2014 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2014.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2014 <- Azur_wind_2014 %>% rename(date=X1, `wind speed`=X2)

Azur_wind_2015 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2015.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2015 <- Azur_wind_2015 %>% rename(date=X1, `wind speed`=X2)


Azur_wind_2016 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2016.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2016 <- Azur_wind_2016 %>%
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))

Azur_wind_2017 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2017.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2017 <- Azur_wind_2017 %>%
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))

Azur_wind_2018 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2018.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2018 <- Azur_wind_2018 %>% 
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))

Azur_wind_2019 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2019.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2019 <- Azur_wind_2019 %>% 
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))

Azur_wind_2020 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FF_2020.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2020 <- Azur_wind_2020 %>% 
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))


Azur_wind_2021 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FXI_2021.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2021 <- Azur_wind_2021 %>% 
  reframe(date=X1, `wind speed`= case_when(X2 == -9999 ~ NA_real_ , TRUE ~ X2))

#convert en m/s : 1 knot = 0.514444681 m/s

Azur_wind_2022 <- read_delim("../Data/Wind_speed_10m_Azur_buoy/Azur_FXI_2022.dat", 
                             delim = ";", escape_double = FALSE, col_names = FALSE, 
                             trim_ws = TRUE)
Azur_wind_2022 <- Azur_wind_2022 %>% reframe (datetime=X1, `wind speed_ms` = case_when(X2 == -9999  ~ NA_real_ , 
                                                                                TRUE ~ (X2*0.514444681)))

#sauvegarde Fred :
write.table(Azur_wind_2022, "Azur_wind_2022.txt", col.names=TRUE, 
            row.names=FALSE, sep=";")

summary(Azur_wind_2022)

#fusion (2007-2018) : Azur_wind_RAW = wind speed en m/s 2007-janvier 2022)

Azur_wind_RAW <- rbind(Azur_wind_2007, Azur_wind_2008, Azur_wind_2009, Azur_wind_2010,
                       Azur_wind_2011, Azur_wind_2012, Azur_wind_2013, Azur_wind_2014,
                       Azur_wind_2015, Azur_wind_2016, Azur_wind_2016, Azur_wind_2017,
                       Azur_wind_2018, Azur_wind_2019, Azur_wind_2020, Azur_wind_2021,
                       Azur_wind_2022)

Azur_wind_RAW <- Azur_wind_RAW %>% 
  mutate(datetime = format(date, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime)) %>% 
  rename(wind_speed_ms = `wind speed`) %>% 
  select(datetime, wind_speed_ms)


```

Wind speed (m/s) par heure \>\> calcul moyenne wind speed par jour

```{r moyenne wind speed par jour, echo=FALSE, warning=FALSE, message=FALSE}

#calcul mean + replace 9999 par NA
Azur_wind_daily <- Azur_wind_RAW %>% 
  group_by(datetime) %>% 
  mutate(wind_speed_ms = mean(wind_speed_ms)) %>% 
  mutate(wind_speed_ms = case_when(wind_speed_ms == -9999 ~ NA_real_ , TRUE ~ wind_speed_ms))

Azur_wind_daily <- distinct(Azur_wind_daily)

#plot visualiser les outliers
Azur_wind_daily %>% 
  ggplot() +
  aes(x=datetime, y=wind_speed_ms) +
  geom_boxplot() + 
  xlab(label = "") +
  ylab(label = "") +
  theme(legend.position="none")+
  ggtitle("wind_speed_ms boxplot (outliers)") 

outliers_wind <- boxplot.stats(Azur_wind_daily$wind_speed_ms)

#remplacer les outliers par des NA
Azur_wind_daily[Azur_wind_daily$wind_speed_ms %in% outliers_wind$out, "wind_speed_ms"] = NA

#summary(Azur_wind_daily) # 1012 NA


```


```{r distribution des NA wind speed, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

##visualisation NA 
Data_wind_NA_plot <- ggplot_na_distribution(Azur_wind_daily$wind_speed_ms)
Data_wind_NA_plot
#statsNA(Azur_wind_daily$wind_speed_ms) # bcp de NA : 20% du dataset
#ggplot_na_gapsize(Azur_wind_daily$wind_speed_ms, orientation="vertical")

#plot nb NA par années
Data_wind_NA_plot_year <- Azur_wind_daily %>% 
  dplyr::mutate(Year = format(datetime, format="%Y"),
                Month = format(datetime, format="%m-%d")) %>% 
  dplyr::group_by(Year, Month) 

Data_wind_NA_plot_year$wind_speed_ms[is.na(Data_wind_NA_plot_year$wind_speed_ms)] <- "NA"

Data_wind_NA_plot_year %>% 
  dplyr::filter(wind_speed_ms == "NA") %>% 
  dplyr::group_by(Year) %>% 
  dplyr::summarise(number_of_NA = n()) %>% 
  ggplot(aes(x = Year, y = number_of_NA))  +
  geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
               color = "grey", linewidth = 2) +
  geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
  coord_flip() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "NA occurences", limits = c(0,200), breaks = seq(0, 200, 20))

##
```

```{r linear interpolation Data wind speed, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

Data_wind_interpol <- na_interpolation(Azur_wind_daily$wind_speed_ms, option = "linear")

ggplot_na_imputations(x_with_na = Azur_wind_daily$wind_speed_ms, x_with_imputations = Data_wind_interpol)

#creation data frame Data pCO2 air (ppm) interpolee
Data_wind_interpol <- data.frame(datetime = Azur_wind_daily$datetime, wind_speed_ms = Data_wind_interpol) # 0 NA


```


```{r regroupement data : pCO2 water + pCO2 air + wind speed, echo=FALSE, warning=FALSE, message=FALSE}

#integration azur_wind_daily avec DATA

SOMLIT_carbo_chemistry_surf <- SOMLIT_carbo_chemistry_surf %>% 
  mutate(datetime = as.character(datetime))
Data_air_CO2_interpol <- Data_air_CO2_interpol %>% 
  mutate(datetime = as.character(datetime))
Data_wind_interpol <- Data_wind_interpol %>% 
  mutate(datetime = as.character(datetime))

DATA <- left_join(SOMLIT_carbo_chemistry_surf, Data_air_CO2_interpol, by = "datetime")
DATA <- left_join(DATA, Data_wind_interpol, by = "datetime")

DATA <- DATA %>% 
  mutate(datetime = as.POSIXct(datetime)) %>% 
  rename(pCO2_air_uatm = pCO2_good)

#summary(DATA$pCO2_water_uatm) #95
#summary(DATA$pCO2_air_ppm) # 0NA
#summary(DATA$temperature) # 47 NA


```


```{r interpolations variables du dataset, echo=FALSE, warning=FALSE, message=FALSE}

DATA$pCO2_water_uatm <- na_interpolation(DATA$pCO2_water_uatm, option = "linear")
DATA$wind_speed_ms <- na_interpolation(DATA$wind_speed_ms, option = "linear")
DATA$temperature <- na_interpolation(DATA$temperature, option = "linear")
DATA$salinity <- na_interpolation(DATA$salinity, option = "linear")
```



#### Plot pCO2 water (uatm) VS pCO2 atmosphere (ppm)

```{r plot pCO2 air (ppm) vs pCO2 water (uatm), echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_pCO2_water <- DATA %>% 
  ggplot() + 
  ggtitle("Water pCO2 (uatm) according to time") +
  aes(x=datetime, y=pCO2_water_uatm) + 
  geom_point(size=1, col='#357AB7')

plot_pCO2_air <- DATA %>% 
  ggplot() +
  ggtitle("Air pCO2 (uatm) according to time ") +
  aes(x=datetime, y=pCO2_air_uatm) +
  geom_point(size=1, col='#EED153')

plot_pCO2_water
plot_pCO2_air
```


#### Regroupement des 2 plots

```{r Plot pCO2 water VS pCO2 atmosphere (ppm), echo=FALSE, warning=FALSE, message=FALSE}

plot_pCO2_water_vs_air <- DATA %>% 
  ggplot() + 
  ggtitle("Water and atmosphere pCO2 according to time (2007-2022)") +
  geom_point(aes(x=datetime, y=pCO2_water_uatm), size=1, col='#357AB7') +
  geom_point(aes(x=datetime, y=pCO2_air_uatm), size=1, col='#EED153') + 
  scale_x_datetime(name="") + 
  scale_y_continuous(name="pCO2² (µatm)")

plot_pCO2_water_vs_air

```

#### Calcul de T-normalized (=NpCO2 seawater) Correspond aux non-temperature effects on pCO2 water variations

```{r NpCO2, echo=TRUE, warning=FALSE, message=FALSE}
#calcul de T-normalized pCO2 seawater ou pCO2(N) = non-temperature effects on pCO2water
#formula : pCO2(N) = pCO2w obs * e(0.0423*Tmean-Tobs) = NpCO2 de Kapsenber

#calcul de Tmean :
Tmean <- mean(DATA$temperature, na.rm=T) #18.70

T_norm_pCO2_sw <- DATA %>% 
  dplyr::mutate(T_norm_pCO2_sw = pCO2_water_uatm * exp(0.0423*(Tmean-temperature)))

#integration au dataset
DATA <- DATA %>% 
  dplyr::mutate(T_norm_pCO2_sw = pCO2_water_uatm * exp(0.0423*(Tmean-temperature)))

```

#### pCO2 at Point B : 2007-2021

(Figure 5.a DE CARLO)

*(rajouter legende plot)*

```{r Figure 5a DE CARLO, echo=TRUE, warning=FALSE, message=FALSE}
##Figure 5.a DE CARLO :

DATA %>% 
  ggplot() +
  ggtitle("pCO2 at Point B : 2007-2021") +
  geom_line(aes(x=datetime, y=pCO2_air_ppm), col='darkgreen') +
  geom_line(aes(x=datetime, y=pCO2_water_uatm), col='blue') +
  geom_line(aes(x=datetime, y=T_norm_pCO2_sw), col='red') +
  scale_x_datetime(name="") +
  scale_y_continuous(name="")
```

#### Annual cycle of pCO2 (2007-2021)

(Figure 5.b DE CARLO)

*Remarque :* augmentation globale des valeurs de pCO2(water) au fil des années

*(rajouter legende plot)*

```{r Figure 5.b DE CARLO, echo=FALSE, warning=FALSE, message=FALSE}
#annual cycle of pCO2 (2007-2021)

DATA %>% 
  ggplot() +
  geom_line(aes(x= as.Date(yday(datetime), "1970-01-01"), y=pCO2_water_uatm, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.75) +
  scale_colour_viridis_d() +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "pCO2 water (uatm)") 
```

#### Calcul de TpCO2 seawater Correspond aux temperature effects on pCO2 water variations

```{r TpCO2, echo=TRUE, warning=FALSE, message=FALSE}
#the effects of only temperature
#calcul de TpCO2 at Tobs
#formula : TpCO2 = pCO2mean * exp[0.0423(Tobs - Tmean)]

#calcul de pCO2mean :
pCO2mean <- mean(DATA$pCO2_water_uatm, na.rm=T) #408.80

#calcul de TpCO2 :
TpCO2 <- DATA %>% 
  dplyr::mutate(TpCO2 = pCO2mean * exp(0.0423*(temperature-Tmean)))

#integration au dataset
DATA <- DATA %>% 
  dplyr::mutate(TpCO2 = pCO2mean * exp(0.0423*(temperature-Tmean)))

##
```

#### Calcul des deltas

-   delta pCO2(T) : correspond aux temperature effects = pCO2 water - NpCO2

-   delta pCO2(bio) : correspond aux biological effects = pCO2 water - TpCO2

-   delta pCO2 = pCO2 water - pCO2 air 

```{r Calcul des deltas, echo=TRUE, warning=FALSE, message=FALSE}
###Calcul des deltas

#calcul delta pCO2(T) = pCO2obs - pCO2(N)
delta_pCO2_T <- DATA$pCO2_water_uatm - DATA$T_norm_pCO2_sw

#Calcul pCO2(bio) = pCO2obs - pCO2(T-driven) ou TpCO2
delta_pCO2_bio <- DATA$pCO2_water_uatm - DATA$TpCO2

#integration au dataset
DATA <- DATA %>% 
  dplyr::mutate(delta_pCO2_T = pCO2_water_uatm - T_norm_pCO2_sw,
                delta_pCO2_bio = pCO2_water_uatm - TpCO2)

##
```

#### Temperature and biological effects on pCO2 variations

**Plot delta pCO2(T) et delta pCO2(bio)**

(Figure 6 DE CARLO)

*(rajouter légende plot)*

```{r Figure 6 DE CARLO, echo=FALSE, warning=FALSE, message=FALSE}
#plot
##Figure 6 DE CARLO :

DATA %>% 
  ggplot() + 
  ggtitle("Temperature and biological effects on pCO2 variations") +
  geom_point(aes(x=datetime, y=delta_pCO2_T), col='darkgreen', size=0.9) +
  geom_point(aes(x=datetime, y=delta_pCO2_bio), col='#EED153', size=0.9) + 
  scale_x_datetime(name="") + 
  scale_y_continuous(name="deltas pCO2")
##

```

```{r calcul flux wanninkhof 2014, echo=FALSE, warning=FALSE, message=FALSE}

#Formula : F = 7.7 * U^2 * delta_pCO2
#unit : mol/m2/y, ici mol/m2/y 

#delta_pCO2 :
delta_pCO2 <- DATA$pCO2_water_uatm - DATA$pCO2_air_uatm
DATA <- DATA %>% mutate(delta_pCO2 = pCO2_water_uatm - pCO2_air_uatm)

#F en mol/m2/day
Flux_wan_2014 <- 0.00077 * DATA$wind_speed_ms^2 * DATA$delta_pCO2

#integration au dataset
DATA <- DATA %>% mutate(Flux_wan_2014 = 0.00077 * wind_speed_ms^2 * delta_pCO2)
 summary(Flux_wan_2014)
 

```


```{r outliers flux wanninkhof 2014, echo=FALSE, warning=FALSE, message=FALSE}
#plot visualiser les outliers
DATA %>% 
  ggplot() +
  aes(x=datetime, y=Flux_wan_2014) +
  geom_boxplot() + 
  xlab(label = "") +
  ylab(label = "") +
  theme(legend.position="none")+
  ggtitle("Flux_CO2 boxplot (outliers)") 

#recuperation des outliers (47 outliers)

outliers_2014 <- boxplot.stats(DATA$Flux_wan_2014)


#remplacer les outliers Flux_wan_2014 par des NA 

#DATA[DATA$Flux_wan_2014 %in% outliers_2014$out, "Flux_wan_2014"] = NA


```

```{r plot flux}
#plot flux wanninkhof 2014 en mmol/m2/d
DATA %>% 
  ggplot() +
  aes(x=datetime, y=Flux_wan_2014) +
  geom_line(linewidth=0.7) + 
  scale_x_datetime(name="") +
  scale_y_continuous(name="Flux (mmol/m²/year)") +
  ggtitle("CO2 fluxes ocean-atmosphere (Wanninkhof 2014)")
```

#periode + frequence de chaque data set dans un tableau


#comparaison des 3 lieux de pco2 water sur un mm plot 

#tendance sur delta pCO2 ? 

#changer les echelles des graphiques 

#plot de toutes les donnees atmospheriques de tous les lieux, voir a quoi ca ressemble, si les courbes sont identiques

#faire par periode de 10ans pour 1992-2022, voir l'évolution de la tendance

#partie autocorrelation, voir avec SAMIR ?
script FRED ?


```{r essai}

SC <- gas_schmidt(t=SOMLIT_carbo_chemistry_surf$temperature, species="CO2")

k <- 0.251*DATA$wind_speed_ms^2*(SC/660)^-0.5 #en cm/heure

#K0 <- K0(S=SOMLIT_carbo_chemistry_surf$salinity, T=SOMLIT_carbo_chemistry_surf$temperature, P=0, Patm=1, warn="y")

K0 <- exp(-58.0931+90.5069*(100/(SOMLIT_carbo_chemistry_surf$temperature+273.16))
          +22.294*log((SOMLIT_carbo_chemistry_surf$temperature+273.16)/100) +
          SOMLIT_carbo_chemistry_surf$salinity*(0.027766-0.025888*
          ((SOMLIT_carbo_chemistry_surf$temperature+273.16)/100)+0.0051313*
            ((SOMLIT_carbo_chemistry_surf$temperature+273.16)/100)^2))

K0 <- K0/1000000

F <- k*K0*delta_pCO2



DATA <- DATA %>% mutate(F = k*K0*delta_pCO2)

```

```{r new}

DATA %>% 
  ggplot() +
  aes(x=datetime, y=F) +
  geom_line(linewidth=0.6) + 
  scale_x_datetime(name="") +
  scale_y_continuous(name="Flux (mol C/m²/h)") +
  ggtitle("CO2 fluxes ocean-atmosphere (Wanninkhof 2014)")

```

