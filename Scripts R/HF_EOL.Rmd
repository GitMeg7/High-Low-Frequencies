---
title: "HF EOL"
author: "Mégane"
date: "2023-03-28"
output: html_document
---

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}

library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
library("spectral")
library("signal")

```

```{r theme for plots, echo=FALSE, warning=FALSE, message=FALSE}

#theme for plots :
Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
    theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
          axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
          axis.text.y = element_text(face=face_font, color="black", size=size_labs),
          axis.title.y = element_text(face=face_font, size=size_labs),
          axis.ticks.x = element_line(size=0.1),
          axis.ticks.y = element_line(size=0.1),
          axis.ticks.length = unit(1.1, "mm"),
          panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
          aspect.ratio = 1 / 3,
          plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
    )
}
```


```{r importation Data EOL raw, echo=FALSE, warning=FALSE, message=FALSE}

#period : septembre 2013-octobre 2022
EOL_RAW <- read_delim("../Data/EOL_raw_complete_1323.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)  


#tri
EOL_RAW <- EOL_RAW %>% 
  rename(temperature = temp_eol_c, salinity = sal_eol_psu, oxygen = oxy_umol_kg) %>% 
  mutate(Year.Month = format(datetime, format="%Y-%m"),
         Year = format(datetime, format="%Y"),
         Year.Month.Day = format(datetime, format="%Y-%m-%d"),
         Month = format(datetime, format="%m"),
         oxygen = case_when(oxygen > 10 ~ NA_real_, TRUE ~ oxygen))

summary(EOL_RAW) 

```


```{r visualisation data temperature & salinity - EOL raw, echo=FALSE, message=FALSE, warning=FALSE}

EOL_RAW %>% 
  ggplot() +
  geom_point(aes(x=datetime, y=temperature), size=0.6, col="#960018") + 
  geom_point(aes(x=datetime, y=salinity), size=0.6, col="#18391E") +
  geom_point(aes(x=datetime, y=oxygen), size=0.6, col="#357AB7") +
  scale_x_datetime(name="") + 
  scale_y_continuous(name="Temp. (°C)") + 
  ggtitle("High frequency surface data (2013-2022) - EOL buoy")


```
```{r importation data SOMLIT clean, echo=FALSE, message=FALSE, warning=FALSE}

#period : jan. 2007 - dec. 2022
SOMLIT <- read_delim("../Data/DATA_SOMLIT_07-22_CLEAN.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection data surface 1m 
SOMLIT <- SOMLIT %>% 
  dplyr::filter(depth == 0) %>% 
  rename(datetime=sampling_date, temp_SOM = temperature, sal_SOM = salinity) %>% 
  select(datetime, temp_SOM, sal_SOM) %>% 
  mutate(datetime = as.character(datetime))


#merge

merge_EOL_SOMLIT <- full_join(EOL_RAW, SOMLIT, by=c("Year.Month.Day" = "datetime"))


```



```{r visualisation data temperature EOL vs SOMLIT, echo=FALSE, message=FALSE, warning=FALSE}

#creation column for legend
merge_EOL_SOMLIT_long <- merge_EOL_SOMLIT %>% 
  rename(`EOL temp.` = temperature, `SOMLIT temp.` = temp_SOM) %>% 
  pivot_longer(cols=c(`EOL temp.`,`SOMLIT temp.`), names_to = "Legend", values_to = "value")

#plot
merge_EOL_SOMLIT_long %>% 
  ggplot() +
  ggtitle("HF (EOL) vs LF (Point B) surface temperature (2013-2022)") +
  geom_line(aes(x=datetime, y=value, color= Legend), size=1) +
  scale_y_continuous(name="Temp.(°C)") + 
  scale_x_datetime(name="") + 
  scale_colour_discrete(type=c("#AE642D","#24445C"))


# relier les points pour somlit
#changer les couleurs
```

Scatter plot (T°) :  
Slope : 1.003  
Intercept : 0.040  
  
```{r scatter plot EOL/SOMLIT - temperature, echo=FALSE, warning=FALSE, message=FALSE}


merge_EOL_SOMLIT %>% 
  ggplot() + 
  ggtitle("Scatter plot EOL vs Point B (temperature)") +
  aes(x=temp_SOM, y=temperature) + 
  geom_point(size=0.8) + 
  geom_smooth(method=lm) + 
  scale_x_continuous(name="Temperature Point B (°C)") + 
  scale_y_continuous(name="Temperature EOL (°C)")

reg_EOL_SOM_T <- lm(data = merge_EOL_SOMLIT, temperature ~ temp_SOM)
slope_EOL_SOM_T <- reg_EOL_SOM_T$coefficients[[2]]
intercept_EOL_SOM_T <- reg_EOL_SOM_T$coefficients[[1]]

```

 
  
```{r scatter plot EOL/SOMLIT - salinity, echo=FALSE, warning=FALSE, message=FALSE}


# merge_EOL_SOMLIT %>% 
#   ggplot() + 
#   ggtitle("Scatter plot EOL vs Point B (salinity)") +
#   aes(x=sal_SOM, y=salinity) + 
#   geom_point(size=0.8) + 
#   geom_smooth(method=lm) + 
#   scale_x_continuous(name="Salinity Point B") + 
#   scale_y_continuous(name="Salinity EOL")
# 
# reg_EOL_SOM_S <- lm(data = merge_EOL_SOMLIT, salinity ~ sal_SOM)
# slope_EOL_SOM_S <- reg_EOL_SOM_S$coefficients[[2]]
# intercept_EOL_SOM_S <- reg_EOL_SOM_S$coefficients[[1]]

```





## Data EOL surface : temperature (°C) & salinity  
  


#### Part 1 : Trend analysis by residuals : raw dataset

###### [Table and plot of monthly means (2013-2022) - EOL temperature & salinity]{style="color:blue"}

```{r calcul monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means <- ungroup(EOL_RAW) %>% 
  mutate(Month = format(datetime, format="%m")) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means

```


```{r plot monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

EOL_monthly_means <- left_join(ungroup(EOL_RAW), monthly_means, by = "Month")

#plot
EOL_monthly_means %>% 
  ggplot() + 
  ggtitle("Temperature observations (blue) and monthly means calculated (brown)") +
  geom_point(aes(x=datetime, y=temperature), size=1, col="#357AB7") +
  geom_line(aes(x=datetime, y=Temperature_month), size=0.8, col="#856D4D") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)")
```

###### [Table of time series anomalies regression analyses (2013-2022) - EOL temperature & salinity]{style="color:green"}  
  
```{r regression analysis - temperature & salinity, echo=FALSE, warning=FALSE, message=FALSE}

anomalies <- left_join(ungroup(EOL_RAW), monthly_means, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies))
})

reg_raw <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_raw <-
    rbind(reg_raw, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_raw) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_raw) <- var_list
reg_ano_surf <- reg_raw
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies))
})
reg_raw <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_raw <-
    rbind(reg_raw, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_raw) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg_raw) <- var_list
reg_anomalies_raw <- reg_raw

reg_anomalies_raw
```
  
**Plot of anomalies : Temperature (°C) (2013-2022) - EOL**  
  
```{r plot anomalies + trends - temperature, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_raw <- ggplot(data = anomalies, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Temperature anomalies + trend")

plot_temp_EOL_raw <- EOL_RAW %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_line(size=0.7, col = "#030303",) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL temperature time series (°C) 2013-2022")

plot_temp_EOL_raw
plot_ano_temp_EOL_raw
```
  
**Plot of anomalies : Salinity (2013-2022) - EOL**  
  
```{r plot anomalies + trends - salinity, echo=FALSE, warning=FALSE, message=FALSE}

plot_ano_sal_EOL_raw <- ggplot(data = anomalies, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Salinity anomalies + trend")

plot_sal_EOL_raw <- EOL_RAW %>% 
  mutate(salinity = case_when(salinity <=35 ~ NA_real_, TRUE ~ salinity)) %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_line(size=0.7, col = "#1B4F08") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL salinity time series (2013-2022)")

plot_sal_EOL_raw
plot_ano_sal_EOL_raw


```
```{r Travail sur oxygen, echo=FALSE, warning=FALSE, message=FALSE}


#conversion des valeurs ml/l en umol/kg (voire protocole oxygene SOMLIT)
# *44.66 -> mmol/m3 ou umol/l
# densite eau de mer = 1030 kg/m3 = 1.030 kg/l
#ici, utilisation de rho, package seacarb pour calcul de la densité
#rho/1000 pour avoir en kg/l
# 44.66/rho = convert_o2
# ml/l * convert_o2 -> umol/kg

#creation des 2 variables
test_oxy <- EOL_RAW %>% 
  mutate(SW_density = rho(S = salinity, T=temperature, P=0)/1000,
         Conver_o2 = 44.66/SW_density,
         O2_umol_kg = oxygen*Conver_o2)

## 

#plot :

test_oxy %>% 
  ggplot() +
  aes(x=datetime, y=O2_umol_kg) + 
  geom_line(size=0.7, col = "#77B5FE") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (mol/kg)") +
  ggtitle("EOL oxygen time series (2017-2022)")


```




#### Part 2 : Trend analysis by residuals : daily dataset (morning 8AM-10AM) 2017-2022  
  

```{r importation Data EOL 1 - daily, echo=FALSE, warning=FALSE, message=FALSE}

EOL_daily <- read_delim("../Data/EOL_17-22_1perday_morning.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(temperature=temp_eol_c, salinity=sal_eol_psu) %>% 
  mutate(datetime = as.POSIXct(datetime))


#interpolation of 3 NAs - salinity variable :
sal_daily_imputation <- na_interpolation(EOL_daily$salinity, option="linear")

#plot :
ggplot_na_imputations(EOL_daily$salinity, sal_daily_imputation, x_axis_labels = EOL_daily$datetime, 
                      title = "NAs interpolation (linear) for salinity2017-2022")

```

  
###### [EOL 1 : Table and plot of monthly means (2017-2022) - EOL temperature & salinity]{style="color:blue"}

```{r EOL 1 - calcul monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_EOL1 <- ungroup(EOL_daily) %>% 
  mutate(Month = format(datetime, format="%m")) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_EOL1

```


```{r EOL 1 - plot monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

EOL_1_monthly_means <- left_join(ungroup(EOL_daily), monthly_means_EOL1, by = "Month")

#plot
EOL_1_monthly_means %>% 
  ggplot() + 
  ggtitle("Temperature daily measured (blue) and monthly means calculated (brown) 2017-2022") +
  geom_point(aes(x=datetime, y=temperature), size=1, col="#357AB7") +
  geom_line(aes(x=datetime, y=Temperature_month), size=0.8, col="#856D4D") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)")
```

###### [EOL 1 : Table of time series anomalies regression analyses (2017-2022) - EOL temperature & salinity]{style="color:green"}  
  
```{r EOL 1 - regression analysis - temperature & salinity, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_EOL_1 <- left_join(ungroup(EOL_daily), monthly_means_EOL1, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_EOL_1)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_1))
})

reg_EOL_1 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_1 <-
    rbind(reg_EOL_1, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_EOL_1) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_EOL_1) <- var_list
reg_ano_surf <- reg_EOL_1
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_1))
})
reg_EOL_1 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_1 <-
    rbind(reg_EOL_1, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_EOL_1) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg_EOL_1) <- var_list
reg_anomalies_EOL_1 <- reg_EOL_1

reg_anomalies_EOL_1
```
  
**EOL 1 : Plot of anomalies : Temperature (°C) (2017-2022) - EOL**  
  
```{r EOL 1 - plot anomalies + trends - temperature, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_1 <- ggplot(data = anomalies_EOL_1, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_1$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Temperature anomalies + trend")

plot_temp_EOL_1 <- EOL_daily %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL time series observations of temperature (°C) 2017-2022")

plot_temp_EOL_1
plot_ano_temp_EOL_1
```
  
**EOL 1 : Plot of anomalies : Salinity (2017-2022) - EOL**  
  
```{r EOL 1 - plot anomalies + trends - salinity, echo=FALSE, warning=FALSE, message=FALSE}

plot_ano_sal_EOL_1 <- ggplot(data = anomalies_EOL_1, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_1$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Salinity anomalies + trend")

plot_sal_EOL_1 <- EOL_daily %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL time series observations of salinity  2017-2022")

plot_sal_EOL_1
plot_ano_sal_EOL_1

```


#### Part 3 : Trend analysis by residuals : daily dataset (morning + afternoon) 2017-2022  
  

```{r importation Data EOL 2 - daily, echo=FALSE, warning=FALSE, message=FALSE}

EOL_daily_2 <- read_delim("../Data/EOL_17-22_2perday_morning_afternoon.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(temperature=temp_eol_c, salinity=sal_eol_psu) %>% 
  mutate(datetime = as.POSIXct(datetime))


```

  
###### [EOL 2 : Table and plot of monthly means (2017-2022) - EOL temperature & salinity]{style="color:blue"}

```{r EOL 2 - calcul monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_EOL2 <- ungroup(EOL_daily_2) %>% 
  mutate(Month = format(datetime, format="%m")) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_EOL2

```


```{r EOL 2 - plot monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

EOL_2_monthly_means <- left_join(ungroup(EOL_daily_2), monthly_means_EOL2, by = "Month")

#plot
EOL_2_monthly_means %>% 
  ggplot() + 
  ggtitle("Temperature daily measured (blue) and monthly means calculated (brown) 2017-2022") +
  geom_point(aes(x=datetime, y=temperature), size=1, col="#357AB7") +
  geom_line(aes(x=datetime, y=Temperature_month), size=0.8, col="#856D4D") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)")
```

###### [EOL 2 : Table of time series anomalies regression analyses (2017-2022) - EOL temperature & salinity]{style="color:green"}  
  
```{r EOL 2 - regression analysis - temperature & salinity, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_EOL_2 <- left_join(ungroup(EOL_daily_2), monthly_means_EOL2, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_EOL_2)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_2))
})

reg_EOL_2 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_2 <-
    rbind(reg_EOL_2, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_EOL_2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_EOL_2) <- var_list
reg_ano_surf <- reg_EOL_2
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_2))
})
reg_EOL_2 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_2 <-
    rbind(reg_EOL_2, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_EOL_2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg_EOL_2) <- var_list
reg_anomalies_EOL_2 <- reg_EOL_2

reg_anomalies_EOL_2
```
  
**EOL 2 : Plot of anomalies : Temperature (°C) (2017-2022) - EOL**  
  
```{r EOL 2 - plot anomalies + trends - temperature, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_2 <- ggplot(data = anomalies_EOL_2, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_2$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Temperature anomalies + trend")

plot_temp_EOL_2 <- EOL_daily_2 %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL time series observations of temperature (°C) 2017-2022")

plot_temp_EOL_2
plot_ano_temp_EOL_2
```
  
**EOL 2 : Plot of anomalies : Salinity (2017-2022) - EOL**  
  
```{r EOL 2 - plot anomalies + trends - salinity, echo=FALSE, warning=FALSE, message=FALSE}

plot_ano_sal_EOL_2 <- ggplot(data = anomalies_EOL_2, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_2$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Salinity anomalies + trend")

plot_sal_EOL_2 <- EOL_daily_2 %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL time series observations of salinity  2017-2022")

plot_sal_EOL_2
plot_ano_sal_EOL_2

```

#### Part 4 : Trend analysis by residuals : hourly dataset 2017-2022  
  

```{r importation Data EOL 3 - hourly, echo=FALSE, warning=FALSE, message=FALSE}

EOL_daily_3 <- read_delim("../Data/EOL_17-22_23perday_hourly.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(temperature=temp_eol_c, salinity=sal_eol_psu) %>% 
  mutate(datetime = as.POSIXct(datetime))


```

  
###### [EOL 3 : Table and plot of monthly means (2017-2022) - EOL temperature & salinity]{style="color:blue"}

```{r EOL 3 - calcul monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_EOL3 <- ungroup(EOL_daily_3) %>% 
  mutate(Month = format(datetime, format="%m")) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_EOL3

```


```{r EOL 3 - plot monthly means - temperature & salinity, echo=TRUE, warning=FALSE, message=FALSE}

EOL_3_monthly_means <- left_join(ungroup(EOL_daily_3), monthly_means_EOL3, by = "Month")

#plot
EOL_3_monthly_means %>% 
  ggplot() + 
  ggtitle("Temperature hourly measured (blue) and monthly means calculated (brown) 2017-2022") +
  geom_point(aes(x=datetime, y=temperature), size=0.8, col="#357AB7") +
  geom_line(aes(x=datetime, y=Temperature_month), size=0.8, col="#856D4D") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)")
```

###### [EOL 3 : Table of time series anomalies regression analyses (2017-2022) - EOL temperature & salinity]{style="color:green"}  
  
```{r EOL 3 - regression analysis - temperature & salinity, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_EOL_3 <- left_join(ungroup(EOL_daily_3), monthly_means_EOL3, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_EOL_3)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_3))
})

reg_EOL_3 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_3 <-
    rbind(reg_EOL_3, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_EOL_3) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_EOL_3) <- var_list
reg_ano_surf <- reg_EOL_3
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_3))
})
reg_EOL_3 <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_EOL_3 <-
    rbind(reg_EOL_3, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_EOL_3) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg_EOL_3) <- var_list
reg_anomalies_EOL_3 <- reg_EOL_3

reg_anomalies_EOL_3
```
  
**EOL 3 : Plot of anomalies : Temperature (°C) (2017-2022) - EOL**  
  
```{r EOL 3 - plot anomalies + trends - temperature, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_3 <- ggplot(data = anomalies_EOL_3, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_3$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Temperature anomalies + trend")

plot_temp_EOL_3 <- EOL_daily_3 %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL time series observations of temperature (°C) 2017-2022")

plot_temp_EOL_3
plot_ano_temp_EOL_3
```
  
**EOL 3 : Plot of anomalies : Salinity (2017-2022) - EOL**  
  
```{r EOL 3 - plot anomalies + trends - salinity, echo=FALSE, warning=FALSE, message=FALSE}

plot_ano_sal_EOL_3 <- ggplot(data = anomalies_EOL_3, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_3$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("EOL - Salinity anomalies + trend")

plot_sal_EOL_3 <- EOL_daily_3 %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL time series observations of salinity  2017-2022")

plot_sal_EOL_3
plot_ano_sal_EOL_3

```

### Summary table of regression analyses on residuals :  
  

```{r}

table_test <- data.frame(reg_raw, reg_EOL_1, reg_EOL_2, reg_EOL_3)

summary_table <- data.frame(table_test$Slope, table_test$P.Slope, table_test$Slope.1, table_test$P.Slope.1, 
                   table_test$Slope.2, table_test$P.Slope.2, table_test$Slope.3,table_test$P.Slope.3)

colnames(summary_table) <- c("EOL_raw_slope", "EOL_raw_pvalue", "EOL_daily_slope", "EOL_daily_pvalue",
                             "EOL_daily_2_slope", "EOL_daily_2_pvalue", "EOL_hourly_slope", "EOL_hourly_pvalue")
rownames(summary_table) <- c("Salinity_anomalies", "Temperature_anomalies")

summary_table
```
  
  
## Comparison between EOL and Azur buoy - SST data 2013-2022  
  

```{r importation data SST AZUR BUOY, echo=FALSE, warning=FALSE, message=FALSE}

#data SST Azur buoy (2011-2022)
#observation toutes les 30min : 6 obs toutes les 10s
#temperature in °C

#annee 2011
Azur_SST_2011 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2011.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2011 <- Azur_SST_2011 %>% rename(datetime=X1, SST=X2)
##
#annee 2012
Azur_SST_2012 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2012.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2012 <- Azur_SST_2012 %>% rename(datetime=X1, SST=X2)
##
#annee 2013
Azur_SST_2013 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2013.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2013 <- Azur_SST_2013 %>% rename(datetime=X1, SST=X2)
##
#annee 2014
Azur_SST_2014 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2014.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2014 <- Azur_SST_2014 %>% rename(datetime=X1, SST=X2)
##
#annee 2015
Azur_SST_2015 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2015.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2015 <- Azur_SST_2015 %>% rename(datetime=X1, SST=X2)
##
#annee 2016
Azur_SST_2016 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2016.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2016 <- Azur_SST_2016 %>% rename(datetime=X1, SST=X2)
##
#annee 2017
Azur_SST_2017 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2017.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2017 <- Azur_SST_2017 %>% rename(datetime=X1, SST=X2)
##
#annee 2018
Azur_SST_2018 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2018.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2018 <- Azur_SST_2018 %>% rename(datetime=X1, SST=X2)
##
#annee 2019
Azur_SST_2019 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2019.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2019 <- Azur_SST_2019 %>% rename(datetime=X1, SST=X2)
##
#annee 2020
Azur_SST_2020 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2020.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2020 <- Azur_SST_2020 %>% rename(datetime=X1, SST=X2)
##
#annee 2021
Azur_SST_2021 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2021.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2021 <- Azur_SST_2021 %>% rename(datetime=X1, SST=X2)
##
#annee 2022
Azur_SST_2022 <- read_delim("../Data/SST_Azur_buoy/ODAS_CA_SST/Azur_SST_2022.dat", 
                            delim = ";", escape_double = FALSE, col_names = FALSE, 
                            trim_ws = TRUE)

Azur_SST_2022 <- Azur_SST_2022 %>% rename(datetime=X1, SST=X2)


#fusion des tables : AZUR_SST_RAW
#periode 2013-01-01 a 2022-08-12

AZUR_SST_RAW <- rbind(Azur_SST_2013, Azur_SST_2014,
                  Azur_SST_2015, Azur_SST_2016, Azur_SST_2017, Azur_SST_2018,
                  Azur_SST_2019, Azur_SST_2020, Azur_SST_2021, Azur_SST_2022)

AZUR_SST_RAW <- AZUR_SST_RAW %>% 
  mutate(SST = case_when(SST < 0 ~ NA_real_ , TRUE ~ SST)) %>% 
  mutate(Hour = format(datetime, format="%Y-%m-%d %H:00:00")) %>% 
  group_by(Hour) %>% 
  mutate(mean_SST = mean(SST))


AZUR_SST_RAW <- AZUR_SST_RAW %>%
  select(Hour, mean_SST) %>% 
  rename(datetime = Hour, temp_pelag = mean_SST) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d %H:%M:%S"))

AZUR_SST_RAW <- distinct(AZUR_SST_RAW)

  
##

#fusion temp EOL / temp Azur

pelagic_coast <- left_join(ungroup(EOL_RAW), AZUR_SST_RAW, by = "datetime")

pelagic_coast <- pelagic_coast %>% 
  mutate(temp_pelag = case_when(temp_pelag < 13 ~ NA_real_ , TRUE ~ temp_pelag)) %>% 
  mutate(temp_pelag = case_when(temp_pelag > 35 ~ NA_real_ , TRUE ~ temp_pelag))



```


```{r plot pelagic and costal temperatures, echo=FALSE, warning=FALSE, message=FALSE}


pelagic_coast_plot_long <- pelagic_coast %>% 
  rename(`Coast temp. (EOL)` = temperature, `Pelagic temp. (Azur)` = temp_pelag) %>% 
  pivot_longer(cols = c(`Coast temp. (EOL)`, `Pelagic temp. (Azur)`), 
               names_to = "Legend", values_to = "value")

#plot
pelagic_coast_plot <- pelagic_coast_plot_long %>% 
  ggplot() +
  ggtitle("Coastal & offshore SST observations (2013-2022)") +
  geom_line(aes(x=datetime, y=value, color= Legend), size=0.5) +
  scale_y_continuous(name="Temp. (°C)") + 
  scale_x_datetime(name="") + 
  scale_colour_discrete(type=c("#9683EC", "#067790"))

pelagic_coast_plot



```
  
  
## Scatterplot costal (EOL) vs pelagic (Azur) SST :  

*Slope : 0.9993014*  
*Intercept : 0.7620216*  
  
```{r  scatterplot pelagic vs costal temperatures, echo=FALSE, warning=FALSE, message=FALSE}

pelagic_coast_scatter_plot <- pelagic_coast %>% 
  ggplot() +
  aes(x=temp_pelag, y=temperature) +
  geom_point(size = 0.7) +
  stat_smooth(method="lm", formula = y ~ x) +
  scale_x_continuous(name="Pelagic Temp. (Azur)") +
  scale_y_continuous(name="Coastal Temp. (EOL)")

#regression
reg_pelagic_coast <- lm(data = pelagic_coast, temperature ~ temp_pelag)
slope_pelagic_coast <- reg_pelagic_coast$coefficients[[2]]
intercept_pelagic_coast <- reg_pelagic_coast$coefficients[[1]]

ggsave(filename = "pelagic_coast_scatter_plot.jpg", # Nommez le fichier dans lequel vous voulez enregistrer, ajoutez l'extension du format de fichier que vous voulez utiliser (ex. pdf).
       plot = pelagic_coast_scatter_plot, # Fournir le nom de l'objet plot dans R
       height = 6, # Fournir les dimensions voulues
       width = 10, 
       units = "in") 


summary(reg_pelagic_coast)
```
  
  
## Wind speed data (m/s)  
  
→ Comparison between wind EOL modelisation and wind data of St-Jean-Cap-Ferrat station :  
  
*model EOL : Jan.2009 - Dec.2022*  
*data Cap-Ferrat : Dec.2020 - Jan.2022*  
  
Frequency : hourly  
Unity : m/s  
  

```{r wind speed data EOL, echo=FALSE, warning=FALSE, message=FALSE}

#importation data wind speed (model) of EOL buoy (fin 2011-2022) :
Wind_EOL <- read_csv("../Data/model_wind_speed_EOL.csv") %>% arrange(date)

#delete december 2008 :
Wind_EOL <- Wind_EOL %>% 
  dplyr::filter(date >= "2009-01-01 01:00:00")

#summary(Wind_EOL)

#############
#importation data wind speed Cap-Ferrat

#Wind_CapF <- ld$h 
#save Wind_CapF :
#write.table(Wind_CapF, "DATA_CAP_FERRAT_12-20_01-22.csv", sep=";", col.names = TRUE, row.names = FALSE)

Wind_CapF <- read_delim("../Data/DATA_CAP_FERRAT_12-20_01-22.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


```
  
##### **Histogram of wind speed distribution : model vs Cap-Ferrat**  
  

```{r Histogram of wind speed distribution, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, fig.align='center', fig.show='hold'}

#plot EOL
 Wind_EOL %>% 
   ggplot(aes(x=speed_ms)) +
   geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
   ggtitle("Wind speed distribution (EOL buoy)") + 
   scale_y_continuous(name="Distribution") +
   scale_x_continuous(name="", breaks = c(0, 5, 10, 15, 20))


#plot Cap-Ferrat
 Wind_CapF %>% 
   ggplot(aes(x=speed_ms)) +
   geom_histogram(fill="#ED7F10", color="#e9ecef", alpha=0.8) +
   ggtitle("Wind speed distribution (Cap-Ferrat)") + 
   scale_y_continuous(name="Distribution") +
   scale_x_continuous(name="", breaks = c(0, 5, 10, 15, 20))
##

```
  
  
```{r model + Cap-Ferrat lines, echo=FALSE, warning=FALSE, message=FALSE}

winds <- left_join(Wind_EOL, Wind_CapF, by = c("date" = "datetime"))

winds_for_plot <- winds[c(103501:113310),]

EOL_Cap_plot_long <- winds_for_plot %>% 
  rename(EOL = speed_ms.x, `Cap-Ferrat` = speed_ms.y) %>% 
  pivot_longer(cols = c("EOL", `Cap-Ferrat`), names_to = "Legend", values_to = "value")

#plot
EOL_Cap_plot <- EOL_Cap_plot_long %>% 
  ggplot() +
  ggtitle("EOL and Cap-Ferrat winds (m/s) : Dec.2020 - Jan.2022") +
  geom_line(aes(x=date, y=value, color= Legend), size=0.7) +
  scale_y_continuous(name="Wind speed (m/s)") + 
  scale_x_datetime(name="") + 
  scale_colour_discrete(type=c("#69b3a2", "#CC5500"))

EOL_Cap_plot

```
  
  
##### Scatterplot EOL vs Cap-Ferrat (wind speed m/s 10m) :  
  
*Slope : 0.87 ± 0.01*  
*Intercept : 1.41 ± 0.037*  
  

```{r  scatterplot EOL vs Cap-Ferrat - wind, echo=FALSE, warning=FALSE, message=FALSE}

#scatter plot : 
EOL_Cap_scatter_plot <- winds %>% 
  ggplot() +
  aes(x=speed_ms.y, y=speed_ms.x) +
  geom_point(size = 0.7) +
  stat_smooth(method="lm", formula = y ~ x) +
  scale_x_continuous(name="Cap-Ferrat winds (m/s)") +
  scale_y_continuous(name="EOL winds (m/s)") + 
  annotate(geom="text", x=10, y=20, label="slope : 0.87 ± 0.01 *", color="black")

#regression values :
# reg_EOL_Cap <- lm(data = winds, speed_ms.x ~ speed_ms.y)
# slope_EOL_Cap <- reg_EOL_Cap$coefficients[[2]]
# intercept_EOL_Cap <- reg_EOL_Cap$coefficients[[1]]

#summary(reg_EOL_Cap)

EOL_Cap_scatter_plot

```




## Heatwaves :  
  

```{r Heatwaves Robert, echo=FALSE, warning=FALSE, message=FALSE}

#a revoir


#creation
Exc_temp <- EOL_RAW %>% 
  mutate(t = as.Date(datetime)) %>% 
  rename(temp = temperature)

Exc_25 <- exceedance(Exc_temp, threshold = 25, maxPadLength = 6)

DF_exceedance_25 <- Exc_25$exceedance

####

#visualising exceedances
exc_25_thresh <- Exc_25$threshold

ggplot(data = exc_25_thresh, aes(x = t)) +
  geom_flame(aes(y = temp, y2 = thresh, fill = "all"), show.legend = F) +
  geom_line(aes(y = temp, colour = "temp")) +
  geom_line(aes(y = thresh, colour = "thresh"), linewidth = 1.0) +
  scale_colour_manual(name = "Line Colour",
                      values = c("temp" = "black", "thresh" =  "forestgreen")) +
  scale_fill_manual(name = "Event Colour", values = c("all" = "salmon")) +
  guides(colour = guide_legend(override.aes = list(fill = NA))) +
  scale_x_date(date_labels = "%Y", breaks="1 year") +
  labs(y = "Temp. (°C)", x = NULL, title="Consecutive days > 25°C (2013-2022)")

####


#visualising exceedances since 2018
exc_25_thresh_2017 <- Exc_25$threshold %>% slice(4899:47268)

ggplot(data = exc_25_thresh_2017, aes(x = t)) +
  geom_flame(aes(y = temp, y2 = thresh, fill = "all"), show.legend = F) +
  geom_line(aes(y = temp, colour = "temp")) +
  geom_line(aes(y = thresh, colour = "thresh"), size = 1.0) +
  scale_colour_manual(name = "Line Colour",
                      values = c("temp" = "black", "thresh" =  "forestgreen")) +
  scale_fill_manual(name = "Event Colour", values = c("all" = "salmon")) +
  guides(colour = guide_legend(override.aes = list(fill = NA))) +
  scale_x_date(date_labels = "%Y", breaks="1 year") +
  labs(y = expression(paste("Temperature [", degree, "C]")), x = NULL)

#record annee 2022 

```
  
  




