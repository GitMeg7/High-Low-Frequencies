---
title: "DE CARLO"
author: "Mégane"
date: "2023-04-20"
output: html_document
---

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
library("kableExtra")
library("stringr")
library("berryFunctions")
```


#### *Data wind speed 10m (m/s)*:  
  
→ Azur buoy (model) - 2009-2022  
→ EOL buoy (model) - 2009-2022  
  
Frequency : Hourly  
Unity : m/s

```{r Importation data wind speed, echo=FALSE, warning=FALSE, message=FALSE}

#importation data wind speed (model) of Azur buoy : dec.2008 - dec.2022) :
Wind_Azur <- read_csv("../Data/Wind_speed_10m_Azur_buoy/model_wind_speed_AZUR.csv") 

#delete december 2008 :
Wind_Azur <- Wind_Azur[319:121962,] #jan.2009 to dec.2022


#visualization NA 
#ggplot_na_distribution(Wind_Azur$speed_ms, x_axis_labels=Wind_Azur$Date, xlab="",
#                       ylab="Wind speed (m/s)", title="Wind speed 10m (m/s) of Azur buoy (2009-2022)")

# pas de NA, complete series

##

#importation data wind speed (model) of EOL buoy (fin 2011-2022) :
Wind_EOL <- read_csv("../Data/model_wind_speed_EOL.csv") %>% arrange(date)

#delete december 2008 :
Wind_EOL <- Wind_EOL[319:121962,] #jan.2009 to dec.2022


#visualization NA 
# ggplot_na_distribution(Wind_EOL$speed_ms, x_axis_labels=Wind_EOL$Date, xlab="",
#                        ylab="Wind speed (m/s)", title="Wind speed 10m (m/s) of EOL buoy (2011-2022)")

# pas de NA, complete series

##
```



### **Histogram of wind speed distribution : pelagic (Azur buoy) vs coastal (EOL buoy)**  

```{r Histogram of wind speed distribution, echo=FALSE, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, fig.align='center', fig.show='hold'}

#plot 1
 Wind_Azur %>% 
   ggplot(aes(x=speed_ms)) +
   geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.8) +
   ggtitle("Wind speed distribution (Azur buoy)") + 
   scale_y_continuous(name="Distribution") +
   scale_x_continuous(name="", breaks = c(0, 5, 10, 15, 20))
##
 
#plot 2
 Wind_EOL %>% 
   ggplot(aes(x=speed_ms)) +
   geom_histogram(fill="#ED7F10", color="#e9ecef", alpha=0.8) +
   ggtitle("Wind speed distribution (EOL buoy)") + 
   scale_y_continuous(name="Distribution") +
   scale_x_continuous(name="", breaks = c(0, 5, 10, 15, 20))


```

### **Annual wind speed evolution (2009-2022) : EOL buoy**  
  

```{r filter 9 AM + graph, echo=FALSE, warning=FALSE, message=FALSE}

Wind_EOL_9AM <- Wind_EOL %>% 
  mutate(Hour = format(date, format="%H:%M:%S")) %>% 
  dplyr::filter(Hour == "09:00:00") %>% 
  mutate(datetime = format(date, format="%Y-%m-%d"),
         datetime = as.POSIXct(datetime)) %>% 
  dplyr::select(datetime, speed_ms)
##

graph_wind_eol <- Wind_EOL_9AM %>% 
  mutate(year = format(datetime, format="%Y")) %>% 
  group_by(year) %>% 
  mutate(mean = mean(speed_ms))

graph_wind_eol %>%  
  ggplot() + 
  ggtitle("Evolution of annual wind speed according to time (EOL)") +
  aes(x=year, y=mean) +
  geom_point(shape=6, col="#649B88", size=3) +
  scale_y_continuous(name="Speed (m/s)") +
  scale_x_discrete(name="") #relier les points par une ligne en pointillés ?

```
  

#### *Data pCO2 water SOMLIT (µatm)*:  
  
period : jan.2007 - dec.2022 
  
Frequency : Weekly (every tuesday at 09 AM)  
Unity : µatm  
  
  
```{r importation data pCO2 water, echo=FALSE, warning=FALSE, message=FALSE}

#period : jan. 2007 - dec. 2022
#measurements every tuesday at 09h AM

SOMLIT_pcO2 <- read_delim("../Data/DATA_SOMLIT_07-22_CLEAN.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


#surface data :
SOMLIT_pcO2 <- SOMLIT_pcO2 %>% 
  dplyr::filter(depth==0) %>% 
  rename(pCO2_w = pCO2, datetime = sampling_date) %>%
  mutate(salinity = case_when(salinity < 35 ~ NA_real_ , TRUE ~ salinity))
##
SOMLIT_pcO2 <- distinct(SOMLIT_pcO2)

#creation tab somlit without last rows to do interpolations correctly for pCO2, ta & dic (CT) :
Somlit_interpol <- SOMLIT_pcO2[c(1:821),]
##


#merge wind speed & SOMLIT :
merge1 <- left_join(SOMLIT_pcO2, Wind_EOL_9AM, by="datetime")


```

  
→ Linear interpolation temperature & salinity :  
  

```{r interpolation temp & salinity, echo=FALSE, warning=FALSE, message=FALSE}

impute_temp <- na_interpolation(SOMLIT_pcO2$temperature, option="linear")
impute_sal <- na_interpolation(SOMLIT_pcO2$salinity, option="linear")

ggplot_na_imputations(SOMLIT_pcO2$temperature, impute_temp, x_axis_labels = SOMLIT_pcO2$datetime, xlab = "", ylab="Temp. (°C)", title="Point B - Temperature time series (°C) - period 2007-2022")
ggplot_na_imputations(SOMLIT_pcO2$salinity, impute_sal, x_axis_labels = SOMLIT_pcO2$datetime, xlab = "", ylab="Salinity", title="Point B - Salinity time series - period 2007-2022")

#################

# SOMLIT_pcO2$temperature[is.na(SOMLIT_pcO2$temperature)] <- "NA"
# 
# 
# 
# SOMLIT_pcO2 %>% 
#   dplyr::filter(temperature == "NA") %>% 
#   dplyr::group_by(Year) %>% 
#   dplyr::summarise(number_of_NA = n()) %>% 
#   ggplot(aes(x = Year, y = number_of_NA))  +
#   geom_segment(aes(x = Year, xend = Year, y = 0, yend = number_of_NA), 
#                color = "grey", linewidth = 2) +
#   geom_point(size = 5, fill = "#EE6677", shape = 21, color = "black") +
#   coord_flip() +
#   scale_y_continuous(name = "NA occurences", limits = c(0,15), breaks = seq(0, 15, 1)) + 
#   ggtitle("NA occurences by year for temperature time series (2007-2022)")
# 
# 
# ggplot_na_distribution(SOMLIT_pcO2$temperature, x_axis_labels=SOMLIT_pcO2$datetime, xlab="",
#                        ylab="Temp. (°C)", title="Temperature (2007-2022)")





#merge of impute temperature & salinity
merge1 <- merge1 %>% 
  mutate(impute_temp = impute_temp, impute_sal = impute_sal)


```

→ Linear interpolation pCO2 water :  
  

```{r interpolation pCO2_w, echo=FALSE, warning=FALSE, message=FALSE}

#interpolation pCO2_w :
impute_pCO2_w <- na_interpolation(Somlit_interpol$pCO2_w, option="linear")

ggplot_na_imputations(Somlit_interpol$pCO2_w, impute_pCO2_w, x_axis_labels = Somlit_interpol$datetime,
                      xlab = "", ylab="pCO2 (µatm)", 
                      title="Point B - Ocean pCO2 time series (µatm) - period 2007-2022")
##


#merge of pCO2_w_interpol : 
Somlit_interpol <- Somlit_interpol %>% 
  mutate(impute_pCO2_w = impute_pCO2_w)


```

→ Linear interpolation AT & CT : 

```{r interpolation AT & CT, echo=FALSE, warning=FALSE, message=FALSE}

#interpolation alcalinity
impute_ta <- na_interpolation(Somlit_interpol$ta, option="linear")

ggplot_na_imputations(Somlit_interpol$ta, impute_ta, x_axis_labels = Somlit_interpol$datetime, xlab = "", 
                      ylab="AT (µmol/kg)", 
                      title="Point B - Total alkalinity time series (µmol/kg) - period 2007-2022")


#interpolation CT (dic)
impute_dic <- na_interpolation(Somlit_interpol$dic, option="linear")

ggplot_na_imputations(Somlit_interpol$dic, impute_dic, x_axis_labels = Somlit_interpol$datetime, xlab = "", 
                      ylab="AT (µmol/kg)", 
                      title="Point B - Total carbon time series (µmol/kg) - period 2007-2022")


#merge of impute ta & CT : 
Somlit_interpol <- Somlit_interpol %>% 
  mutate(impute_ta = impute_ta,
         impute_dic = impute_dic)


```


#### *Data pCO2 air (µatm)*:  
  
period : jan.2007 - feb.2022 
  
Frequency : Hourly
Unity : µatm  
  
→ Corse Ersa (40m) - 2013-2020  
→ Plateau Rosa (10m) - 2007-2022  
→ Lampedusa (10m) - 2006-2022  
  
```{r importation data pCO2 air, echo=FALSE, warning=FALSE, message=FALSE}

#CORSE ERSA
pCO2_CORSE <- read_delim("../Data/atmospheric_co2_CORSE_RAW_2013_2020.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

# delate last row :
pCO2_CORSE <- pCO2_CORSE[-65900,]
#46 days of measurements are missing : 2789 - 2743 (theo - obs)

#selection of more or less 09:00 AM data :
pCO2_CORSE <- pCO2_CORSE %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  dplyr::filter(time == "09:00")

#data sorting :
pCO2_CORSE <- pCO2_CORSE %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_CORSE = co2) %>% 
  mutate(CO2_CORSE = case_when(CO2_CORSE == -999.990 ~ NA_real_ , TRUE ~ CO2_CORSE)) %>% 
  dplyr::select(datetime, CO2_CORSE)

# 1534 NA
###########################

### PLATEAU ROSA
pCO2_PLATEAU_ROSA <- read_delim("../Data/atmospheric_co2_PLATEAU_ROSA_2007_2022.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
pCO2_PLATEAU_ROSA <- pCO2_PLATEAU_ROSA %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  dplyr::filter(time == "09:00")


#data sorting :
pCO2_PLATEAU_ROSA <- pCO2_PLATEAU_ROSA %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_PR = co2) %>% 
  mutate(CO2_PR = case_when(CO2_PR == -999.990 ~ NA_real_ , TRUE ~ CO2_PR)) %>% 
  dplyr::select(datetime, CO2_PR)

# 1262 NA
###########################

#LAMPEDUSA
pCO2_LAMPEDUSA <- read_delim("../Data/atmospheric_co2_LAMPEDUSA_2006_2022.CO2", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#selection of 09:00 AM data :
pCO2_LAMPEDUSA <- pCO2_LAMPEDUSA %>% 
  unite(col='datetime', c('Year', 'Month', 'Day'), sep='-') %>% 
  unite(col='time', c('Hour', 'Minute'), sep=':') %>% 
  dplyr::filter(time == "09:00")

#data sorting :
pCO2_LAMPEDUSA <- pCO2_LAMPEDUSA %>% 
  mutate(datetime = format(datetime, format="%Y-%m-%d")) %>% 
  mutate(datetime = as.POSIXct(datetime, format="%Y-%m-%d")) %>%
  rename(CO2_LAMP = co2) %>% 
  mutate(CO2_LAMP = case_when(CO2_LAMP == -999.990 ~ NA_real_ , TRUE ~ CO2_LAMP)) %>% 
  dplyr::select(datetime, CO2_LAMP)

#merge pCO2 air CORSE, Plateau Rosa & Lampedusa with Somlit_pCO2 :
merge2 <- left_join(merge1, pCO2_CORSE, by="datetime") #514 NA

merge3 <- left_join(merge2, pCO2_PLATEAU_ROSA, by="datetime") #231 NA

merge3 <- left_join(merge3, pCO2_LAMPEDUSA, by="datetime") #281 NA

#join Somlit_interpol a merge3 :
merge3 <- left_join(merge3, Somlit_interpol)

```

###### Interpolation of atmospheric pCO2 :  
  
→ Cross interpolation between 3 atmospheric sites : Corsica x Lampedusa x Plateau Rosa  
  
→ Then, linear interpolation :  
*(+ conversion dry mol fraction into µatm)*  
  
```{r conversion dry mol fraction + interpolation data pCO2 air, echo=FALSE, warning=FALSE, message=FALSE}

#pCO2_atmos = interpolation between 3 sites (Corsica x Lampedusa x Plateau Rosa)

merge3 <- merge3 %>% 
  mutate(CO2_CORSE = str_replace_na(CO2_CORSE, replacement = "NA"),
         CO2_PR = str_replace_na(CO2_PR, replacement = "NA"),
         CO2_LAMP = str_replace_na(CO2_LAMP, replacement = "NA"),
         pCO2_atmos_dry = case_when(CO2_CORSE == "NA" ~ CO2_LAMP, TRUE ~ CO2_CORSE),
         pCO2_atmos_dry = case_when(pCO2_atmos_dry == "NA" ~ CO2_PR, TRUE ~ pCO2_atmos_dry))


merge3 <- merge3 %>% 
  mutate(CO2_CORSE = as.numeric(CO2_CORSE),
         CO2_PR = as.numeric(CO2_PR),
         CO2_LAMP = as.numeric(CO2_LAMP),
         pCO2_atmos_dry = as.numeric(pCO2_atmos_dry)) #102 NAs
##


#conversion dry mol fraction pCO2 air into µatm :
merge3 <- merge3 %>% 
  mutate(pCO2_atmos = x2pCO2(S=35, T=25, Patm=1.0, xCO2=pCO2_atmos_dry))
##


#creation merge3 without last rows (=pCO2_atmos NAs)
merge3_interpol <- merge3[c(1:790),]
##


#linear interpolation pCO2 atmos :
impute_pCO2_atmos <- na_interpolation(merge3_interpol$pCO2_atmos, option="linear")

ggplot_na_imputations(merge3_interpol$pCO2_atmos, impute_pCO2_atmos, x_axis_labels = merge3_interpol$datetime, 
                      xlab = "", ylab="pCO2 (µatm)", 
                      title="Atmospheric pCO2 (µatm) time series interpolation - period 2007-2022")
##


#merge of impute pCO2_atmos at merge3 : 
merge3_interpol <- merge3_interpol %>% 
  mutate(impute_pCO2_atmos = impute_pCO2_atmos)

#join merge3_interpol a merge3 :
merge3 <- left_join(merge3, merge3_interpol)


```


```{r calcul delta pCO2, echo=FALSE, warning=FALSE, message=FALSE}

#calculation delta pCO2 = pCO2 water - pCO2 air :
merge3 <- merge3 %>%
  mutate(delta_pCO2 = impute_pCO2_w - impute_pCO2_atmos)


#save merge3 :
#write.table(merge3, "DATA_SOMLIT_07-22_impute_0m.csv", sep=";", col.names = TRUE, row.names = FALSE)

```


→ Annual cycle of pCO2 (2007-2022) :  
  

```{r annual cycle of pCO2 (2007-2021), echo=FALSE, warning=FALSE, message=FALSE}

annual_cycle_pco2Plot <- merge3 %>% 
  ggplot() +
  geom_line(aes(x= as.Date(yday(datetime), "1970-01-01"), y=impute_pCO2_w, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of sea pCO2 (2007-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "Sea pCO2 (µatm)") 

annual_cycle_pco2Plot
##

#save
# ggsave(filename = "annual_cycle_pco2Plot.jpg", # Nommez le fichier dans lequel vous voulez enregistrer, ajoutez l'extension du format de fichier que vous voulez utiliser (ex. pdf).
#        plot = annual_cycle_pco2Plot, # Fournir le nom de l'objet plot dans R
#        height = 7, # Fournir les dimensions voulues
#        width = 9, 
#        units = "in") 
```
  

→ Calculation of NpCO~2~ & TpCO~2~ :  
  
*NpCO~2~ = non-temperature effects on pCO~2~ water variations*  
  
*TpCO~2~ = only temperature effects on pCO~2~ water variations*  
  
→ Calculation of deltas :  
  
-   delta pCO~2~(T) = temperature effects = pCO~2~ water - NpCO~2~  

-   delta pCO~2~(bio) : biological effects = pCO~2~ water - TpCO~2~  
  

```{r NpCO2 & TpCO2 calculations, echo=FALSE, warning=FALSE, message=FALSE}

#formula NpCO2 : pCO2w obs * e(0.0423*Tmean-Tobs)
#formula TpCO2 : pCO2mean * exp[0.0423(Tobs - Tmean)]

merge3 <- merge3 %>% 
  mutate(Tmean = mean(impute_temp),
         pCO2_w_mean = mean(merge3$impute_pCO2_w, na.rm = TRUE),
         NpCO2 = impute_pCO2_w * exp(0.0423*(Tmean-impute_temp)),
         TpCO2 = pCO2_w_mean * exp(0.0423*(impute_temp-Tmean)))
##

#deltas calculation :
merge3 <- merge3 %>%
  mutate(delta_pCO2_T = (impute_pCO2_w - NpCO2),
         delta_pCO2_bio = (impute_pCO2_w - TpCO2))

##

#plot deltas :
pCO2bio_pCO2T_plot_long <- merge3 %>% 
  rename(`DpCO2 (T)` = delta_pCO2_T, `DpCO2 (bio)` = delta_pCO2_bio) %>%
  pivot_longer(cols = c(`DpCO2 (T)`, `DpCO2 (bio)`), names_to = "Legend", values_to = "value")

pCO2bio_pCO2T_plot <- pCO2bio_pCO2T_plot_long %>% 
  ggplot() +
  ggtitle("Temperature and biological effects on pCO2 variations (2007-2022)") +
  geom_line(aes(x=datetime, y=value, color= Legend), size=0.5) +
  scale_y_continuous(name="ΔpCO2") + 
  scale_x_datetime(name="") + 
  scale_colour_discrete(type=c("#096A09", "#E9383F"))

pCO2bio_pCO2T_plot
##

#save
# ggsave(filename = "pCO2bio_pCO2T_plot.jpg", # Nommez le fichier dans lequel vous voulez enregistrer, ajoutez l'extension du format de fichier que vous voulez utiliser (ex. pdf).
#        plot = pCO2bio_pCO2T_plot, # Fournir le nom de l'objet plot dans R
#        height = 6, # Fournir les dimensions voulues
#        width = 19, 
#        units = "in") 


```

→ Atmospheric and water pCO~2~ (µatm) according to time (2007-2022) :  
  

```{r atmospheric & water pCO2 plot, echo=FALSE, warning=FALSE, message=FALSE}

atmos_water_pCO2_plot_long <- merge3 %>% 
  rename(`pCO2 water` = impute_pCO2_w, `pCO2 atmospheric` = impute_pCO2_atmos, NpCO2 = NpCO2) %>% 
  pivot_longer(cols = c(`pCO2 water`, `pCO2 atmospheric`, "NpCO2"), names_to = "Legend", values_to = "value")

#plot
atmos_water_pCO2_plot <- atmos_water_pCO2_plot_long %>% 
  ggplot() +
  ggtitle("Complete time series of pCO2 (µatm)") +
  geom_line(aes(x=datetime, y=value, color= Legend), size=0.7) +
  scale_y_continuous(name="pCO2 (µatm)") + 
  scale_x_datetime(name="") + 
  scale_colour_discrete(type=c("#708D23", "#CC5500", "#56739A"))

atmos_water_pCO2_plot
##

#save
# ggsave(filename = "atmos_water_pCO2_plot.jpg", # Nommez le fichier dans lequel vous voulez enregistrer, ajoutez l'extension du format de fichier que vous voulez utiliser (ex. pdf).
#        plot = atmos_water_pCO2_plot, # Fournir le nom de l'objet plot dans R
#        height = 6, # Fournir les dimensions voulues
#        width = 11, 
#        units = "in") 

#save merge3 :
#write.table(merge3, "DATA_SOMLIT_07-22_impute_0m_deltas_pCO2.csv", sep=";", col.names = TRUE, row.names = FALSE)

```



## Air-surface CO~2~ flux  
  
  
### Flux calculation  
  
→ **negative values = flux into the ocean**  
  
  
Method used : Wanninkhof (2014)  
  

```{r calcul flux, echo=FALSE, warning=FALSE, message=FALSE}

#Calcul of F
tab_flux <- merge3 %>% 
    mutate(Flux_CO2_2014 = (0.00077 * speed_ms^2 * delta_pCO2)/(24*365)) #to have a flux per hour


#plot Flux Wanninkhof 2014 :
tab_flux %>% 
  ggplot() + 
  aes(x=datetime, y=Flux_CO2_2014) + 
  geom_line(col="#967C5C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Flux (mol of C/m²/y)") +
  ggtitle("CO2 fluxes ocean-atmosphere (Wanninkhof 2014)") #mettre les valeurs y en notation scientifique 

```
  


Method used : Wanninkhof (1992)  
  
   
Formulas :  
  
-   K600 = 0.266 \* U²  
  
-   SC = 2073.1 - (125.62 \* T) + (3.6276 \* T²) - (0.043219 \* T\^3)  
  
-   k = K600 \* (SC/600)\^0.5 (cm/h)  
  
-   K0 = Henry's constant (seacarb)  
  
  
Final formula : F = k \* K0 \* ΔpCO2  
  
unity : mol of C / m² / year  
  
```{r calcul Flux Wanninkhof (1992), echo=FALSE, warning=FALSE, message=FALSE}

tab_flux <- tab_flux %>% 
  mutate(SC = 2073.1 - (125.62 * impute_temp) + (3.6276 * impute_temp^2) - (0.043219 * impute_temp^3),
         K600 = 0.266 * speed_ms^2,
         k = K600 * (SC/600)^0.5,
         rho = rho(S=impute_sal, T=impute_temp, P=0)/1000,
         K0 = (K0(S=impute_sal, T=impute_temp, P=0, Patm=1, warn="n")),
         K0 = (K0 * rho)/1000000, 
         Flux_wan_92 = (k * K0 * delta_pCO2)*10)
##


##unity steps :

#K0 en mol/kg/atm
#rho (density of water) en kg/m3
#donc rho/1000 = kg/L
#donc K0*(rho/1000) = mol/l/atm

#K0/10^6 pour passer de mol/L/atm a mol/L/µatm

#Flux*10 pour passer de 10 mol/m²/h a mol/m²/h
#Flux*24*365 pour passer de mol/m²/h a mol/m²/y


#plot Flux wanninkhof 1992 :
tab_flux %>% 
  ggplot() + 
  aes(x=datetime, y=Flux_wan_92) + 
  geom_line(col="#677179") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Flux (mol C/m²/h)") +
  ggtitle("CO2 fluxes between ocean and atmosphere at Point B (2009-2022)")


```
  
Method used : David T. Ho (2023)  
  
Formulas :  
  
-   K600 = 0.143 \* U²  
  
-   SC = 2073.1 - (125.62 \* T) + (3.6276 \* T²) - (0.043219 \* T\^3)  
    or gas_schmidt() function of marelac package (same result)
  
-   k = K600 \* (SC/600)\^0.5 (cm/h)  
  
-   K0 = Henry's constant (seacarb)
Final formula : F = k \* K0 \* ΔpCO2  
  
unity : mol of C / m² / year


```{r calcul Flux David T. Ho (2023), echo=FALSE, warning=FALSE, message=FALSE}

tab_flux <- tab_flux %>% 
  mutate(K600_M3 = 0.143 * speed_ms^2,
         Flux_HO = ((K600_M3*(SC/600)^0.5) * K0 * delta_pCO2)*10)

#plot Flux David T. Ho (2023) :
tab_flux %>% 
  ggplot() + 
  aes(x=datetime, y=Flux_HO) + 
  geom_line(col="#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Flux (mol/m²/y)") +
  ggtitle("CO2 fluxes ocean-atmosphere (David T. Ho 2023)")

```
  
Summary table of 3 calculation methods results (Wanninkhof 1992 & 2014, David T. Ho 2023) :  
  
  
```{r 3 methods comparison table, echo=FALSE, warning=FALSE, message=FALSE}

summary_table <- data.frame(tab_flux$datetime, tab_flux$Flux_wan_92, tab_flux$Flux_CO2_2014, tab_flux$Flux_HO)

colnames(summary_table) <- c("Datetime", "Flux_wan_92", "Flux_wan_2014", "Flux_Ho_2023")

summary_table[104:837,]


```

Plot comparing the 3 CO~2~ flux calculation results :  
  

```{r 3 methods comparison - plot, echo=FALSE, warning=FALSE, message=FALSE}

#creation column for legend
tab_flux_long <- tab_flux %>% 
  rename(`Flux W (1992)` = Flux_wan_92, `Flux W (2014)` = Flux_CO2_2014,  `Flux Ho (2023)` = Flux_HO) %>% 
  pivot_longer(cols=c(`Flux W (1992)`, `Flux W (2014)`, `Flux Ho (2023)`), names_to = "Legend", values_to = "value")

#plot
tab_flux_long %>% 
  ggplot() +
  ggtitle("CO2 fluxes ocean-atmosphere (3 methods comparison)") +
  geom_line(aes(x=datetime, y=value, color= Legend), size=0.5) +
  scale_y_continuous(name="CO2 flux (mol/m²/y)") + 
  scale_x_datetime(name="")


```



```{r flux annuels, echo=FALSE, warning=FALSE, message=FALSE}

test <- tab_flux %>% 
  group_by(Year) %>% 
  mutate(moy_flux = mean(Flux_wan_92, na.rm=T)) %>% 
  mutate(yyy = format(datetime, format = "%Y"))

test %>% 
  ggplot() + 
  aes(x=Year, y=moy_flux) + 
  geom_bar(stat = "identity", width=0.9, fill="#303030") + 
  scale_x_discrete(name="", limits=c("2009" : "2022")) + 
  scale_y_continuous(name="CO2 flux (mol of C/m²/h)", labels = label_scientific(), n.breaks = 10) +
  ggtitle("Mean of CO2 fluxes per year (2009-2022)")


## save flux
#write.table(tab_flux, "DATA_SOMLIT_07-22_impute_0m_deltas_pCO2_and_fluxes_CO2.csv", sep=";", col.names = TRUE, row.names = FALSE)

```
  
  
## Comparison with DE CARLO results (jan.2007 - oct.2011)  
  
  
Point B : 2009-2011, so comparison for 2009-2011 period  
  

```{r Comparison with DE CARLO results, echo=FALSE, warning=FALSE, message=FALSE}

#select 2007-2011 on tab-flux :
de_carlo <- tab_flux %>% 
  dplyr::filter(datetime >= "2009-01-06" & datetime <= "2011-10-04")

de_carlo %>% 
   ggplot() + 
   aes(x=datetime, y=Flux_CO2_2014) + 
   geom_line(col="#967C5C") +
   scale_x_datetime(name="") +
   scale_y_continuous(name="Flux (mol of C/m²/y)") +
   ggtitle("2009-2011 : CO2 fluxes ocean-atmosphere (Wanninkhof 2014)")

de_carlo <- de_carlo %>% 
  mutate(average_flux_h = mean(Flux_CO2_2014, na.rm=T),
         max_flux_h = max(Flux_CO2_2014, na.rm=T),
         min_flux_h = min(Flux_CO2_2014, na.rm=T))



```
  
  
  
De Carlo (2007-2011) :  
- average hourly flux : -2.19e-05  
- annualized flux (by year) : 1.91e-01  
- maximum hourly flux (winter) : -4.57e-04  
- minimum hourly flux (summer): 4.29e-04  
  
  
De Carlo (01/06/2009 - 10/04/2011) :  
- average hourly flux : -2.77e-05  
- annualized flux (by year) : 2.42e-01  
- maximum hourly flux (winter) : -4.57e-04  
- minimum hourly flux (summer): 4.29e-04  
   
Point B (01/06/2009 - 10/04/2011) :  
- average hourly flux : -1.65e-06  
- annualized flux (by year) : 1.45e-02
- maximum hourly flux (winter) : -3.23e-04  
- minimum hourly flux (summer) : 5.70e-04  
  

