---
title: "Oxygen"
author: "Mégane"
date: "2023-05-08"
output: html_document
---

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
library("kableExtra")
library("stringr")
library("berryFunctions")
library("LakeMetabolizer")
library("rMR")
library("EnvStats")

#theme for plots :
Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
    theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
          axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
          axis.text.y = element_text(face=face_font, color="black", size=size_labs),
          axis.title.y = element_text(face=face_font, size=size_labs),
          axis.ticks.x = element_line(size=0.1),
          axis.ticks.y = element_line(size=0.1),
          axis.ticks.length = unit(1.1, "mm"),
          panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
          aspect.ratio = 1 / 3,
          plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
    )
}

```


```{r data oxygen EOL, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen EOL : only from 05-05-2017 - mars.2023
#frequency : hourly (raw)
#unity : umol/kg
data_EOL <- read_delim("../Data/EOL_raw_complete_1323.csv", delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::filter(datetime >= "2018-01-01 00:00:00" & datetime <= "2022-11-22 05:00:00")


```

## EOL - oxygen time series trend analysis by residuals (substracting climatological monthly means) - jan.2018 - nov.2022
  
*Analysis without interpolations*  
  

```{r trend analysis EOL oxy, echo=FALSE, warning=FALSE, message=FALSE}

data_EOL <- data_EOL %>% 
  mutate(Month = format(datetime, format = "%m"))

## Monthly means EOL oxygen :

monthly_means_EOL_oxy <- ungroup(data_EOL) %>% 
  group_by(Month) %>%
  summarise(oxy_EOL_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_EOL_oxy <- left_join(ungroup(data_EOL), monthly_means_EOL_oxy, by = "Month") %>%
  mutate(oxy_EOL_ano = oxy_umol_kg - oxy_EOL_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_EOL_oxy)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_EOL_oxy))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_EOL_oxy <- reg

# Regression and table anomalies
var_list <- "oxy_EOL_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_EOL_oxy))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_EOL_oxy <- reg

reg_ano_EOL_oxy #pourquoi p-value = 0


## Plot anomalies EOL oxy :

#plot 1 : raw oxygen data
plot_ano_EOL_oxy_raw <- ggplot(data = anomalies_EOL_oxy, aes(x = datetime, y = oxy_EOL_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for EOL oxygen data (2018-2022)",x="", y="Oxygen (µmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : -1.21 ± 0.027 *", color="black")

plot_EOL_oxy_raw <- data_EOL %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (µmol/kg)") +
  ggtitle("EOL oxygen time series in µmol/kg (2018-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_EOL_oxy_raw
plot_ano_EOL_oxy_raw
```
  
## Point B raw - oxygen time series trend analysis by residuals (substracting climatological monthly means)  
  
*Analysis without interpolations* 
  
###### → surface data (1m) :  


```{r data oxygen SOMLIT, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen SOMLIT : from jan.2002 - dec.2022
#frequency : weekly
#unity : umol/kg
data_somlit_surf_raw <- read_delim("../Data/DATA_SOMLIT_02-22_oxy.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::filter(PROF_NUM < 3) %>% 
  mutate(Month = format(datetime, format="%m"))

data_somlit_prof_raw <- read_delim("../Data/DATA_SOMLIT_02-22_oxy.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  dplyr::filter(PROF_NUM > 3) %>% 
  mutate(Month = format(datetime, format="%m"))

```

  
```{r trend analysis SOMLIT oxy - surface - raw, echo=FALSE, warning=FALSE, message=FALSE}


## Monthly means surface :

monthly_means_somlit_oxy_surf <- ungroup(data_somlit_surf_raw) %>% 
  group_by(Month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_oxy_surf <- left_join(ungroup(data_somlit_surf_raw), monthly_means_somlit_oxy_surf, by = "Month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_oxy_surf)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_oxy_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_oxy_surf <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_oxy_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_oxy_surf <- reg

reg_ano_somlit_oxy_surf 


## Plot anomalies Point B surface :

plot_ano_somlit_oxy_surf <- ggplot(data = anomalies_somlit_oxy_surf, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (surface) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.37 ± 0.067 *", color="black")


plot_somlit_oxy_surf <- data_somlit_surf_raw %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (μmol/kg)") +
  ggtitle("Point B oxygen time series (surface) in μmol/kg (2002-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_oxy_surf
plot_ano_somlit_oxy_surf
```

  
  
###### → 50 m depth data :  
  
```{r trend analysis SOMLIT oxy - 50m - raw, echo=FALSE, warning=FALSE, message=FALSE}


## Monthly means 50m :

monthly_means_somlit_oxy_prof <- ungroup(data_somlit_prof_raw) %>% 
  group_by(Month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_oxy_prof <- left_join(ungroup(data_somlit_prof_raw), monthly_means_somlit_oxy_prof, by = "Month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_oxy_prof)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_oxy_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_oxy_prof <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_oxy_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_oxy_prof <- reg

reg_ano_somlit_oxy_prof 


## Plot anomalies Point B 50m :

plot_ano_somlit_oxy_prof <- ggplot(data = anomalies_somlit_oxy_prof, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (50 m) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.30 ± 0.078 *", color="black")

plot_somlit_oxy_prof <- data_somlit_prof_raw %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (μmol/kg)") +
  ggtitle("Point B oxygen time series (50 m) in μmol/kg (2002-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_oxy_prof
plot_ano_somlit_oxy_prof
```

  
  
## Point B clean - oxygen time series trend analysis by residuals (substracting climatological monthly means)  
  
*Analysis with interpolations* 
  
###### → surface data (1m) : same results as raw  
  
  
```{r data oxygen SOMLIT - surface, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen somlit surface : jan.2002 - dec.2022
#frequency : weekly (clean + impute)
#unity : ml/l and µmol/kg

data_somlit_surf <- read_delim("../Data/DATA_SOMLIT_02-22_oxy_CLEAN_impute_0m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


```

→ Trend analysis by residuals (Bates et al. 2014) :  
  
Observed dissolved oxygen : positive trend (Garcia et al., 1998)  
*slope : 0.37 ± 0.067 μmol/kg par année*  
  
```{r trend analysis SOMLIT oxy - surface, echo=FALSE, warning=FALSE, message=FALSE}


## Monthly means surface :

monthly_means_somlit_surf <- ungroup(data_somlit_surf) %>% 
  group_by(month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_surf <- left_join(ungroup(data_somlit_surf), monthly_means_somlit_surf, by = "month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_surf)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_surf <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_surf <- reg

reg_ano_somlit_oxy_surf 


## Plot anomalies Point B surface :

plot_ano_somlit_surf <- ggplot(data = anomalies_somlit_surf, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (surface) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.37 ± 0.067 *", color="black")


plot_somlit_surf <- data_somlit_surf %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (μmol/kg)") +
  ggtitle("Point B oxygen time series (surface) in μmol/kg (2002-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_surf
plot_ano_somlit_surf
```
  

###### → 50 m data : same results as raw data  
  
  
```{r data oxygen SOMLIT - 50m, echo=FALSE, warning=FALSE, message=FALSE}

#oxygen somlit 50m : jan.2002 - dec.2022
#frequency : weekly (clean + impute)
#unity : ml/l and µmol/kg

data_somlit_prof <- read_delim("../Data/DATA_SOMLIT_02-22_oxy_CLEAN_impute_50m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)


```

→ Trend analysis by residuals (Bates et al. 2014) :  
  
*légère augmentation de l'oxygène dissous à 50 mètres (μmol/kg) : *  
*slope : 0.30 ± 0.078 μmol/kg par année*  
  
```{r trend analysis SOMLIT oxy - 50m, echo=FALSE, warning=FALSE, message=FALSE}


## Monthly means 50m :
monthly_means_somlit_prof <- ungroup(data_somlit_prof) %>% 
  group_by(month) %>%
  summarise(oxy_somlit_month = mean(oxy_umol_kg, na.rm = TRUE))

##

## Parameters

anomalies_somlit_prof <- left_join(ungroup(data_somlit_prof), monthly_means_somlit_prof, by = "month") %>%
  mutate(oxy_somlit_ano = oxy_umol_kg - oxy_somlit_month)



# Regressions and tables of key parameters
var_list <- "oxy_umol_kg"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_somlit_prof)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_somlit_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_prof <- reg

# Regression and table anomalies
var_list <- "oxy_somlit_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_somlit_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_somlit_prof <- reg

reg_ano_somlit_oxy_prof 


## Plot anomalies Point B 50m :

plot_ano_somlit_prof <- ggplot(data = anomalies_somlit_prof, aes(x = datetime, y = oxy_somlit_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for oxygen data (50m) at Point B (2002-2022)",x="", y="Oxygen (μmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 0.30 ± 0.078 *", color="black")


plot_somlit_prof <- data_somlit_prof %>% 
  ggplot() +
  aes(x=datetime, y=oxy_umol_kg) + 
  geom_line(size=0.8, col = "#22427C", linewidth = 0.5) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Oxygen (μmol/kg)") +
  ggtitle("Point B oxygen time series (50m) in μmol/kg (2002-2022)")
#geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE)
##

plot_somlit_prof
plot_ano_somlit_prof
```
  
  
## EOL : AOU calculation (Apparent Oxygen Utilisation) :  
  
Period : jan.2018 - nov.2022  
  
AOU  = [O~2~ saturation] in µmol/kg  - [O~2~ observed] in µmol/kg  
Unity : µmol/kg  
  

```{r EOL : AOU, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1 <- (data_EOL$temp_eol_c + 273.15) / 100

#calcul OSAT (ml/kg) :
OSAT = -177.7888 + 255.5907/T1 + 146.4813*log(T1) - 22.2040*T1
OSAT = OSAT + data_EOL$sal_eol_psu * (-0.037362 + T1 * (0.016504 - 0.0020564 * T1))
OSAT = exp(OSAT)

#convert from ml/kg to umol/kg :
OSAT = (OSAT * 1000)/ 22.392

#calculate AOU in umol/kg
AOU_EOL = OSAT - data_EOL$oxy_umol_kg

data_EOL <- data_EOL %>% 
  mutate(AOU = AOU_EOL)

```
  
  

→ AOU (EOL) annual cycle :  
  
AOU : valeurs majoritairement négatives = 
*plus faibles valeurs en été*  
  
*scatter plot : Temp. influence significativement AOU : quand T augmente, AOU diminue*  
  
Shifts : 2020 and 2021  
  

```{r AOU EOL + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_EOL <- data_EOL %>% 
  ggplot() + 
  aes(x=datetime, y=AOU) + 
  geom_line(col = "#01796F") + 
  ggtitle("AOU in µmol/kg at sea surface - EOL (2018-2022)") +
  scale_x_datetime(name="") + 
  scale_y_continuous(name="AOU (µmol/kg)")
##

plot_AOU_EOL_annual_cycle <- data_EOL %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (surface) - EOL (2018-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 
##

plot_AOU_EOL
plot_AOU_EOL_annual_cycle
##

#scatter plot AOU vs T
data_EOL %>% 
  ggplot() +
  aes(x=temp_eol_c, y=AOU) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("AOU according to temperature : EOL (2018-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=22, y=60, label="slope : -0.46 ± 0.009 *", color="black")

#summary(lm(data_EOL$AOU ~ data_EOL$temp_eol_c))
##

#histogram AOU by year :

data_EOL <- data_EOL %>% 
  mutate(Year = format(datetime, format="%Y"),
         month = format(datetime, format="%m")) %>% 
  group_by(Year) %>% 
  mutate(mean_AOU = mean(AOU, na.rm = T))
  
data_EOL %>% 
  ggplot() +
  aes(x=Year, y=mean_AOU) +
  geom_bar(stat = "identity", width=0.9, fill="#303030") +
  scale_x_discrete(name="", limits=c("2018" : "2022")) + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("Mean of AOU per year (2018-2022)")

#echelle pas bonne je sais pas pourquoi



```
  
  
  

###### Trend analysis by residuals - AOU - EOL (Bates et al. 2014) :  
  
*augmentation de l'AOU (µmol/kg) : *  
*slope : 1.34 ± 0.023 µmol/kg par année* 

```{r trend analysis AOU - EOL, echo=FALSE, warning=FALSE, message=FALSE}

## Monthly means AOU EOL :
monthly_means_AOU_EOL <- ungroup(data_EOL) %>% 
  mutate(month = format(datetime, format="%m")) %>% 
  group_by(month) %>%
  summarise(AOU_month = mean(AOU, na.rm = TRUE))

##

## Parameters

anomalies_AOU_EOL <- left_join(ungroup(data_EOL), monthly_means_AOU_EOL, by = "month") %>%
  mutate(AOU_ano = AOU - AOU_month)



# Regressions and tables of key parameters
var_list <- "AOU"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_AOU_EOL)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_AOU_EOL))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_EOL <- reg

# Regression and table anomalies
var_list <- "AOU_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_EOL))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_EOL <- reg

reg_ano_AOU_EOL 


#plot anomalies AOU surface :
plot_ano_AOU_EOL <- ggplot(data = anomalies_AOU_EOL, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AOU at EOL (2018-2022)",x="", y="AOU (µmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2020-04-22 04:00:00"), y=50, label="slope : 1.34 ± 0.023 *", color="black")



plot_AOU_EOL
plot_ano_AOU_EOL

```

## Point B clean - AOU calculation (Apparent Oxygen Utilisation) :  
  
AOU  = [O~2~ saturation] in µmol/kg  - [O~2~ observed] in µmol/kg  
Unity : µmol/kg  
  
OSAT : driven by temperature  
  
AOU removes the effect of OSAT, which is primarily driven by temperature  
  
###### → surface data (1m) :  
  

```{r AOU calculation - SOMLIT surface, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1 <- (data_somlit_surf$T + 273.15) / 100

#calcul OSAT (ml/kg) :
OSAT = -177.7888 + 255.5907/T1 + 146.4813*log(T1) - 22.2040*T1
OSAT = OSAT + data_somlit_surf$S * (-0.037362 + T1 * (0.016504 - 0.0020564 * T1))
OSAT = exp(OSAT)

#convert from ml/kg to umol/kg :
OSAT = (OSAT * 1000)/ 22.392

#calculate AOU in umol/kg
AOU = OSAT - data_somlit_surf$oxy_umol_kg

data_somlit_surf <- data_somlit_surf %>% 
  mutate(AOU = AOU) 

data_somlit_surf <- cbind(data_somlit_surf, OSAT)


#negative AOU (Garcia et al., 1998)
# −AOU = O2 − OSAT

data_somlit_surf <- data_somlit_surf %>% 
  mutate(neg_AOU = oxy_umol_kg - OSAT)

```
  
  


→ AOU (surface) annual cycle : low values in summer  
  
Temperature and DO are correlated (r = -0.66) : when temp. increases, DO decreases  
  

```{r AOU surface + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_surf_annual_cycle <- data_somlit_surf %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (surface) - Point B (2002-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 

plot_AOU_surf_annual_cycle
##

#scatter plot DO vs T
data_somlit_surf %>% 
  ggplot() +
  aes(x=T, y=oxy_umol_kg) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="DO (µmol/kg)") +
  ggtitle("Correlation between temperature and issolved at Point B (2002-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=22, y=125, label="slope : -2.72 ± 0.09 *", color="black")

#summary(lm(data_somlit_surf$oxy_umol_kg ~ data_somlit_surf$T))
#cor(data_somlit_surf$T, data_somlit_surf$oxy_umol_kg)
##



```
  
  
→ AOU (surface) minima and maxima evolution (2002-2022) :  
  

```{r AOU minima and maxima - surface, echo=FALSE, warning=FALSE, message=FALSE}

AOU_minima_maxima_surf <- data_somlit_surf %>% 
  group_by(year) %>% 
  mutate(AOU_min = min(AOU, na.rm = TRUE),
         AOU_max = max(AOU, na.rm = TRUE),
         mean_AOU = mean(AOU, na.rm = T))
##

AOU_minima_surf_long <- AOU_minima_maxima_surf %>% 
  rename(`AOU minima` = AOU_min, `AOU maxima` = AOU_max, `AOU mean` = mean_AOU) %>% 
  pivot_longer(cols = c(`AOU minima`, `AOU mean`, `AOU maxima`), names_to = "Legend", values_to = "value")

#plot
plot_AOU_min_max_mean_surf <- AOU_minima_surf_long %>% 
  ggplot() +
  ggtitle("AOU minima, maxima and mean per year - Point B (2002-2022)") +
  geom_point(aes(x=year, y=value, color= Legend), size=1) +
  geom_line(aes(x=year, y=value, color= Legend), size=0.7) +
  scale_y_continuous(name="AOU (µmol/kg)") + 
  scale_x_discrete(name="", limits = c(2002 :2022)) + 
  scale_colour_discrete(type=c("#CC5500", "black", "#6D071A"))

plot_AOU_min_max_mean_surf

```
  
  

###### Trend analysis by residuals - AOU - surface (Bates et al. 2014) :  
  
AOU : negative trend (Garcia et al., 1998)  
Inverse relation between AOU and observed O~2~  
*slope : -0.50 ± 0.060 µmol/kg par année* 

```{r trend analysis AOU - surface, echo=FALSE, warning=FALSE, message=FALSE}

## Monthly means AOU surface :
monthly_means_AOU_surf <- ungroup(data_somlit_surf) %>% 
  group_by(month) %>%
  summarise(AOU_month = mean(AOU, na.rm = TRUE),
            OSAT_month = mean(OSAT, na.rm = TRUE),
            neg_AOU_month = mean(neg_AOU, na.rm = TRUE))

##

## Parameters

anomalies_AOU_surf <- left_join(ungroup(data_somlit_surf), monthly_means_AOU_surf, by = "month") %>%
  mutate(AOU_ano = AOU - AOU_month,
         OSAT_ano = OSAT - OSAT_month,
         neg_AOU_ano = neg_AOU - neg_AOU_month)



# Regressions and tables of key parameters
var_list <- c("AOU","OSAT", "neg_AOU")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_AOU_surf)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_AOU_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_surf <- reg

# Regression and table anomalies
var_list <- c("AOU_ano", "OSAT_ano", "neg_AOU_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_surf))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_surf <- reg

#reg_ano_AOU_surf 


#plot anomalies AOU surface :
plot_ano_AOU_surf <- ggplot(data = anomalies_AOU_surf, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AOU (surface) at Point B (2002-2022)",x="", y="AOU (µmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2012-03-20"), y=80, label="slope : -0.50 ± 0.060 *", color="black")


plot_AOU_surf <- data_somlit_surf %>% 
  ggplot() + 
  aes(x=datetime, y=AOU) + 
  geom_line(col = "#01796F") + 
  ggtitle("AOU in µmol/kg at sea surface - Point B (2002-2022)") +
  scale_x_datetime(name="") + 
  scale_y_continuous(name="AOU (µmol/kg)")


plot_AOU_surf
plot_ano_AOU_surf

```
  
  
  
→ Plot monthly means of O~2~, O~2~sat and negative AOU anomalies (Mavropoulou et al., 2020)  
  
Negative AOU and dissolved oxygen are similar in magnitude (r = 0.98)  
O~2~sat is close to zero  
→ thus, the solubility changes have a secondary role in the observed dissolved oxygen variations  
  
  

```{r plot O2, O2 sat & AOU monthly means, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_AOU_surf <- anomalies_AOU_surf %>% 
  group_by(year) %>% 
  mutate(annual_mean_AOU = mean(AOU_ano),
         annual_mean_OSAT = mean(OSAT_ano),
         annual_mean_neg_AOU = mean(neg_AOU_ano))

anomalies_somlit_surf <- anomalies_somlit_surf %>% 
  group_by(year) %>% 
  mutate(annual_mean = mean(oxy_somlit_ano))

plot_df <- data.frame(datetime = anomalies_AOU_surf$year, AOU = anomalies_AOU_surf$annual_mean_AOU, 
                      neg_AOU = anomalies_AOU_surf$annual_mean_neg_AOU,
                        OSAT = anomalies_AOU_surf$annual_mean_OSAT, OXY = anomalies_somlit_surf$annual_mean)

plot_df <- distinct(plot_df)

plot_df %>% 
ggplot() + 
  geom_line(aes(x=datetime, y=neg_AOU), col="black") +
  geom_line(aes(x=datetime, y=OSAT), col="darkgreen") +
  geom_line(aes(x=datetime, y=OXY), col="blue") + 
  scale_y_continuous(name="Oxygen(µmol/kg)")

#cor(plot_df$neg_AOU, plot_df$OXY, method="pearson")




```




###### Trend analysis by moving average (decompose function) :  
  
*Quick overview of the components of the series*   
  

```{r decompose function - AOU surface, echo=FALSE, warning=FALSE, message=FALSE}

#AOU time-series :
AOU_ts <- ts(data_somlit_surf$AOU, start = c(2002,2), end = c(2022,52), freq = 52)

#type = additive because the seasonal pattern doesn't seem to increase in variation, seasonal pattern looks constant
AOU_ts_decomp <- decompose(AOU_ts, type = "additive") #pareil qu'en rajoutant : filter = rep(1/52,52)

autoplot(AOU_ts_decomp) +
  xlab('')


# plot(AOU_ts_decomp$x, col="black")
# lines(AOU_ts_decomp$seasonal, col="red")

#plot(AOU_ts_decomp$figure)
```
  
  

→ Remove seasonality :  
  
measured values - seasonal pattern  
OR  
trend + remainders  
  
*applying trend on the outputed series*  
  

```{r remove seasonal pattern - AOU surface, echo=FALSE, warning=FALSE, message=FALSE}

#2 ways :
# 1 : measured values - seasonal pattern
# 2 : trend + random

AOU_ts_less_season <- AOU_ts_decomp$x - AOU_ts_decomp$seasonal

plot_AOU_ts_less_season <- autoplot(AOU_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU surface time series (without seasonality)") +
  geom_smooth(method=lm)

#regression AOU surface values :
reg_val_AOU_less_season <- as.data.frame(plot_AOU_ts_less_season$data)

model_AOU_less_season <- lm(formula=y~x, data=reg_val_AOU_less_season)
#summary(model_AOU_less_season) #pour voir les erreurs des coef + la significativité


#plot with slope value :
plot_AOU_ts_less_season <- autoplot(AOU_ts_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU surface time series (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2013, y=57, label="slope : -0.46 ± 0.064 *", color="black")

plot_AOU_ts_less_season

```
  
  
  
###### → 50 m data :  
  
```{r AOU calculation - SOMLIT prof, echo=FALSE, warning=FALSE, message=FALSE}

#calcul T1 :
T1_prof <- (data_somlit_prof$T + 273.15) / 100

#calcul OSAT_prof (ml/kg) :
OSAT_prof = -177.7888 + 255.5907/T1_prof + 146.4813*log(T1_prof) - 22.2040*T1_prof
OSAT_prof = OSAT_prof + data_somlit_prof$S * (-0.037362 + T1_prof * (0.016504 - 0.0020564 * T1_prof))
OSAT_prof = exp(OSAT_prof)

#convert from ml/kg to umol/kg :
OSAT_prof = (OSAT_prof * 1000)/ 22.392

#calculate AOU in umol/kg
AOU = OSAT_prof - data_somlit_prof$oxy_umol_kg

data_somlit_prof <- data_somlit_prof %>% 
  mutate(AOU = AOU)

```
  

→ AOU (50m) annual cycle : low values in summer  
  
Temperature and DO have a weak correlation, lower than in surface (r = -0.21) : when temp. increases, DO decreases  
  

```{r AOU 50m + annual cycle, echo=FALSE, warning=FALSE, message=FALSE}

plot_AOU_prof_annual_cycle <- data_somlit_prof %>% 
  ggplot() +
  geom_line(aes(x = as.Date(yday(datetime), "1970-01-01"), y = AOU, 
                group = factor(year(datetime)), 
                color = factor(year(datetime))), linewidth = 0.6) +
  scale_colour_viridis_d(option="mako", direction=-1) +
  ggtitle("Annual cycle of AOU (50 m) - Point B (2002-2022)") +
  scale_x_date(date_breaks="months", date_labels="%b", name = "") +
  labs(x="Months",colour="") +
  theme_bw() +
  scale_y_continuous(name = "AOU (µmol/kg)") 

plot_AOU_prof_annual_cycle
##

#scatter plot AOU vs T
data_somlit_prof %>% 
  ggplot() +
  aes(x=T, y=oxy_umol_kg) + 
  geom_point() + 
  scale_x_continuous(name="Temp. (°C)") + 
  scale_y_continuous(name="DO (µmol/kg)") +
  ggtitle("Correlation between temperature and issolved at Point B (2002-2022)") +
  geom_smooth(method=lm) + 
  annotate(geom="text", x=22, y=125, label="slope : -1.88 ± 0.26 *", color="black")

#summary(lm(data_somlit_prof$oxy_umol_kg ~ data_somlit_prof$T))
#cor(data_somlit_prof$T, data_somlit_prof$oxy_umol_kg, method="pearson")
##

#Mean AOU by year :

data_somlit_prof <- data_somlit_prof %>% 
  group_by(year) %>% 
  mutate(mean_AOU = mean(AOU, na.rm = T))
  
data_somlit_prof %>% 
  ggplot() +
  aes(x=year, y=mean_AOU) +
  geom_point(shape = 7, size = 2, col="brown") +
  geom_line() +
  scale_x_discrete(name="", limits=c("2002" : "2022")) + 
  scale_y_continuous(name="AOU (µmol/kg)") +
  ggtitle("Mean of AOU per year (2002-2022)")




```
  
  
  
###### Trend analysis by residuals - AOU - 50m (Bates et al. 2014) :  
  
AOU : negative trend, but less than in surface  
Inverse relation between AOU and observed O~2~  
*slope : -0.37 ± 0.07 µmol/kg par année* 

```{r trend analysis AOU - 50m, echo=FALSE, warning=FALSE, message=FALSE}

## Monthly means AOU surface :
monthly_means_AOU_prof <- ungroup(data_somlit_prof) %>% 
  group_by(month) %>%
  summarise(AOU_month = mean(AOU, na.rm = TRUE))

##

## Parameters

anomalies_AOU_prof <- left_join(ungroup(data_somlit_prof), monthly_means_AOU_prof, by = "month") %>%
  mutate(AOU_ano = AOU - AOU_month)



# Regressions and tables of key parameters
var_list <- "AOU"

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_AOU_prof)
}



lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_AOU_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_prof <- reg

# Regression and table anomalies
var_list <- "AOU_ano"

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = anomalies_AOU_prof))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_AOU_prof <- reg

#reg_ano_AOU_prof 


#plot anomalies AOU surface :
plot_ano_AOU_prof <- ggplot(data = anomalies_AOU_prof, aes(x = datetime, y = AOU_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="#2C75FF", na.rm=TRUE, size = 0.8) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AOU (50 m) at Point B (2002-2022)",x="", y="AOU (µmol/kg)") +
  annotate(geom="text", x=as.POSIXct("2012-03-20"), y=80, label="slope : -0.37 ± 0.07 *", color="black")

plot_AOU_prof <- data_somlit_prof %>% 
  ggplot() + 
  aes(x=datetime, y=AOU) + 
  geom_line(col = "#01796F") + 
  ggtitle("AOU in µmol/kg at 50 m depth - Point B (2002-2022)") +
  scale_x_datetime(name="") + 
  scale_y_continuous(name="AOU (µmol/kg)")


plot_AOU_prof
plot_ano_AOU_prof

```
  
  

###### Trend analysis by moving average (decompose function) :  
  
*Quick overview of the components of the series*   
  

```{r decompose function - AOU 50m, echo=FALSE, warning=FALSE, message=FALSE}

#AOU time-series :
AOU_ts_prof <- ts(data_somlit_prof$AOU, start = c(2002,2), end = c(2022,52), freq = 52)

#type = additive because the seasonal pattern doesn't seem to increase in variation, seasonal pattern looks constant
AOU_ts_prof_decomp <- decompose(AOU_ts_prof, type = "additive")

autoplot(AOU_ts_prof_decomp) +
  xlab('')

```
  
  

→ Remove seasonality :  
  
*applying trend on the outputed series*  
  

```{r remove seasonal pattern - AOU 50m, echo=FALSE, warning=FALSE, message=FALSE}

#2 ways :
# 1 : measured values - seasonal pattern
# 2 : trend + random

AOU_ts_prof_less_season <- AOU_ts_prof_decomp$x - AOU_ts_prof_decomp$seasonal

plot_AOU_ts_prof_less_season <- autoplot(AOU_ts_prof_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU 50 m depth time series (without seasonality)") +
  geom_smooth(method=lm)

#regression AOU surface values :
reg_val_AOU_prof_less_season <- as.data.frame(plot_AOU_ts_prof_less_season$data)

model_AOU_prof_less_season <- lm(formula=y~x, data=reg_val_AOU_prof_less_season)
summary(model_AOU_prof_less_season) #pour voir les erreurs des coef + la significativité


#plot with slope value :
plot_AOU_ts_prof_less_season <- autoplot(AOU_ts_prof_less_season) + 
  xlab("") + ylab("AOU (µmol/kg)") +
  ggtitle("AOU 50 m depth time series (without seasonality)") +
  geom_smooth(method=lm) +
  annotate(geom="text", x=2013, y=57, label="slope : -0.32 ± 0.072 *", color="black")

plot_AOU_ts_prof_less_season

```


```{r notes 1, echo=FALSE, warning=FALSE, message=FALSE}

#faire comparaison temp pot, prend en compte la salinity, voit l'effet de la solubilité, il doit etre hyper dépendant des processus de solubilité et donc de TS en surface
#comme article

#papiers Laurent

#interpreter les donnees d'AOU


#temperature impactent o2. significatif, temp potentiel
#solubilité CO2 plus elevee que celle de l'o2
#hivers plus doux et plus court donc moins de penetration d'o2 dans l'ocean
```



```{r notes 2, echo=FALSE, warning=FALSE, message=FALSE}



###correction oxygen EOL :
#graph montrant uniquement la relation entre les data corrigées EOL + data Point B (oxygen)
#voir avec Samir la correction data, revoir le script, faire avec liste rotation des capteurs (mail Laurent)
#voir janvier 2018 fin 2022 entre EOL et data somlit, faire la relation linéaire



###comparaison flux CO2 Point B avec flux CO2 large (dyfamed) :
#merlivat 2018 (seanoe data pco2) dyfamed flux co2 large
#recup AT/CT pour comparer les 2 periodes
#faire avec data pco2 atmos + vents de azur + pco2 data recup sur seanoe (carioca = large) + laurent envoie les 2 dernieres années (2020-2021)


###comparaison tendances temperature EOL vs autres bouées :
#coriolis cotier : autres series temp autres sites, au moins temperature (solemio, sète, sola, poeme)
#comparer les series + tendances sur une mm periode




```







