---
title: 'SOMLIT : nb de mesure /mois régulier'
author: "Mégane"
date: "2023-04-17"
output: html_document
---


```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
library("ggExtra")
library("corrplot")
library("ggcorrplot")
library("marelac")
library("kableExtra")
library("stringr")
library("berryFunctions")
library("hms")
```

## Importation data carbo chemistry (Point B SOMLIT) : 2007-2022 complete

```{r importation data pCO2 water, echo=FALSE, warning=FALSE, message=FALSE}

###Importation des donnees
##Data pCO2 water
#a partir de janvier 2007 jusqu'a janvier 2023

SOMLIT_carbo_chemistry <- read_delim("../Data/DATA_SOMLIT_07-23.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#on retire les data 2023 pour avoir les annees completes sur 2007-2022 :
SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry[-c(1622:1631),]

#creation variables Year.Month (omit the day) :
SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(Year.Month = format(sampling_date, format="%Y-%m"),
         Year.Month = as.POSIXct(paste(Year.Month, "-01", sep = ""), format = "%Y-%m-%d"))




#MAJ year + month (NAs)
SOMLIT_carbo_chemistry$year <- substr(SOMLIT_carbo_chemistry$sampling_date, 1, 4) 
SOMLIT_carbo_chemistry$year <- as.numeric(SOMLIT_carbo_chemistry$year)

SOMLIT_carbo_chemistry$month <- format(SOMLIT_carbo_chemistry$sampling_date, format = "%m")
SOMLIT_carbo_chemistry$month <- as.numeric(SOMLIT_carbo_chemistry$month)
##

```

### **Clean-up**  
  
```{r cleanup, echo=FALSE, warning=FALSE, message=FALSE}

#suppression lignes NA :
SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry[-c(784, 818, 827, 866, 873, 884, 961, 978, 989, 1032, 1047, 1062, 1105,
                                                    1112, 1135, 1142, 1153),]
#1604 obs
##
surf <- SOMLIT_carbo_chemistry %>% 
  dplyr::filter(depth==0)

prof <- SOMLIT_carbo_chemistry %>% 
  dplyr::filter(depth==50)

#2 obs de diff
##

#ajout de 2 obs 50m : 2007-07-24 & 2014-09-30

SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 58, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2007-07-24"),
         depth = str_replace(depth, "NA", "50"))

SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 804, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2014-09-30"),
         depth = str_replace(depth, "NA", "50"))
##

#suplementary MAJ

#ajout row 2021-09-21 for 50m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1490, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2021-09-21"),
         depth = str_replace(depth, "NA", "50"))

#ajout row 2022-05-10 for 0m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1547, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2022-05-10"),
         depth = str_replace(depth, "NA", "0"))
##

#ajout row 2021-08-10 for 50m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1480, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2021-08-10"),
         depth = str_replace(depth, "NA", "50"))

#ajout row 2021-08-17 for 50m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1482, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2021-08-17"),
         depth = str_replace(depth, "NA", "50"))
##

#ajout row 2022-05-17 for 0m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1551, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2022-05-17"),
         depth = str_replace(depth, "NA", "0"))

#ajout row 2022-05-24 for 0m
SOMLIT_carbo_chemistry <- insertRows(SOMLIT_carbo_chemistry, 1553, new = NA)

SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = str_replace_na(sampling_date, replacement = "NA"),
         depth = str_replace_na(depth, replacement = "NA")) %>% 
  mutate(sampling_date = str_replace(sampling_date, "NA", "2022-05-24"),
         depth = str_replace(depth, "NA", "0"))
##
#804 obs for 0m & 804 obs for 50m

#format date in POSIXct
SOMLIT_carbo_chemistry <- SOMLIT_carbo_chemistry %>% 
  mutate(sampling_date = as.POSIXct(sampling_date))



#MAJ year + month (NAs)
SOMLIT_carbo_chemistry$year <- substr(SOMLIT_carbo_chemistry$sampling_date, 1, 4) 
SOMLIT_carbo_chemistry$year <- as.numeric(SOMLIT_carbo_chemistry$year)

SOMLIT_carbo_chemistry$month <- format(SOMLIT_carbo_chemistry$sampling_date, format = "%m")
SOMLIT_carbo_chemistry$month <- as.numeric(SOMLIT_carbo_chemistry$month)
##

```




### **Nombre de mesures SOMLIT par mois**  
  

```{r Nombre de mesures SOMLIT par mois with outliers, echo=FALSE, warning=FALSE, message=FALSE}

#number of measure by year :
Nb_by_year <- summarise(group_by(SOMLIT_carbo_chemistry, year), NB_OBS_Y=n()) 
# must be 104 or 106

#number of measure by month by year :
Nb_by_month <- summarise(group_by(SOMLIT_carbo_chemistry, Year.Month), NB_OBS_M=n()) 
#must be 8 or 10

#POSIXct format :
Nb_by_month <- Nb_by_month %>% 
  mutate(Year.Month = as.POSIXct(paste(Year.Month, "-01", sep = ""), format = "%Y-%m-%d"))


#plot number of measure by month (2007-2022)
Nb_by_month %>% 
  ggplot() +
  aes(x=Year.Month, y=NB_OBS_M) +
  geom_line(group=1) + 
  scale_x_datetime(name="", date_breaks = "2 years", labels = year) + 
  scale_y_continuous(name="", n.breaks = 6 ) +
  ggtitle("Evolution of number of observations by month at Point B (2007-2022)")
  

```

### **Nombre de mesures SOMLIT par mois (without outliers)**  
  


→ Le nombre de mesures par mois varie principalement entre 8 et 10 mesures/mois   
  
Parfois : nombre de mesures par mois inférieur à 8  
Il faudra donc rajouter manuellement une mesure (NA)  
  
  
**Nombre de mesures par mois < 8**  
  
→ 19 months concerned  
  
```{r filtre inf 8, echo=FALSE, warning=FALSE, message=FALSE}

#filter les valeurs dans Nb_by_month < 8

inf_8 <- which(Nb_by_month$NB_OBS_M < 8)
inf_8_dates <- format(Nb_by_month$Year.Month[inf_8], format="%Y-%m")
inf_8_dates
##


```

#### *Measure SOMLIT every tuesday*  
  
→ Fill in the gaps: adding lines  
  

```{r ajout de lignes - part 1, echo=FALSE, warning=FALSE, message=FALSE}

#test <- SOMLIT_carbo_chemistry %>% complete(., week, month, year)

#creation d'une fonction qui compte le nombre de mardi par mois et par annee :
countTuesday <- function(y, m) { 
  fr <- as.Date(paste(y, m, "01", sep="-")) 
  to <- fr + 31       
  dt <- seq(fr, to, by="1 day")      
  df <- data.frame(date=dt, mon=as.POSIXlt(dt)$mon, wday=as.POSIXlt(dt)$wday)  
  df <- subset(df, df$wday==2 & df$mon==df[1,"mon"])         
  return(nrow(df))
}

#creation matrix, 12 lignes pour 12 mois, 16 colonnes pour 16 annees (2077-2022)
number_of_tuesday <- matrix(nrow = 12, ncol = 16)

#creation de la boucle :

for (i in 2007:2022) {
  for (j in 1:12) {
    number_of_tuesday[j,(i-2006)] <- countTuesday(i, j)
  }
}


#nb observations attendues : number_of_tuesday = 4 or 5 measures by month
#ColSums : 52 or 53 measures by year
#sum(ColSums) : dans tout le dataset (x2 because 0 & 50m) = 1670
print(paste("Lenght of table expected :", sum(colSums(number_of_tuesday))*2))

##

#creation dataset nb de mardi / mois et / annee de SOMLIT (= obs)
table_avg_dataset <-
  table(SOMLIT_carbo_chemistry$year, SOMLIT_carbo_chemistry$month)/2 

#transpose (changement des colonnes en lignes)
table_avg_dataset <- table_avg_dataset %>% as.matrix.data.frame() %>% t()



#creation dataset nb de mardi /mois et /annee theorique (=theo)
comparison_table <- matrix(nrow = 12, ncol = 16)

##

#comparaison des 2 datasets (theo vs obs), si difference = alors manque une observation chez SOMLIT ("!")

for (i in 1:16) {
  for (j in 1:12) {
    if (table_avg_dataset[j,i] - number_of_tuesday[j,i] == 0) { comparison_table[j,i] = 0} 
    else if (number_of_tuesday[j,i] - table_avg_dataset[j,i] == 1) { comparison_table[j,i] = 1} 
    else if (number_of_tuesday[j,i] - table_avg_dataset[j,i] == 2) { comparison_table[j,i] = 2}
    else if (number_of_tuesday[j,i] - table_avg_dataset[j,i] == 3) { comparison_table[j,i] = 3}
    else if (number_of_tuesday[j,i] - table_avg_dataset[j,i] == 4) { comparison_table[j,i] = 4}
    else {comparison_table[j,i] = 0}
  }
}

comparison_table #each number corresponds to one or more missing value 

```


```{r ajout de lignes - part 2, echo=FALSE, warning=FALSE, message=FALSE}

#creation d'une liste (sac), contenant 16 autres listes (nb annee), contenant elles-meme 12 listes
missing_data <- list(vector("list", 12), vector("list", 12), vector("list", 12), 
                     vector("list", 12), vector("list", 12), vector("list", 12), 
                     vector("list", 12), vector("list", 12), vector("list", 12), 
                     vector("list", 12), vector("list", 12), vector("list", 12), 
                     vector("list", 12), vector("list", 12), vector("list", 12), 
                     vector("list", 12))

#creation d'une boucle : pour chaque valeur manquante ("!")
#creation d'une ligne contenant le year + le month du year et month contenant la data manquante

for (i in 1:16) {
  for (j in 1:12) {
    if (comparison_table[j,i] == 1) {
      missing_data[[i]][[j]] <- data.frame(year = i, month = j)}
    else if (comparison_table[j,i] == 2) {
      missing_data[[i]][[j]] <- data.frame(year = rep(i,2), month = rep(j,2)) }
      else if (comparison_table[j,i] == 3) {
        missing_data[[i]][[j]] <- data.frame(year = rep(i,3), month = rep(j,3)) }
    else {
      missing_data[[i]][[j]] <- data.frame(year = NA, month = NA) }
  }
}

#rajout colonne depth, alternance entre 0 et 50
#repetition 0,50 44 fois
missing_data <- missing_data %>% bind_rows() %>% na.omit()
missing_data <- data.frame(missing_data, depth = rep(c(0,50), each = 31))

#remplacement des termes 
#annee
missing_data$year[missing_data$year == 1] = "2007"
missing_data$year[missing_data$year == 2] = "2008"
missing_data$year[missing_data$year == 3] = "2009"
missing_data$year[missing_data$year == 4] = "2010"
missing_data$year[missing_data$year == 5] = "2011"
missing_data$year[missing_data$year == 6] = "2012"
missing_data$year[missing_data$year == 7] = "2013"
missing_data$year[missing_data$year == 8] = "2014"
missing_data$year[missing_data$year == 9] = "2015"
missing_data$year[missing_data$year == 10] = "2016"
missing_data$year[missing_data$year == 11] = "2017"
missing_data$year[missing_data$year == 12] = "2018"
missing_data$year[missing_data$year == 13] = "2019"
missing_data$year[missing_data$year == 14] = "2020"
missing_data$year[missing_data$year == 15] = "2021"
missing_data$year[missing_data$year == 16] = "2022"

#mois
missing_data$month[missing_data$month == 1] = "1"
missing_data$month[missing_data$month == 2] = "2"
missing_data$month[missing_data$month == 3] = "3"
missing_data$month[missing_data$month == 4] = "4"
missing_data$month[missing_data$month == 5] = "5"
missing_data$month[missing_data$month == 6] = "6"
missing_data$month[missing_data$month == 7] = "7"
missing_data$month[missing_data$month == 8] = "8"
missing_data$month[missing_data$month == 9] = "9"
missing_data$month[missing_data$month == 10] = "10"
missing_data$month[missing_data$month == 11] = "11"
missing_data$month[missing_data$month == 12] = "12"

missing_data$temperature = 999999

#merge nouvelle table avec SOMLIT
SOMLIT_carbo_chemistry_missing_value <- merge(SOMLIT_carbo_chemistry, missing_data, 
                                              by = c("year", "month", "depth", "temperature"), all = T)

SOMLIT_carbo_chemistry_missing_value$temperature[SOMLIT_carbo_chemistry_missing_value$temperature == 999999] = NA


#new tab complete :
SOMLIT_carbo_chemistry_missing_value = SOMLIT_carbo_chemistry_missing_value %>% arrange(year, month, sampling_date)

#verification for both depths
table(SOMLIT_carbo_chemistry_missing_value$year, SOMLIT_carbo_chemistry_missing_value$depth)

###########################

#rajout des dates manquantes manuellement :
SOMLIT_carbo_chemistry_missing_value[c(9,10),"sampling_date"] <- "2007-01-02"
SOMLIT_carbo_chemistry_missing_value[c(103,104),"sampling_date"] <- "2007-09-11"
SOMLIT_carbo_chemistry_missing_value[c(765,766),"sampling_date"] <- "2014-12-30"
SOMLIT_carbo_chemistry_missing_value[c(825,826),"sampling_date"] <- "2014-08-12"
SOMLIT_carbo_chemistry_missing_value[c(869,870),"sampling_date"] <- "2015-12-29"
SOMLIT_carbo_chemistry_missing_value[c(929,930),"sampling_date"] <- "2015-08-18"
SOMLIT_carbo_chemistry_missing_value[c(973,974),"sampling_date"] <- "2016-12-27"

SOMLIT_carbo_chemistry_missing_value[c(1009,1010),"sampling_date"] <- "2016-05-31"
SOMLIT_carbo_chemistry_missing_value[c(1037,1038),"sampling_date"] <- "2016-08-09"
SOMLIT_carbo_chemistry_missing_value[c(1081,1082),"sampling_date"] <- "2017-12-26"
SOMLIT_carbo_chemistry_missing_value[c(1089,1090),"sampling_date"] <- "2017-02-28"
SOMLIT_carbo_chemistry_missing_value[c(1143,1144),"sampling_date"] <- "2017-08-15"
SOMLIT_carbo_chemistry_missing_value[c(1171,1172),"sampling_date"] <- "2018-10-30"
SOMLIT_carbo_chemistry_missing_value[c(1187,1188),"sampling_date"] <- "2018-12-25"
SOMLIT_carbo_chemistry_missing_value[c(1211,1212),"sampling_date"] <- "2018-04-10"
SOMLIT_carbo_chemistry_missing_value[c(1247,1248),"sampling_date"] <- "2018-08-14"
SOMLIT_carbo_chemistry_missing_value[c(1293,1294),"sampling_date"] <- "2019-12-31"
SOMLIT_carbo_chemistry_missing_value[c(1353,1354),"sampling_date"] <- "2019-08-13"

SOMLIT_carbo_chemistry_missing_value[c(1395,1396),"sampling_date"] <- "2020-12-29"
SOMLIT_carbo_chemistry_missing_value[c(1409,1410),"sampling_date"] <- "2020-03-17"
SOMLIT_carbo_chemistry_missing_value[c(1411,1412),"sampling_date"] <- "2020-03-24"
SOMLIT_carbo_chemistry_missing_value[c(1413,1414),"sampling_date"] <- "2020-03-31"
SOMLIT_carbo_chemistry_missing_value[c(1417,1418),"sampling_date"] <- "2020-04-07"
SOMLIT_carbo_chemistry_missing_value[c(1419,1420),"sampling_date"] <- "2020-04-14"
SOMLIT_carbo_chemistry_missing_value[c(1421,1422),"sampling_date"] <- "2020-04-28"
SOMLIT_carbo_chemistry_missing_value[c(1489,1490),"sampling_date"] <- "2021-11-16"
SOMLIT_carbo_chemistry_missing_value[c(1491,1492),"sampling_date"] <- "2021-11-30"
SOMLIT_carbo_chemistry_missing_value[c(1585,1586),"sampling_date"] <- "2022-10-18"
SOMLIT_carbo_chemistry_missing_value[c(1603,1604),"sampling_date"] <- "2022-12-27"
SOMLIT_carbo_chemistry_missing_value[c(1499,1500),"sampling_date"] <- "2021-12-28"
SOMLIT_carbo_chemistry_missing_value[c(1577,1578),"sampling_date"] <- "2022-01-04"
##

#MAJ variable Year.Month

SOMLIT_carbo_chemistry_missing_value <- SOMLIT_carbo_chemistry_missing_value %>% 
  select(-c(year, month)) %>% 
  mutate(Year = format(sampling_date, format="%Y"),
         Month = format(sampling_date, format="%m"),
         Year.Month = format(sampling_date, format="%Y-%m"))
##
SOMLIT_carbo_chemistry_missing_value <- SOMLIT_carbo_chemistry_missing_value[,c(3, 1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
                                                                                21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39)]
SOMLIT_carbo_chemistry_missing_value <- SOMLIT_carbo_chemistry_missing_value %>% arrange(sampling_date)



```


```{r ajout MAJ pangaea, echo=FALSE, warning=FALSE, message=FALSE}

#ajout maj Pangaea (mail Samir) : 
new_SOMLIT <- read_csv("../Data/SOMLIT_MAJ_Samir.csv") %>% mutate(depth = str_replace(depth, "1", "0"))

new_one <- left_join(SOMLIT_carbo_chemistry_missing_value, new_SOMLIT, by=c("sampling_date","depth"))


new_one <- new_one %>% 
  mutate(temperature.x = str_replace_na(temperature.x, replacement = "NA"),
         temperature.y = str_replace_na(temperature.y, replacement = "NA"),
         temperature = case_when(temperature.x == "NA" ~ temperature.y, TRUE ~ temperature.x),
         temperature = as.numeric(temperature),
         salinity.x = str_replace_na(salinity.x, replacement = "NA"),
         salinity.y = str_replace_na(salinity.y, replacement = "NA"),
         salinity = case_when(salinity.x == "NA" ~ salinity.y, TRUE ~ salinity.x),
         salinity = as.numeric(salinity),
         ta.x = str_replace_na(ta.x, replacement = "NA"),
         ta.y = str_replace_na(ta.y, replacement = "NA"),
         ta = case_when(ta.x == "NA" ~ ta.y, TRUE ~ ta.x),
         ta = as.numeric(ta),
         dic.x = str_replace_na(dic.x, replacement = "NA"),
         dic.y = str_replace_na(dic.y, replacement = "NA"),
         dic = case_when(dic.x == "NA" ~ dic.y, TRUE ~ dic.x),
         dic = as.numeric(dic),
         pH_insi.x = str_replace_na(pH_insi.x, replacement = "NA"),
         pH_insi.y = str_replace_na(pH_insi.y, replacement = "NA"),
         pH_insi = case_when(pH_insi.x == "NA" ~ pH_insi.y, TRUE ~ pH_insi.x),
         pH_insi = as.numeric(pH_insi),
         CSC_flag.x = str_replace_na(CSC_flag.x, replacement = "NA"),
         CSC_flag.y = str_replace_na(CSC_flag.y, replacement = "NA"),
         CSC_flag = case_when(CSC_flag.x == "NA" ~ CSC_flag.y, TRUE ~ CSC_flag.x),
         CSC_flag = as.numeric(CSC_flag),
         fCO2.x = str_replace_na(fCO2.x, replacement = "NA"),
         fCO2.y = str_replace_na(fCO2.y, replacement = "NA"),
         fCO2 = case_when(fCO2.x == "NA" ~ fCO2.y, TRUE ~ fCO2.x),
         fCO2 = as.numeric(fCO2),
         pCO2.x = str_replace_na(pCO2.x, replacement = "NA"),
         pCO2.y = str_replace_na(pCO2.y, replacement = "NA"),
         pCO2 = case_when(pCO2.x == "NA" ~ pCO2.y, TRUE ~ pCO2.x),
         pCO2 = as.numeric(pCO2),
         HCO3.x = str_replace_na(HCO3.x, replacement = "NA"),
         HCO3.y = str_replace_na(HCO3.y, replacement = "NA"),
         HCO3 = case_when(HCO3.x == "NA" ~ HCO3.y, TRUE ~ HCO3.x),
         HCO3 = as.numeric(HCO3),
         CO3.x = str_replace_na(CO3.x, replacement = "NA"),
         CO3.y = str_replace_na(CO3.y, replacement = "NA"),
         CO3 = case_when(CO3.x == "NA" ~ CO3.y, TRUE ~ CO3.x),
         CO3 = as.numeric(CO3),
         OmegaAragonite.x = str_replace_na(OmegaAragonite.x, replacement = "NA"),
         OmegaAragonite.y = str_replace_na(OmegaAragonite.y, replacement = "NA"),
         OmegaAragonite = case_when(OmegaAragonite.x == "NA" ~ OmegaAragonite.y, TRUE ~ OmegaAragonite.x),
         OmegaAragonite = as.numeric(OmegaAragonite),
         OmegaCalcite.x = str_replace_na(OmegaCalcite.x, replacement = "NA"),
         OmegaCalcite.y = str_replace_na(OmegaCalcite.y, replacement = "NA"),
         OmegaCalcite = case_when(OmegaCalcite.x == "NA" ~ OmegaCalcite.y, TRUE ~ OmegaCalcite.x),
         OmegaCalcite = as.numeric(OmegaCalcite))


new_one <- new_one %>% 
  select(sampling_date, depth, temperature, salinity, ta, dic, NO2, NO3, Chla, pH_s_somlit_temp_25, pH_s_somlit_temp_insi, 
         diff_pH, pH_insi, Pt, Sit, quarter, monthd, week, CSC_flag, Patm, P, pH_calc, CO2, fCO2, pCO2, fCO2pot, pCO2pot, 
         fCO2insitu, pCO2insitu, HCO3, CO3, OmegaAragonite, OmegaCalcite, Nta, Ndic, pH18, Year.Month, Year, Month)


```

```{r pH calcultations, echo=FALSE, warning=FALSE, message=FALSE}

###############################################################
#part pH :
#pH calc (fonction carb with ta & dic)
#flag15 = alk & dic

new_one$depth <- as.numeric(new_one$depth)

new_one_drop_na <- new_one %>% 
  tidyr::drop_na(salinity, temperature, ta, dic)

carb <- seacarb::carb(flag=15, var1=new_one_drop_na$ta*1e-6, var2=new_one_drop_na$dic*1e-6,
             S=new_one_drop_na$salinity, T=new_one_drop_na$temperature, P=new_one_drop_na$depth/10,
             Pt=1e-6*new_one_drop_na$Pt, Sit=1e-6*new_one_drop_na$Sit, 
             k1k2 = "l", kf = "pf", pHscale = "T", b="l10")

pH_meg <- data.frame(sampling_date=new_one_drop_na$sampling_date, depth=carb$P*10 ,pH_calc_meg=carb$pH)

new_one_drop_na <- new_one_drop_na %>% select("sampling_date")

carb_date <- cbind(new_one_drop_na, carb) %>% mutate(depth=P*10)
  
new_one <- left_join(new_one, carb_date, by=c("sampling_date","depth"))
##

#pH18 calculation (fonction pHinsi) :
#pH normalized (without temperature effect)

new_one_drop_na_2 <- new_one %>% 
  tidyr::drop_na(salinity, temperature, ta, pH)

pHat18 <- seacarb::pHinsi(pH=new_one_drop_na_2$pH, ALK=new_one_drop_na_2$ta*1e-6, Tinsi=18,
                            Tlab=new_one_drop_na_2$temperature, S=new_one_drop_na_2$salinity,
                            Pt=1e-6*new_one_drop_na_2$Pt, Sit=1e-6*new_one_drop_na_2$Sit,
                            k1k2 = "l", kf = "pf", pHscale = "T")

pH_18_meg <- data.frame(sampling_date=carb_date$sampling_date, depth=carb_date$P*10 ,pH_18=pHat18)

new_one <- left_join(new_one, pH_18_meg, by=c("sampling_date","depth"))

#sorting data :

new_one <- new_one %>% 
  mutate(temperature = case_when(temperature == NA_real_ ~ T, TRUE ~ temperature),
         salinity = case_when(salinity == NA_real_ ~ S, TRUE ~ salinity),
         ta = case_when(ta == NA_real_ ~ ALK, TRUE ~ ta),
         dic = case_when(dic == NA_real_ ~ DIC, TRUE ~ dic),
         Patm = case_when(Patm.x == NA_real_ ~ Patm.y, TRUE ~ Patm.x),
         P = case_when(P.x == NA_real_ ~ P.y, TRUE ~ P.x),
         pH_calc = case_when(pH_calc == NA_real_ ~ pH, TRUE ~ pH_calc),
         CO2 = case_when(CO2.x == NA_real_ ~ CO2.y, TRUE ~ CO2.x),
         fCO2 = case_when(fCO2.x == NA_real_ ~ fCO2.y, TRUE ~ fCO2.x),
         pCO2 = case_when(pCO2.x == NA_real_ ~ pCO2.y, TRUE ~ pCO2.x),
         fCO2pot = case_when(fCO2pot.x == NA_real_ ~ fCO2pot.y, TRUE ~ fCO2pot.x),
         pCO2pot = case_when(pCO2pot.x == NA_real_ ~ pCO2pot.y, TRUE ~ pCO2pot.x),
         fCO2insitu = case_when(fCO2insitu.x == NA_real_ ~ fCO2insitu.y, TRUE ~ fCO2insitu.x),
         pCO2insitu = case_when(pCO2insitu.x == NA_real_ ~ pCO2insitu.y, TRUE ~ pCO2insitu.x),
         HCO3 = case_when(HCO3.x == NA_real_ ~ HCO3.y, TRUE ~ HCO3.x),
         CO3 = case_when(CO3.x == NA_real_ ~ CO3.y, TRUE ~ CO3.x),
         OmegaAragonite = case_when(OmegaAragonite.x == NA_real_ ~ OmegaAragonite.y, TRUE ~ OmegaAragonite.x),
         OmegaCalcite = case_when(OmegaCalcite.x == NA_real_ ~ OmegaCalcite.y, TRUE ~ OmegaCalcite.x),
         pH_18 = case_when(pH18 == NA_real_ ~ pH_18, TRUE ~ pH18))


new_one <- new_one %>% 
  select(c("sampling_date", "depth", "temperature", "salinity", "ta", "dic", "NO2", "NO3", "Chla", "pH_s_somlit_temp_25",
           "pH_s_somlit_temp_insi", "diff_pH", "pH_insi", "Pt", "Sit", "quarter", "monthd", "week", "Patm", "P", "pH_calc",
           "CO2", "fCO2", "pCO2", "fCO2pot", "pCO2pot", "fCO2insitu", "pCO2insitu", "HCO3", "CO3", "OmegaAragonite", "OmegaCalcite",
           "pH_18", "Nta", "Ndic", "Year.Month", "Year", "Month"))



#save :
#write.table(new_one, "DATA_SOMLIT_07-23_CLEAN.csv", sep=";", col.names = TRUE, row.names = FALSE)


```



  
### Raw data EOL (seanoe) : sept.2013 - october.2022   
  
Frequency : hourly  
  
→ oxygen in ml/l convert into micromol/kg  
  
```{r importation data EOL raw + convert into umol/kg, echo=FALSE, warning=FALSE, message=FALSE}

#from sept. 2013 to oct. 2022
#stop at october 2022
#oxygen in mll/l

data_EOL_raw <- read_csv("../Data/SEANOE_EOL.csv", 
    col_types = cols(...1 = col_skip()))


#conversion des valeurs ml/l en umol/kg (voire protocole oxygene SOMLIT)
# *44.66 -> mmol/m3 ou umol/l
# densite eau de mer = 1030 kg/m3 = 1.030 kg/l
#ici, utilisation de rho, package seacarb pour calcul de la densité
#rho/1000 pour avoir en kg/l
# 44.66/rho = convert_o2
# ml/l * convert_o2 -> umol/kg

#creation des 2 variables
SW_density <- rho(S = data_EOL_raw$sal_eol_psu, T=data_EOL_raw$temp_eol_c, P=0)/1000
convert_o2 <- 44.66/SW_density

#creation colonne o2 converti en umol/kg
data_EOL <- data_EOL_raw %>% 
  mutate(oxy_umol_kg = oxy_eol_mll*convert_o2) %>% 
  select(-oxy_eol_mll)

```

### Data EOL + import data end 2022 until march 2023  
  

```{r, import data samir, echo=FALSE, warning=FALSE, message=FALSE}

#new data EOL :
#from nov. 2022 to march 2023 
#frequency : every 30 min 
#month of december 2022 is missing
#oxygen in micromol/kg

EOL_22 <- read_delim("../Data/temp_CTD_EOL_nov22_mar23.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

EOL_22 <- EOL_22 %>% 
  mutate(month = case_when(month == "Nov" ~ "11",
                           month == "Jan" ~ "01",
                           month == "Feb" ~ "02",
                           month == "Mar" ~ "03", TRUE ~ ""))
EOL_22$month <- as.character(EOL_22$month)
EOL_22$hour <- as.character(EOL_22$hour)
EOL_22$year <- as.character(EOL_22$year)
EOL_22$day <- as.character(EOL_22$day)

# EOL_22 <- EOL_22 %>%
#   mutate(day = str_replace_all(day, c("1"="01", "2"="02", "3"="03", "4"="04", "5"="05",
#                                        "6"="06", "7"="07", "8"="08", "9"="09")))
##

#creation heures pleines + moyenne data 30min per hour :

test <- EOL_22 %>% 
  mutate(HH = substr(hour, 1,2),
         HH = paste(HH, "00:00", sep=":"))

test <- test %>% 
  group_by(HH) %>% 
  mutate(moy_oxy = mean(oxygen_umol_kg),
         moy_sal = mean(salinity),
         moy_temp = mean(temperature))
##

#clean :
EOL_22 <- test %>% 
  unite(col='datetime', c('year', 'month', 'day'), sep='-') %>% 
  unite(col='datetime', c('datetime', 'HH'), sep=' ') %>% 
  rename(temp_eol_c = moy_temp, sal_eol_psu = moy_sal, oxy_umol_kg = moy_oxy) %>% 
  select(datetime, temp_eol_c, sal_eol_psu, oxy_umol_kg)

EOL_22 <- distinct(EOL_22)

EOL_22 <- EOL_22 %>% 
  mutate(datetime = as.POSIXct(datetime))

##


#data from nov. 2022 to march 2023 (seafet)
#selection of december only for temperature :

EOL_seafet_22 <- read_csv("../Data/temp_SEAFET_EOL_nov22_mar23.csv", 
    col_types = cols(...1 = col_skip())) %>% 
  dplyr::filter(format(datetime, format="%m") == "12") %>% 
  rename(temp_eol_c = T_seaF_sf)


EOL_seafet_22 <- data.frame(datetime = EOL_seafet_22$datetime, 
                            temp_eol_c = EOL_seafet_22$temp_eol_c,
                            sal_eol_psu = NA,
                            oxy_umol_kg = NA)     

EOL_seafet_22$sal_eol_psu <- as.numeric(EOL_seafet_22$sal_eol_psu)
EOL_seafet_22$oxy_umol_kg <- as.numeric(EOL_seafet_22$oxy_umol_kg)

```

### Merge of Data EOL (temperature + salinity complete)  
  

```{r data EOL complete : for salinity the 01/11/2022, echo=FALSE, warning=FALSE, message=FALSE}

EOL_01_11_22 <- read_delim("../Data/EOL_01_11_22.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  unite(col='datetime', c('year', 'month', 'day'), sep='-') %>%
  unite(col='datetime', c('datetime', 'hour'), sep=' ') %>% 
  select(datetime, salinity) #je sais pas ce que c'est ?
##

#merge data_EOL with EOL_2022 and EOL_seafet_22 (december) to have complete series :
data_EOL_complete <- rbind(data_EOL, EOL_22) #december 2022 is missing

#addition of december 2022 only for temperature :
data_EOL_complete <- rbind(data_EOL_complete, EOL_seafet_22)
data_EOL_complete <- data_EOL_complete %>% arrange(datetime) #probleme avec les heures en 2022

#missing of 2 weeks in october 2022

#save :
#write.table(data_EOL_complete, "EOL_raw_complete_1323.csv", sep=";", col.names = TRUE, row.names = FALSE)

##

```




#### **Number of measurements EOL**  
  
- per year :  
  

```{r Number of measurements EOL - per year, echo=FALSE, warning=FALSE, message=FALSE}

#creation variables + number of days in the month (dMonth) :
data_EOL_complete <- data_EOL_complete %>%
  mutate(Year = format(datetime, format="%Y"),
         Month = format(datetime, format="%m"),
         Year.Month = format(datetime, format="%Y-%m"),
         Year.Month.Day = format(datetime, format="%Y-%m-%d"),
         dMonth = days_in_month(datetime),
         datetime = as.POSIXct(datetime),
         Hour = format(datetime, format="%H:%M:%S"),
         datetime = format(datetime, format="%Y-%m-%d"))


#number of measure/year :
Nb_by_year <- summarise(group_by(data_EOL_complete, Year), NB_OBS_Y=n()) 


#plot number of measure/year (2013-2022)
Nb_by_year %>% 
  ggplot() +
  aes(x=Year, y=NB_OBS_Y) +
  geom_point() +
  geom_line(group=1) + 
  scale_x_discrete(name="") + 
  scale_y_continuous(name="") +
  ggtitle("Evolution of number of observations per year - EOL (sept.2013 - march.2023)")

```
- per month :  
  

```{r Number of measurements EOL - per month, echo=FALSE, warning=FALSE, message=FALSE}

#number of measure/month :
Nb_by_month <- summarise(group_by(data_EOL_complete, Year.Month), NB_OBS_M=n()) 

Nb_by_month <- Nb_by_month %>% 
  mutate(Year.Month = as.Date(paste(Year.Month, "-01", sep = ""), format = "%Y-%m-%d"))


#plot number of measure/month (2007-2022)
Nb_by_month %>% 
  ggplot() +
  aes(x=Year.Month, y=NB_OBS_M) +
  geom_point() +
  geom_line(group=1) + 
  scale_x_date(name="") + 
  scale_y_continuous(name="") +
  ggtitle("Evolution of number of observations per month- EOL (sept.2013 - march.2023)")
```

- per day :  
  
*Data every hour since oct. 2017*  
```{r Number of measurements EOL - per day, echo=FALSE, warning=FALSE, message=FALSE}

#number of measure/month :
Nb_by_day <- summarise(group_by(data_EOL_complete, Year.Month.Day), NB_OBS_M=n()) 


Nb_by_day <- Nb_by_day %>% 
  mutate(Year.Month.Day = as.Date(Year.Month.Day))
         


#plot number of measure/month (2007-2022)
Nb_by_day %>% 
  ggplot() +
  aes(x=Year.Month.Day, y=NB_OBS_M) +
  geom_point() +
  geom_line(group=1) + 
  scale_x_date(name="") + 
  scale_y_continuous(name="") +
  ggtitle("Evolution of number of observations per day- EOL (sept.2013 - march.2023)")

```

*A partir de 2017 :*
*Faire d'abord 1 data/jour à 09h, tous les jours (EOL 1)*

*Faire ensuite 2 data/jour : 09h et 16h ? tous les jours (EOL 2)*

*Faire toutes les heures, tous les jours (EOL 3)*  
  
  
  

### *Measure EOL : one per day (at 8 or 9 or 10AM)*  
  

```{r Measure EOL : one per day (morning), echo=FALSE, warning=FALSE, message=FALSE}

EOL_test1 <- data_EOL_complete %>% 
  filter(Year >= 2017) %>% 
  filter(Hour == "08:00:00" | Hour == "09:00:00" | Hour == "10:00:00") %>% 
  group_by(datetime) %>% 
  mutate(NB_OBS_DAY = n())

EOL_test1 <- EOL_test1 %>% mutate(cond = case_when(NB_OBS_DAY > 1 ~ "TRUE", TRUE ~ "FALSE"))

tab1 <- EOL_test1 %>% filter(cond=="FALSE")
tab2 <- EOL_test1 %>% filter(cond=="TRUE") %>% filter(Hour == "08:00:00")

#tableau clean
EOL_1 <- full_join(tab1, tab2) %>% 
  group_by(datetime) %>% 
  mutate(NB_OBS_DAY = n()) %>% 
  select(datetime, Hour, temp_eol_c, sal_eol_psu, oxy_umol_kg, Year, Month, Year.Month, Year.Month.Day, dMonth, NB_OBS_DAY)

#save :
#write.table(EOL_1, "EOL_17-22_1perday_morning.csv", sep=";", col.names = TRUE, row.names = FALSE)


```


### *Measure EOL : twice per day (at 8AM and 4PM)*  
  

```{r Measure EOL : 2 per day (morning & afternoon), echo=FALSE, warning=FALSE, message=FALSE}

EOL_test2 <- data_EOL_complete %>% 
  filter(Year >= 2017) %>% 
  filter(Hour == "08:00:00" | Hour == "09:00:00" | Hour == "10:00:00" | Hour == "16:00:00")
  

EOL_test2 <- EOL_test2 %>% group_by(datetime) %>% filter(Hour == "08:00:00" | Hour == "16:00:00") %>%
  mutate(NB_OBS_DAY = n())

EOL_test2 <- EOL_test2 %>% mutate(cond = case_when(NB_OBS_DAY > 1 ~ "TRUE", TRUE ~ "FALSE"))
EOL_test2 <- EOL_test2 %>% filter(cond=="TRUE")


#tableau clean
EOL_2 <- EOL_test2 %>%
  select(datetime, Hour, temp_eol_c, sal_eol_psu, oxy_umol_kg, Year, Month, Year.Month, Year.Month.Day, dMonth, NB_OBS_DAY)


#save :
#write.table(EOL_2, "EOL_17-22_2perday_morning_afternoon.csv", sep=";", col.names = TRUE, row.names = FALSE)


```


### *Measure EOL : 23 per day (hourly)*  
  

```{r Measure EOL : 23 per day (hourly), echo=FALSE, warning=FALSE, message=FALSE}

EOL_test3 <- data_EOL_complete %>% 
  dplyr::filter(Year >= 2017) %>% 
  group_by(datetime) %>% 
  mutate(NB_OBS_DAY = n()) # 1 to 24 obs per day


EOL_test3 <- EOL_test3 %>% mutate(cond = case_when(NB_OBS_DAY >= 23 ~ "TRUE", TRUE ~ "FALSE"))
EOL_test3 <- EOL_test3 %>% dplyr::filter(cond=="TRUE")


#tableau clean
EOL_3 <- EOL_test3 %>%
  select(datetime, Hour, temp_eol_c, sal_eol_psu, oxy_umol_kg, Year, Month, Year.Month, Year.Month.Day, dMonth, NB_OBS_DAY)


#save :
#write.table(EOL_3, "EOL_17-22_23perday_hourly.csv", sep=";", col.names = TRUE, row.names = FALSE)


```

