---
title: "Kapsenberg"
author: "Mégane"
date: "2023-03-20"
output: html_document
---

# Time series trends analysis by residuals (substracting climatological monthly means)

Analysis on time series, without interpolations

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
```

```{r import data (0m et 50m) + periode 2007-2015, echo=FALSE, warning=FALSE, message=FALSE}
data_raw <- read_csv("../Data/data_pH_steeve.csv")
data_raw_surf <- data_raw %>% dplyr::filter(depth==0)
data_raw_prof <- data_raw %>% dplyr::filter(depth==50)

data_0715 <- data_raw_surf %>% dplyr::filter(sampling_date < "2016-01-05") #470 values
data_0715_50m <- data_raw_prof %>% dplyr::filter(sampling_date < "2016-01-05") #462 values


#theme for plots :
Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
    theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
          axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
          axis.text.y = element_text(face=face_font, color="black", size=size_labs),
          axis.title.y = element_text(face=face_font, size=size_labs),
          axis.ticks.x = element_line(size=0.1),
          axis.ticks.y = element_line(size=0.1),
          axis.ticks.length = unit(1.1, "mm"),
          panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
          aspect.ratio = 1 / 3,
          plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
    )
}
##
```

## Comparison with Kapsenberg results - period 2007-2015

##### [Table of monthly means (2007-2015) - surface data]{style="color:blue"}

➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok

*(Rajouter les SD)*

```{r Calcul monthly means 0715 - surface, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_0m_0715 <- ungroup(data_0715) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_0m_0715
```

##### [Table of time series anomalies regression analyses (2007-2015) - surface data]{style="color:green"}

➝ Comparison Table 2 (Kapsenberg) same period : results ok

```{r anomalies + regressions 2007-2015 (Kapsenberg) - surface, echo=TRUE, warning=FALSE, message=FALSE}

ano_0m_0715 <- left_join(ungroup(data_0715), monthly_means_0m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_0m_0715)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]
slope_pH <- reg_ano_surf[7, 1]

reg_ano_surf

```

#### Plot of anomalies : temperature (2007-2015) - surface

```{r, plot anomalies temperature 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 0 m
plot_ano_temp_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 0m of temperature (°C) 2007-2015")

plot_temp_0715
plot_ano_temp_0715

```

#### Plot of anomalies : salinity (2007-2015) - surface

```{r, plot anomalies salinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity 2007-2015")

plot_sal_0715
plot_ano_sal_0715
```

#### Plot of anomalies : pH (2007-2015) - surface

```{r, plot anomalies pH 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2015)")

plot_ph_0715
plot_ano_ph_0715
```

#### Plot of anomalies : alcalinity (2007-2015) - surface

```{r, plot anomalies alcalinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 0m of alcalinity (2007-2015)")

plot_ta_0715
plot_ano_ta_0715
```

#### Plot of anomalies : pCO2 (2007-2015) - surface

```{r, plot anomalies CO2 1 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_pCO2_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations of pCO2 (2007-2015)")

plot_pCO2_0715
plot_ano_pCO2_0715
```

##### [Table of monthly means (2007-2015) - 50m data]{style="color:blue"}

➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok

*(Rajouter les SD)*

```{r Calcul monthly means 0715 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0715 <- ungroup(data_0715_50m) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_50m_0715
```

##### [Table of time series anomalies regression analyses (2007-2015) - 50m data]{style="color:green"}

➝ Comparison Table 2 (Kapsenberg) same period: results ok (sauf pour la pCO2)

```{r anomalies + regressions 2007-2015 (Kapsenberg) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0715 <- left_join(ungroup(data_0715_50m), monthly_means_50m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list_50 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test_50 <- vector("list", length(var_list_50))
 
 for(i in seq_along(var_list_50)){
     lm.test_50[[i]] <- lm(reformulate(var_list_50[i], "sampling_date"), data = ano_50m_0715)
 }


lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})

reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50m <- reg_50

# Regression and table anomalies
var_list_50 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})
reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50 <- reg_50

reg_ano_50

```

#### Plot of anomalies : temperature (2007-2015) - 50m

```{r, plot anomalies temperature 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 50 m
plot_ano_temp_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (°C) 2007-2015")

plot_temp_0715_50m
plot_ano_temp_0715_50m

```

#### Plot of anomalies : salinity (2007-2015) - 50m

```{r, plot anomalies salinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity 2007-2015")

plot_sal_0715_50m
plot_ano_sal_0715_50m
```

#### Plot of anomalies : pH (2007-2015) - 50m

```{r, plot anomalies pH 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2015)")

plot_ph_0715_50m
plot_ano_ph_0715_50m
```

#### Plot of anomalies : alcalinity (2007-2015) - 50m

```{r, plot anomalies alcalinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 50m of alcalinity (2007-2015)")

plot_ta_0715_50m
plot_ano_ta_0715_50m
```

#### Plot of anomalies : pCO2 (2007-2015) - 50m

```{r, plot anomalies CO2 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO2_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2015)")

plot_pCO2_0715_50m
plot_ano_pCO2_0715_50m
```

## Method extension for 2007-2022 period  
  
→ SOMLIT clean + interpolations ok ☑  
  
  
##### [Table of monthly means (2007-2022) - surface data]{style="color:blue"}  
  
*(rajouter les SD)*  
  

```{r import data 2007-2022 at 0m and 50m, echo=FALSE, warning=FALSE, message=FALSE}

#data surface
data_0722 <- read_delim("../Data/DATA_SOMLIT_07-23_impute_0m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
    mutate(Month = as.numeric(Month))

#data 50m
 # data_0722_50m <- read_delim("../Data/DATA_SOMLIT_07-23_CLEAN.csv", 
 #     delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
 #   dplyr::filter(depth == 50) %>% 
 #   mutate(Month = as.numeric(Month),
 #          impute_temp = na_interpolation(temperature, option="linear"),
 #          impute_sal = na_interpolation(salinity, option="linear"),
 #          impute_ta = na_interpolation(ta, option="linear"),
 #          impute_dic = na_interpolation(dic, option="linear"),
 #          impute_pCO2_w = na_interpolation(pCO2, option="linear"))
 # 
 # #save :
 # write.table(data_0722_50m, "DATA_SOMLIT_07-23_impute_50m.csv", sep=";", col.names = TRUE, row.names = FALSE)

data_0722_50m <- read_delim("../Data/DATA_SOMLIT_07-23_impute_50m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
    mutate(Month = as.numeric(Month))


```

```{r calculate monthly means 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_0m_0722 <- ungroup(data_0722) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE),
    dic_month = mean(impute_dic, na.rm = TRUE),
    ta_month = mean(impute_ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH_18, na.rm = TRUE),
    pCO2_month = mean(impute_pCO2_w, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))

monthly_means_0m_0722

```

##### [Table of time series anomaly regression analyses (2007-2022) - surface data]{style="color:green"}

```{r calculate anomalies + regression 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

ano_0m_0722 <- left_join(ungroup(data_0722), monthly_means_0m_0722, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal - Salinity_month,
    Temperature_ano = impute_temp - Temperature_month,
    dic_ano = impute_dic - dic_month,
    ta_ano = impute_ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH_18 - pH18_month,
    pCO2_ano = pCO2_w - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list2 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH_18",
    "pCO2_w",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test2 <- vector("list", length(var_list2))

for(i in seq_along(var_list2)){
  lm.test2[[i]] <- lm(reformulate(var_list2[i], "datetime"), data = ano_0m_0722)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_0m_0722))
})

reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}

colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2
slope_temp2 <- reg_ano_surf2[2, 1]

# Regression and table anomalies
var_list2 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_0m_0722))
})
reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}
colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2
slope_temp2 <- reg_ano_surf2[2, 1]
slope_pH2 <- reg_ano_surf2[7, 1]

reg_ano_surf2

```

#### Plot of anomalies : Temperature (2007-2022) - surface

```{r, plot anomalies temperature 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (2007-2022)",x="", y="Temp. (°C)") +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_0m_0722$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp) + 
  geom_line(size=0.8, col = "#303030") +
  scale_x_date(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2007-2022)")

plot_temp_0722
plot_ano_temp2
```


```{r}

# data_0722 %>% 
#   ggplot() +
#   aes(x=datetime, y=impute_temp) + 
#   geom_point(size=0.8) +
#   scale_x_date(name="") +
#   scale_y_continuous(name="Temp. (°C)") +
#   ggtitle("Surface temperature time series (2007-2022)")


```




#### Plot of anomalies : salinity (2007-2022) - surface

```{r, plot anomalies salinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_sal2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for salinity (2007-2022)",x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal) + 
  geom_line(size=0.8, col = "#175732") +
  scale_x_date(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series at Point B (2007-2022)")

plot_sal_0722
plot_ano_sal2
```

#### Plot of anomalies : pH (2007-2022) - surface

```{r, plot anomalies pH 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for pH calculated (2007-2022)", x="", y="pH_calc") +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_0m_0722$pH18_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2022)")

plot_ph_0722
plot_ano_ph2
```

#### Plot of anomalies : alcalinity (2007-2022) - surface

```{r, plot anomalies alcalinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = ta_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AT (2007-2022)",x="",y= "Total alcalinity (µmol/kg)") +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_0m_0722$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_ta) + 
  geom_line(size=0.8, col = "#723E64") +
  scale_x_date(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg)") +
  ggtitle("Surface total alcalinity time series (2007-2022)")

plot_ta_0722
plot_ano_ta_0722
```

#### Plot of anomalies : pCO2 (2007-2022) - surface

```{r, plot anomalies CO2 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = pCO2_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for pCO2 (2007-2022)",x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_0m_0722$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_pCO2_w) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 0m of pCO2 (2007-2022)")

plot_pCO2_0722
plot_ano_pCO22
```

 ##### [Table of monthly means (2007-2022) - 50m data]{style="color:blue"}

*(rajouter les SD)*

```{r calculate monthly means 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0722 <- ungroup(data_0722_50m) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE),
    dic_month = mean(impute_dic, na.rm = TRUE),
    ta_month = mean(impute_ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH_18, na.rm = TRUE),
    pCO2_month = mean(impute_pCO2_w, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))

monthly_means_50m_0722

```

##### [Table of time series anomaly regression analyses (2007-2022) - 50m data]{style="color:green"}

```{r calculate anomalies + regression 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0722 <- left_join(ungroup(data_0722_50m), monthly_means_50m_0722, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal - Salinity_month,
    Temperature_ano = impute_temp - Temperature_month,
    dic_ano = impute_dic - dic_month,
    ta_ano = impute_ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH_18 - pH18_month,
    pCO2_ano = impute_pCO2_w - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH_18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list2)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_50m_0722)
}


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0722))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_50m_0722))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m <- reg

reg_ano_50m

```

#### Plot of anomalies : Temperature (2007-2022) - 50m

```{r, plot anomalies temperature 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_50m_0722$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_temp) + 
  geom_line(size=0.8, linetype="dashed", col = "#5A5E6B") +
  scale_x_date(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("50m temperature time series (2007-2022)")

plot_temp_0722_50m
plot_ano_temp2_50m
```

#### Plot of anomalies : salinity (2007-2022) - 50m

```{r, plot anomalies salinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_sal) + 
  geom_line(size=0.8, linetype="dashed", col = "#22780F") +
  scale_x_date(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("50m salinity time series (2007-2022)")

plot_sal_0722_50m
plot_ano_sal2_50m
```

#### Plot of anomalies : pH (2007-2022) - 50m

```{r, plot anomalies pH 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pH18_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="5 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for pH normalized (2007-2022)", x="", y="pH_25") +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_50m_0722$pH18_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2022)")

plot_ph_0722_50m
plot_ano_ph2_50m
```

#### Plot of anomalies : alcalinity (2007-2022) - 50m

```{r, plot anomalies alcalinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_50m_0722$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_ta) + 
  geom_line(size=0.8, linetype="dashed", col = "#C4698F") +
  scale_x_date(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg)") +
  ggtitle("50m total alcalinity time series (2007-2022)")

plot_ta_0722_50m
plot_ano_ta_0722_50m

```

#### Plot of anomalies : pCO2 (2007-2022) - 50m

```{r, plot anomalies CO2 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.Date("2016-01-01"), y= min(ano_50m_0722$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_pCO2_w) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2022)")

plot_pCO2_0722_50m
plot_ano_pCO22_50m
```

## Method extension for 1992-2022 period (only temperature & salinity)

## Trend analysis by residuals on temperature and salinity : period 1992-2022


```{r import data temperature + salinity Point B - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

data_raw_surf <- data_raw %>% dplyr::filter(depth==0) %>% 
  mutate(datetime = as.character(sampling_date))
data_raw_prof <- data_raw %>% dplyr::filter(depth==50)%>% 
  mutate(datetime = as.character(sampling_date))

##

####Data filled SAMIR (B > B+ quand B+ empty), mean profondeur 1 - 3m
##period : 05/1992 - 05/2022

##surface
RAW_SOMLIT_1m <- readRDS("../Data/rh_B_Bplus_1m_mean.rds")
###tri
SOMLIT_1m <- RAW_SOMLIT_1m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_1m = SOMLIT_1m %>% arrange(datetime)


####Rename
SOMLIT_1m <- SOMLIT_1m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)

##

##50m
RAW_SOMLIT_50m <- readRDS("../Data/rh_B_Bplus_50m_mean.rds")
###tri
SOMLIT_50m <- RAW_SOMLIT_50m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_50m = SOMLIT_50m %>% arrange(datetime)


####Rename
SOMLIT_50m <- SOMLIT_50m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)
```


```{r data temperature + salinity Point B - year 2022 - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

#period : 2022

##surface
Data_TS_2022 <- read_delim("../Data/PtB_data_TS_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#select depth = 1m
#46 observations
#3 NA
Data_TS_2022_surf <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 1) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  dplyr::filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_surf <- Data_TS_2022_surf %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_surf <- dplyr::mutate(Data_TS_2022_surf, salinity = case_when(salinity <= 35 ~ NA_real_ , 
                                                                           TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_surf <- rbind(SOMLIT_1m, Data_TS_2022_surf) 

Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.POSIXct(datetime))

#save :
#write.table(Data_SOMLIT_9222_surf, "DATA_SOMLIT_92-22_TS_0m.csv", sep=";", col.names = TRUE, row.names = FALSE)

##

##50m
#select depth = 50m
Data_TS_2022_prof <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 50) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  dplyr::filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_prof <- Data_TS_2022_prof %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_prof <- dplyr::mutate(Data_TS_2022_prof, salinity = case_when(salinity <= 35 ~ NA_real_ , 
                                                                           TRUE ~ salinity),
                                   salinity = case_when(salinity > 39 ~ NA_real_ , TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_prof <- rbind(SOMLIT_50m, Data_TS_2022_prof)

Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.POSIXct(datetime))

#save :
#write.table(Data_SOMLIT_9222_prof, "DATA_SOMLIT_92-22_TS_50m.csv", sep=";", col.names = TRUE, row.names = FALSE)

```
  
→ Linear interpolation for temperature & salinity (surface) :  
  

```{r interpolation temperature & salinity - surface, echo=FALSE, warning=FALSE, message=FALSE}

#temperature :
impute_temp_9222_0m <- na_interpolation(Data_SOMLIT_9222_surf$temperature, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_surf$temperature, impute_temp_9222_0m, x_axis_labels = Data_SOMLIT_9222_surf$datetime, 
                      xlab = "", ylab="Temp. (°C)", 
                      title="Surface temperature (°C) time series interpolation - period 1992-2022")

#salinity :
impute_sal_9222_0m <- na_interpolation(Data_SOMLIT_9222_surf$salinity, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_surf$salinity, impute_sal_9222_0m, x_axis_labels = Data_SOMLIT_9222_surf$datetime, 
                      xlab = "", ylab="Salinity", 
                      title="Surface salinity time series interpolation - period 1992-2022")

```
  

→ Linear interpolation for temperature & salinity (50m) :  
  

```{r interpolation temperature & salinity - 50m, echo=FALSE, warning=FALSE, message=FALSE}

#temperature :
impute_temp_9222_50m <- na_interpolation(Data_SOMLIT_9222_prof$temperature, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_prof$temperature, impute_temp_9222_50m, x_axis_labels = Data_SOMLIT_9222_prof$datetime, 
                      xlab = "", ylab="Temp. (°C)", 
                      title="Temperature (°C) at 50m time series interpolation - period 1992-2022")

#salinity :
impute_sal_9222_50m <- na_interpolation(Data_SOMLIT_9222_prof$salinity, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_prof$salinity, impute_sal_9222_50m, x_axis_labels = Data_SOMLIT_9222_prof$datetime, 
                      xlab = "", ylab="Salinity", 
                      title="Salinity at 50m time series interpolation - period 1992-2022")

#merge :
impute_temp_9222_surf <- data.frame(datetime = Data_SOMLIT_9222_surf$datetime, impute_temp_9222_0m = impute_temp_9222_0m,
                                    impute_sal_9222_0m = impute_sal_9222_0m)
Data_SOMLIT_9222_surf <- left_join(Data_SOMLIT_9222_surf, impute_temp_9222_surf, by="datetime")
Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.character(datetime))
##
impute_temp_9222_prof <- data.frame(datetime = Data_SOMLIT_9222_prof$datetime, impute_temp_9222_50m = impute_temp_9222_50m,
                                    impute_sal_9222_50m = impute_sal_9222_50m)
Data_SOMLIT_9222_prof <- left_join(Data_SOMLIT_9222_prof, impute_temp_9222_prof, by="datetime")
Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.character(datetime))

```



```{r arrange datasets 0 & 50m, echo=FALSE, warning=FALSE, message=FALSE}


##surface
Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.POSIXct(datetime),
         Month = as.numeric(format(datetime, format="%m")))


##50m
Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.POSIXct(datetime),
         Month = as.numeric(format(datetime, format="%m")))

```

##### [Table of monthly means for salinity and temperature (1992-2022) - 0m data]{style="color:blue"}

```{r calculate monthly means 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_0m_9222 <- Data_SOMLIT_9222_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m))

monthly_means_0m_9222

```

##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 0m data]{style="color:green"}

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_0m_9222 <- left_join(ungroup(Data_SOMLIT_9222_surf), monthly_means_0m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_0m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_0m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_0m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_0m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_0m_9222 <- reg_ST2

reg_ano_ST_0m_9222

```


#### Plot of anomalies : Temperature (1992-2022) - 0m

```{r plot anomalies temperature 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_ST_0m_9222$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_9222_0m <- Data_SOMLIT_9222_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.8, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (1992-2022)")

plot_temp_9222_0m
plot_ano_temp_9222_0m

```

#### Plot of anomalies : salinity (1992-2022) - 0m

```{r plot anomalies salinity 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_9222_0m <- Data_SOMLIT_9222_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_0m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity (1992-2022)")

plot_sal_9222_0m
plot_ano_sal_9222_0m

```

##### [Table of monthly means for salinity and temperature (1992-2022) - 50m data]{style="color:blue"}

```{r calculate monthly means 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_9222 <- ungroup(Data_SOMLIT_9222_prof) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal_9222_50m, na.rm = TRUE),
    Temperature_month = mean(impute_temp_9222_50m, na.rm = TRUE))

monthly_means_50m_9222

```

##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 50m data]{style="color:green"}

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_50m_9222 <- left_join(ungroup(Data_SOMLIT_9222_prof), monthly_means_50m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_50m - Salinity_month,
    Temperature_ano = impute_temp_9222_50m - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_50m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_50m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_50m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_50m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_50m_9222 <- reg_ST2

reg_ano_ST_50m_9222

```


#### Plot of anomalies : Temperature (1992-2022) - 50m

```{r plot anomalies temperature 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_ST_50m_9222$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_9222_50m <- Data_SOMLIT_9222_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_50m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (1992-2022)")

plot_temp_9222_50m
plot_ano_temp_9222_50m

```

#### Plot of anomalies : salinity (1992-2022) - 50m

```{r plot anomalies salinity 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_9222_50m <- Data_SOMLIT_9222_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_50m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity (1992-2022)")

plot_sal_9222_50m
plot_ano_sal_9222_50m

```
  

## Analysis every 10 years (only temperature)  
  
  
## Trend analysis by residuals on temperature : period Jan.1993 - Dec.2002  
  
  
##### [Table of monthly means for temperature (1993-2002) - 0m data]{style="color:blue"}

```{r calculate monthly means 1993-2002 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_9302_surf <- Data_SOMLIT_9222_surf %>% 
  dplyr::filter(datetime >= "1993-01-06" & datetime <= "2002-12-30")
##

monthly_means_0m_9302 <- Data_SOMLIT_9302_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m))

monthly_means_0m_9302

```

##### [Table of temperature time series anomaly regression analyses (1993-2002) - 0m data]{style="color:green"}

```{r calculate anomalies + regression on temperature (1993-2002) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_T_0m_9302 <- left_join(ungroup(Data_SOMLIT_9302_surf), monthly_means_0m_9302, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_T_0m_9302)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_T_0m_9302))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_9302 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_T_0m_9302))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_9302 <- reg

reg_ano_T_0m_9302

```


#### Plot of anomalies : Temperature (1993-2002) - 0m

```{r plot anomalies temperature 1993-2002 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9302_0m <- ggplot(data = ano_T_0m_9302, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (1993-2002)",x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_T_0m_9302$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_9302_0m <- Data_SOMLIT_9302_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_point(size=1, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (1993-2002)")

plot_temp_9302_0m
plot_ano_temp_9302_0m

```
  

## Trend analysis by residuals on temperature : period Jan.2003 - Dec.2012  
  
  
##### [Table of monthly means for temperature (2003-2012) - 0m data]{style="color:blue"}

```{r calculate monthly means 2003-2012 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_0312_surf <- Data_SOMLIT_9222_surf %>% 
  dplyr::filter(datetime >= "2003-01-09" & datetime <= "2012-12-28")
##

monthly_means_0m_0312 <- Data_SOMLIT_0312_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m))

monthly_means_0m_0312

```

##### [Table of temperature time series anomaly regression analyses (2003-2012) - 0m data]{style="color:green"}

```{r calculate anomalies + regression on temperature (2003-2012) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_T_0m_0312 <- left_join(ungroup(Data_SOMLIT_0312_surf), monthly_means_0m_0312, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_T_0m_0312)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_T_0m_0312))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_0312 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_T_0m_0312))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_0312 <- reg

reg_ano_T_0m_0312

```


#### Plot of anomalies : Temperature (2003-2012) - 0m

```{r plot anomalies temperature 2003-2012 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_0312_0m <- ggplot(data = ano_T_0m_0312, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (2003-2012)",x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_T_0m_0312$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_0312_0m <- Data_SOMLIT_0312_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.8, col = "#0F056B") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2003-2012)")

plot_temp_0312_0m
plot_ano_temp_0312_0m

```
  

## Trend analysis by residuals on temperature : period Jan.2013 - Dec.2022  
  
  
##### [Table of monthly means for temperature (2013-2022) - 0m data]{style="color:blue"}

```{r calculate monthly means 2013-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_1322_surf <- Data_SOMLIT_9222_surf %>% 
  dplyr::filter(datetime >= "2013-01-04" & datetime <= "2022-12-20")
##

monthly_means_0m_1322 <- Data_SOMLIT_1322_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m))

monthly_means_0m_1322

```

##### [Table of temperature time series anomaly regression analyses (2003-2012) - 0m data]{style="color:green"}

```{r calculate anomalies + regression on temperature (2003-2012) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_T_0m_1322 <- left_join(ungroup(Data_SOMLIT_1322_surf), monthly_means_0m_1322, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_T_0m_1322)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_T_0m_1322))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_1322 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_T_0m_1322))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_T_0m_1322 <- reg

reg_ano_T_0m_1322

```


#### Plot of anomalies : Temperature (2013-2022) - 0m

```{r plot anomalies temperature 2013-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_1322_0m <- ggplot(data = ano_T_0m_1322, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (2013-2022)",x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_T_0m_1322$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_1322_0m <- Data_SOMLIT_1322_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.8, col = "#3F2204") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2013-2022)")

plot_temp_1322_0m
plot_ano_temp_1322_0m

```








#############################################################################################


## **Comparison SOMLIT surface results (weekly) with EOL results (hourly) (2017-2022)**  
  
#### *Data surface : temperature (°C) & salinity*  
  
##### [Table and plot of monthly means (2013-2022) - EOL temperature & salinity]{style="color:blue"}


```{r importation Data EOL hourly 17-22, echo=FALSE, warning=FALSE, message=FALSE}

#period : septembre 2013-octobre 2022
EOL_hourly_1722 <- read_delim("../Data/EOL_17-22_23perday_hourly.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(temperature=temp_eol_c, salinity=sal_eol_psu) %>% 
  mutate(datetime = as.POSIXct(datetime, format = "%Y-%m-%d")) 


```


```{r creation data SOMLIT (2013-2022), echo=FALSE, warning=FALSE, message=FALSE}

SOMLIT_1722 <- data_0722 %>% 
  dplyr::filter(datetime >= "2017-09-26") %>% 
  mutate(Month = format(datetime, format="%m"))


```


```{r calcul monthly means - temperature & salinity - EOL, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_EOL_1722 <- ungroup(EOL_hourly_1722) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_EOL_1722

```



```{r calcul monthly means - temperature & salinity - SOMLIT - 2013-2022, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_somlit_1722 <- ungroup(SOMLIT_1722) %>%
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE))

monthly_means_somlit_1722

```


```{r plot monthly means - temperature & salinity - EOL, echo=TRUE, warning=FALSE, message=FALSE}

# EOL_monthly_means <- left_join(ungroup(EOL_RAW), monthly_means, by = "Month")
# 
# EOL_monthly_means %>% 
#   ggplot() + 
#   geom_point(aes(x=datetime, y=temperature), size=1, col="lightblue") +
#   geom_point(aes(x=datetime, y=Temperature_month), size=0.8, col="pink") +
#   scale_x_datetime(name="") +
#   scale_y_continuous(name="Temp. (°C)")
```



```{r plot monthly means - temperature & salinity - SOMLIT - 2013-2022, echo=TRUE, warning=FALSE, message=FALSE}

# SOMLIT_1322_monthly_means <- left_join(ungroup(SOMLIT_1322), monthly_means_somlit_1322, by = "Month")
# 
# SOMLIT_1322_monthly_means %>% 
#   ggplot() + 
#   geom_point(aes(x=sampling_date, y=temperature), size=1, col="lightblue") +
#   geom_point(aes(x=sampling_date, y=Temperature_month), size=0.8, col="pink") +
#   scale_x_datetime(name="") +
#   scale_y_continuous(name="Temp. (°C)")
```


##### [Table of time series anomalies regression analyses (2017-2022) - EOL temperature & salinity]{style="color:green"}  
  

```{r regression analysis - temperature & salinity - EOL, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_EOL_1722 <- left_join(ungroup(EOL_hourly_1722), monthly_means_EOL_1722, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month) %>% 
  unite(col=datetime_fusion, "datetime", "Hour", sep=" ") %>% 
  mutate(datetime_fusion = as.POSIXct(datetime_fusion, format = "%Y-%m-%d %H:%M:%S"))

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime_fusion"), data = anomalies_EOL_1722)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime_fusion), list(i = as.name(x))), 
             data = anomalies_EOL_1722))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime_fusion), list(i = as.name(x))), 
             data = anomalies_EOL_1722))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg) <- var_list
reg_anomalies <- reg

reg_anomalies
```


##### [Table of time series anomalies regression analyses (2017-2022) - SOMLIT temperature & salinity]{style="color:green"}  

```{r regression analysis - temperature & salinity - SOMLIT - 2013-2022, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_SOM_1722 <- left_join(ungroup(SOMLIT_1722), monthly_means_somlit_1722, by = "Month") %>% 
  mutate(Salinity_ano = impute_sal - Salinity_month,
         Temperature_ano = impute_temp - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_SOM_1722)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_SOM_1722))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_SOM_1722 <- reg
slope_temp <- reg_ano_SOM_1722[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_SOM_1722))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg) <- var_list
reg_anomalies_som_1722 <- reg

reg_anomalies_som_1722
```



#### **Plot of anomalies : Temperature (°C) (2017-2022) - EOL**    
  

```{r plot anomalies + trends - temperature - EOL, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_1722 <- ggplot(data = anomalies_EOL_1722, aes(x = datetime_fusion, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="1 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (2017-2022)",x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_1722$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 5) +
  theme(axis.text.x=element_blank())

plot_temperature_EOL_1722 <- EOL_hourly_1722 %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL time series observations of temperature (°C) 2017-2022")

plot_temperature_EOL_1722
plot_ano_temp_EOL_1722
```


#### **Plot of anomalies : Salinity (2017-2022) - EOL**  
  

```{r plot anomalies + trends - salinity - EOL, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_sal_EOL_1722 <- ggplot(data = anomalies_EOL_1722, aes(x = datetime_fusion, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for salinity (2017-2022)",x="", y="Salinity") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_EOL_1722$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_salinity_EOL_1722 <- EOL_hourly_1722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL time series observations of salinity  2017-2022")

plot_salinity_EOL_1722
plot_ano_sal_EOL_1722
```


#### **Plot of anomalies : Temperature (°C) (2013-2022) - SOMLIT**  
  

```{r plot anomalies + trends - temperature - SOMLIT, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_SOM_1322 <- ggplot(data = anomalies_SOM_1322, aes(x = sampling_date, y = Temperature_ano), 
                                 na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_SOM_1322$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("SOMLIT - Temperature anomalies + trend")

plot_temperature_SOM_1322 <- SOMLIT_1322 %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("SOMLIT time series observations of temperature (°C) 2013-2022")

plot_temperature_SOM_1322
plot_ano_temp_SOM_1322
```


#### **Plot of anomalies : Salinity (2013-2022) - SOMLIT**  
  
  
```{r plot anomalies + trends - salinity - SOMLIT, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_sal_SOM_1322 <- ggplot(data = anomalies_SOM_1322, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(anomalies_SOM_1322$Salinity_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("SOMLIT - Salinity anomalies + trend")

plot_salinity_SOM_1322 <- SOMLIT_1322 %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("SOMLIT time series observations of salinity  2013-2022")

plot_salinity_SOM_1322
plot_ano_sal_SOM_1322
```






# **Time series trend analysis by autocorrelation**  
  

```{r autocorrelation - temperature surface}

#missing values : interpolation temperature > temp2
data_raw_surf <- data_raw_surf %>% 
  mutate(temp2 = na_interpolation(temperature))

summary(data_raw_surf$temp2) # 0 NA

#Autocorrelation :
acf(data_raw_surf$temp2, lag.max = 55, type="correlation", plot=FALSE)

#cycle de 52 semaines



```


```{r fonction ts }


s1 <- ts(data_raw_surf$temp2, start=2007, end=2022, frequency=52)

plot(s1)

decomp <- decompose(s1)

plot(decomp)

```

