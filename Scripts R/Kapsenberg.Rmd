---
title: "Kapsenberg"
author: "Mégane"
date: "2023-03-20"
output: html_document
---

# Time series trends analysis by residuals (substracting climatological monthly means)

Analysis on time series, without interpolations

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
```

```{r import data (0m et 50m) + periode 2007-2015, echo=FALSE, warning=FALSE, message=FALSE}
data_raw <- read_csv("../Data/data_pH_steeve.csv")
data_raw_surf <- data_raw %>% filter(depth==0)
data_raw_prof <- data_raw %>% filter(depth==50)

data_0715 <- data_raw_surf %>% filter(sampling_date < "2016-01-05") #470 values
data_0715_50m <- data_raw_prof %>% filter(sampling_date < "2016-01-05") #462 values


#theme for plots :
Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
    theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
          axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
          axis.text.y = element_text(face=face_font, color="black", size=size_labs),
          axis.title.y = element_text(face=face_font, size=size_labs),
          axis.ticks.x = element_line(size=0.1),
          axis.ticks.y = element_line(size=0.1),
          axis.ticks.length = unit(1.1, "mm"),
          panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
          aspect.ratio = 1 / 3,
          plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
    )
}
##
```

## Comparison with Kapsenberg results - period 2007-2015

##### [Table of monthly means (2007-2015) - surface data]{style="color:blue"}

➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok

*(Rajouter les SD)*

```{r Calcul monthly means 0715 - surface, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_0m_0715 <- ungroup(data_0715) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_0m_0715
```

##### [Table of time series anomalies regression analyses (2007-2015) - surface data]{style="color:green"}

➝ Comparison Table 2 (Kapsenberg) same period : results ok

```{r anomalies + regressions 2007-2015 (Kapsenberg) - surface, echo=TRUE, warning=FALSE, message=FALSE}

ano_0m_0715 <- left_join(ungroup(data_0715), monthly_means_0m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_0m_0715)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]
slope_pH <- reg_ano_surf[7, 1]

reg_ano_surf

```

#### Plot of anomalies : temperature (2007-2015) - surface

```{r, plot anomalies temperature 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 0 m
plot_ano_temp_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 0m of temperature (°C) 2007-2015")

plot_temp_0715
plot_ano_temp_0715

```

#### Plot of anomalies : salinity (2007-2015) - surface

```{r, plot anomalies salinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity 2007-2015")

plot_sal_0715
plot_ano_sal_0715
```

#### Plot of anomalies : pH (2007-2015) - surface

```{r, plot anomalies pH 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2015)")

plot_ph_0715
plot_ano_ph_0715
```

#### Plot of anomalies : alcalinity (2007-2015) - surface

```{r, plot anomalies alcalinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 0m of alcalinity (2007-2015)")

plot_ta_0715
plot_ano_ta_0715
```

#### Plot of anomalies : pCO2 (2007-2015) - surface

```{r, plot anomalies CO2 1 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_pCO2_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations of pCO2 (2007-2015)")

plot_pCO2_0715
plot_ano_pCO2_0715
```

##### [Table of monthly means (2007-2015) - 50m data]{style="color:blue"}

➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok

*(Rajouter les SD)*

```{r Calcul monthly means 0715 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0715 <- ungroup(data_0715_50m) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_50m_0715
```

##### [Table of time series anomalies regression analyses (2007-2015) - 50m data]{style="color:green"}

➝ Comparison Table 2 (Kapsenberg) same period: results ok (sauf pour la pCO2)

```{r anomalies + regressions 2007-2015 (Kapsenberg) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0715 <- left_join(ungroup(data_0715_50m), monthly_means_50m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list_50 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test_50 <- vector("list", length(var_list_50))
 
 for(i in seq_along(var_list_50)){
     lm.test_50[[i]] <- lm(reformulate(var_list_50[i], "sampling_date"), data = ano_50m_0715)
 }


lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})

reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50m <- reg_50

# Regression and table anomalies
var_list_50 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})
reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50 <- reg_50

reg_ano_50

```

#### Plot of anomalies : temperature (2007-2015) - 50m

```{r, plot anomalies temperature 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 50 m
plot_ano_temp_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (°C) 2007-2015")

plot_temp_0715_50m
plot_ano_temp_0715_50m

```

#### Plot of anomalies : salinity (2007-2015) - 50m

```{r, plot anomalies salinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity 2007-2015")

plot_sal_0715_50m
plot_ano_sal_0715_50m
```

#### Plot of anomalies : pH (2007-2015) - 50m

```{r, plot anomalies pH 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2015)")

plot_ph_0715_50m
plot_ano_ph_0715_50m
```

#### Plot of anomalies : alcalinity (2007-2015) - 50m

```{r, plot anomalies alcalinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 50m of alcalinity (2007-2015)")

plot_ta_0715_50m
plot_ano_ta_0715_50m
```

#### Plot of anomalies : pCO2 (2007-2015) - 50m

```{r, plot anomalies CO2 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO2_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2015)")

plot_pCO2_0715_50m
plot_ano_pCO2_0715_50m
```

## Method extension for 2007-2022 period

##### [Table of monthly means (2007-2022) - surface data]{style="color:blue"}

*(rajouter les SD)*

```{r import data 2007-2022 at 0m and 50m, echo=FALSE, warning=FALSE, message=FALSE}

data_0722 <- data_raw_surf %>% filter(sampling_date < "2022-01-11")#774 valeurs
data_0722_50m <- data_raw_prof %>% filter(sampling_date < "2022-01-11")#752 valeurs


```

```{r calculate monthly means 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_0m_0722 <- ungroup(data_0722) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))

monthly_means_0m_0722

```

##### [Table of time series anomaly regression analyses (2007-2022) - surface data]{style="color:green"}

```{r calculate anomalies + regression 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

ano_0m_0722 <- left_join(ungroup(data_0722), monthly_means_0m_0722, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list2 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test2 <- vector("list", length(var_list2))

for(i in seq_along(var_list2)){
  lm.test2[[i]] <- lm(reformulate(var_list2[i], "sampling_date"), data = ano_0m_0722)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0722))
})

reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}

colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2
slope_temp2 <- reg_ano_surf2[2, 1]

# Regression and table anomalies
var_list2 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_0m_0722))
})
reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}
colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2
slope_temp2 <- reg_ano_surf2[2, 1]
slope_pH2 <- reg_ano_surf2[7, 1]

reg_ano_surf2

```

#### Plot of anomalies : Temperature (2007-2022) - surface

```{r, plot anomalies temperature 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2 <- ggplot(data = ano_0m_0722, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0722$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 0m of temperature (2007-2022)")

plot_temp_0722
plot_ano_temp2
```

#### Plot of anomalies : salinity (2007-2022) - surface

```{r, plot anomalies salinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_sal2 <- ggplot(data = ano_0m_0722, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity (2007-2022)")

plot_sal_0722
plot_ano_sal2
```

#### Plot of anomalies : pH (2007-2022) - surface

```{r, plot anomalies pH 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2 <- ggplot(data = ano_0m_0722, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0722$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2022)")

plot_ph_0722
plot_ano_ph2
```

#### Plot of anomalies : alcalinity (2007-2022) - surface

```{r, plot anomalies alcalinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722 <- ggplot(data = ano_0m_0722, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0722$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 0m of alcalinity (2007-2022)")

plot_ta_0722
plot_ano_ta_0722
```

#### Plot of anomalies : pCO2 (2007-2022) - surface

```{r, plot anomalies CO2 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22 <- ggplot(data = ano_0m_0722, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0722$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 0m of pCO2 (2007-2022)")

plot_pCO2_0722
plot_ano_pCO22
```

##### [Table of monthly means (2007-2022) - 50m data]{style="color:blue"}

*(rajouter les SD)*

```{r calculate monthly means 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0722 <- ungroup(data_0722_50m) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))

monthly_means_50m_0722

```

##### [Table of time series anomaly regression analyses (2007-2022) - 50m data]{style="color:green"}

```{r calculate anomalies + regression 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0722 <- left_join(ungroup(data_0722_50m), monthly_means_50m_0722, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list2 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test2 <- vector("list", length(var_list2))

for(i in seq_along(var_list2)){
  lm.test2[[i]] <- lm(reformulate(var_list2[i], "sampling_date"), data = ano_50m_0722)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0722))
})

reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}

colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_50m2 <- reg2

# Regression and table anomalies
var_list2 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_50m_0722))
})
reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}
colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_50m2 <- reg2

reg_ano_50m2

```

#### Plot of anomalies : Temperature (2007-2022) - 50m

```{r, plot anomalies temperature 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0722$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (2007-2022)")

plot_temp_0722_50m
plot_ano_temp2_50m
```

#### Plot of anomalies : salinity (2007-2022) - 50m

```{r, plot anomalies salinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity (2007-2022)")

plot_sal_0722_50m
plot_ano_sal2_50m
```

#### Plot of anomalies : pH (2007-2022) - 50m

```{r, plot anomalies pH 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0722$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2022)")

plot_ph_0722_50m
plot_ano_ph2_50m
```

#### Plot of anomalies : alcalinity (2007-2022) - 50m

```{r, plot anomalies alcalinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0722$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 50m of alcalinity (2007-2022)")

plot_ta_0722_50m
plot_ano_ta_0722_50m

```

#### Plot of anomalies : pCO2 (2007-2022) - 50m

```{r, plot anomalies CO2 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0722$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2022)")

plot_pCO2_0722_50m
plot_ano_pCO22_50m
```

## Method extension for 1992-2022 period (only temperature & salinity)

## Trend analysis by residuals on temperature and salinity : period 1992-2022


```{r import data temperature + salinity Point B - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

data_raw_surf <- data_raw %>% filter(depth==0) %>% 
  mutate(datetime = as.character(sampling_date))
data_raw_prof <- data_raw %>% filter(depth==50)%>% 
  mutate(datetime = as.character(sampling_date))

##

####Data filled SAMIR (B > B+ quand B+ empty), mean profondeur 1 - 3m
##period : 05/1992 - 05/2022

##surface
RAW_SOMLIT_1m <- readRDS("../Data/rh_B_Bplus_1m_mean.rds")
###tri
SOMLIT_1m <- RAW_SOMLIT_1m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_1m = SOMLIT_1m %>% arrange(datetime)


####Rename
SOMLIT_1m <- SOMLIT_1m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)

##

##50m
RAW_SOMLIT_50m <- readRDS("../Data/rh_B_Bplus_50m_mean.rds")
###tri
SOMLIT_50m <- RAW_SOMLIT_50m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_50m = SOMLIT_50m %>% arrange(datetime)


####Rename
SOMLIT_50m <- SOMLIT_50m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)
```


```{r data temperature + salinity Point B - year 2022 - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

#period : 2022

##surface
Data_TS_2022 <- read_delim("../Data/PtB_data_TS_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#select depth = 1m
#46 observations
#3 NA
Data_TS_2022_surf <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 1) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_surf <- Data_TS_2022_surf %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_surf <- dplyr::mutate(Data_TS_2022_surf, salinity = case_when(salinity <= 35 ~ NA_real_ , TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_surf <- rbind(SOMLIT_1m, Data_TS_2022_surf)

##

##50m
#select depth = 50m
Data_TS_2022_prof <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 50) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_prof <- Data_TS_2022_prof %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_prof <- dplyr::mutate(Data_TS_2022_prof, salinity = case_when(salinity <= 35 ~ NA_real_ , TRUE ~ salinity),
                                   salinity = case_when(salinity > 39 ~ NA_real_ , TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_prof <- rbind(SOMLIT_50m, Data_TS_2022_prof)

```


```{r creation dataset fusion de Data_SOMLIT_9222 with data_raw -  salinity + temperature - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

##surface
combined_data_surf <- full_join(data_raw_surf, Data_SOMLIT_9222_surf, by = "datetime")

combined_data_surf = combined_data_surf %>% arrange(datetime)

#temperature
combined_data_surf$temperature.x[is.na(combined_data_surf$temperature.x)] <- "NA"
combined_data_surf$temperature.y <- as.character(combined_data_surf$temperature.y)

combined_data_surf <- combined_data_surf %>% 
  mutate(temperature = case_when(temperature.x == "NA" ~ temperature.y , TRUE ~ temperature.x))

#salinity
combined_data_surf$salinity.x[is.na(combined_data_surf$salinity.x)] <- "NA"
combined_data_surf$salinity.y <- as.character(combined_data_surf$salinity.y)

combined_data_surf <- combined_data_surf %>% 
  mutate(temperature = case_when(temperature.x == "NA" ~ temperature.y , TRUE ~ temperature.x),
         salinity = case_when(salinity.x == "NA" ~ salinity.y , TRUE ~ salinity.x))

combined_data_surf <- combined_data_surf %>% 
  select(datetime, salinity, temperature, ta, dic, NO2, NO3, Chla, year, monthd, pH_calc, pCO2) %>% 
  mutate(datetime = as.POSIXct(datetime), salinity = as.numeric(salinity), temperature = as.numeric(temperature)) %>% 
  mutate(Month = format(datetime, format="%m"))

##

##50m
combined_data_prof <- full_join(data_raw_prof, Data_SOMLIT_9222_prof, by = "datetime")

combined_data_prof = combined_data_prof %>% arrange(datetime)

#temperature
combined_data_prof$temperature.x[is.na(combined_data_prof$temperature.x)] <- "NA"
combined_data_prof$temperature.y <- as.character(combined_data_prof$temperature.y)

combined_data_prof <- combined_data_prof %>% 
  mutate(temperature = case_when(temperature.x == "NA" ~ temperature.y , TRUE ~ temperature.x))

#salinity
combined_data_prof$salinity.x[is.na(combined_data_prof$salinity.x)] <- "NA"
combined_data_prof$salinity.y <- as.character(combined_data_prof$salinity.y)

combined_data_prof <- combined_data_prof %>% 
  mutate(temperature = case_when(temperature.x == "NA" ~ temperature.y , TRUE ~ temperature.x),
         salinity = case_when(salinity.x == "NA" ~ salinity.y , TRUE ~ salinity.x))

combined_data_prof <- combined_data_prof %>% 
  select(datetime, salinity, temperature, ta, dic, NO2, NO3, Chla, year, monthd, pH_calc, pCO2) %>% 
  mutate(datetime = as.POSIXct(datetime), salinity = as.numeric(salinity), temperature = as.numeric(temperature)) %>% 
  mutate(Month = format(datetime, format="%m"))


```

##### [Table of monthly means for salinity and temperature (1992-2022) - 0m data]{style="color:blue"}

```{r calculate monthly means 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_0m_9222 <- ungroup(combined_data_surf) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_0m_9222

```

##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 0m data]{style="color:green"}

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_0m_9222 <- left_join(ungroup(combined_data_surf), monthly_means_0m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_0m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_0m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_0m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_0m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_0m_9222 <- reg_ST2

reg_ano_ST_0m_9222

```


#### Plot of anomalies : Temperature (1992-2022) - 0m

```{r plot anomalies temperature 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_ST_0m_9222$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_9222_0m <- combined_data_surf %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 0m of temperature (1992-2022)")

plot_temp_9222_0m
plot_ano_temp_9222_0m

```

#### Plot of anomalies : salinity (1992-2022) - 0m

```{r plot anomalies salinity 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_9222_0m <- combined_data_surf %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity (1992-2022)")

plot_sal_9222_0m
plot_ano_sal_9222_0m

```

##### [Table of monthly means for salinity and temperature (1992-2022) - 50m data]{style="color:blue"}

```{r calculate monthly means 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_9222 <- ungroup(combined_data_prof) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE))

monthly_means_50m_9222

```

##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 50m data]{style="color:green"}

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_50m_9222 <- left_join(ungroup(combined_data_prof), monthly_means_50m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_50m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_50m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_50m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_50m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_50m_9222 <- reg_ST2

reg_ano_ST_50m_9222

```


#### Plot of anomalies : Temperature (1992-2022) - 50m

```{r plot anomalies temperature 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_ST_50m_9222$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_temp_9222_50m <- combined_data_prof %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (1992-2022)")

plot_temp_9222_50m
plot_ano_temp_9222_50m

```

#### Plot of anomalies : salinity (1992-2022) - 50m

```{r plot anomalies salinity 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_9222_50m <- combined_data_prof %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity (1992-2022)")

plot_sal_9222_50m
plot_ano_sal_9222_50m

```

# Time series trend analysis by autocorrelation

```{r autocorrelation - temperature surface}

#missing values : interpolation temperature > temp2
data_raw_surf <- data_raw_surf %>% 
  mutate(temp2 = na_interpolation(temperature))

summary(data_raw_surf$temp2) # 0 NA

#Autocorrelation :
acf(data_raw_surf$temp2, lag.max = 55, type="correlation", plot=FALSE)

#cycle de 52 semaines



```


```{r fonction ts }


s1 <- ts(data_raw_surf$temp2, start=2007, end=2022, frequency=52)

plot(s1)

decomp <- decompose(s1)

plot(decomp)

```

