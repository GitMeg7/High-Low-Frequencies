---
title: "Kapsenberg"
author: "Mégane"
date: "2023-03-20"
output: html_document
---
  
# Time series trends analysis by residuals (substracting climatological monthly means)  
  
Kapsenberg et al. (2017)  
  

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}
library("readr")
library("viridis")
library("scales")
library("lubridate")
library("gsignal")
library("FactoMineR")
library("factoextra")
library("gplots")
library("heatwaveR")
library("dplyr")
library("imputeTS")
library("Metrics")
library("tidyr")
library("tseries")
library("forecast")
library("tsDyn")
library("tsoutliers")
library("seacarb")
library("lmodel2")
library("lmtest")
```

```{r import data (0m et 50m) + periode 2007-2015, echo=FALSE, warning=FALSE, message=FALSE}
data_raw <- read_csv("../Data/data_pH_steeve.csv")
data_raw_surf <- data_raw %>% dplyr::filter(depth==0)
data_raw_prof <- data_raw %>% dplyr::filter(depth==50)

data_0715 <- data_raw_surf %>% dplyr::filter(sampling_date < "2016-01-05") #470 values
data_0715_50m <- data_raw_prof %>% dplyr::filter(sampling_date < "2016-01-05") #462 values


#theme for plots :
Mytheme <- function(size_labs = 6, face_font="plain", ...) {
  theme_bw() +
    theme(axis.text.x = element_text(face=face_font, size=size_labs, color="black"),
          axis.title.x = element_text(face=face_font, size=size_labs, margin=margin(0,0,0,0,"pt")),
          axis.text.y = element_text(face=face_font, color="black", size=size_labs),
          axis.title.y = element_text(face=face_font, size=size_labs),
          axis.ticks.x = element_line(size=0.1),
          axis.ticks.y = element_line(size=0.1),
          axis.ticks.length = unit(1.1, "mm"),
          panel.grid.major = element_line(size = 0.25, color="black", linetype="dotted"),
          aspect.ratio = 1 / 3,
          plot.margin = margin(t = 0, r = 1, b = 0, l = 0, unit = "lines")
    )
}
##
```
  
## Comparison with Kapsenberg results - period 2007-2015  
  
#### SURFACE  
  
##### [Table of monthly means (2007-2015) - surface data]{style="color:blue"}  
  
➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok ✓   
  

```{r Calcul monthly means 0715 - surface, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_0m_0715 <- ungroup(data_0715) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_0m_0715
```
  
  
##### [Table of time series anomalies regression analyses (2007-2015) - surface data]{style="color:green"}  
  
➝ Comparison Table 2 (Kapsenberg) same period : results ok ✓   
  

```{r anomalies + regressions 2007-2015 (Kapsenberg) - surface, echo=TRUE, warning=FALSE, message=FALSE}

ano_0m_0715 <- left_join(ungroup(data_0715), monthly_means_0m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_0m_0715)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_0m_0715))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_surf <- reg
slope_temp <- reg_ano_surf[2, 1]
slope_pH <- reg_ano_surf[7, 1]

reg_ano_surf

```
  
  
###### Plot of anomalies : temperature (2007-2015) - surface  
  

```{r, plot anomalies temperature 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 0 m
plot_ano_temp_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 0m of temperature (°C) 2007-2015")

plot_temp_0715
plot_ano_temp_0715


```
  
  
###### Plot of anomalies : salinity (2007-2015) - surface  
  

```{r, plot anomalies salinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_sal_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity 2007-2015")

plot_sal_0715
plot_ano_sal_0715
```
  
  
###### Plot of anomalies : pH (2007-2015) - surface  
  

```{r, plot anomalies pH 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2015)")

plot_ph_0715
plot_ano_ph_0715
```
  
  
###### Plot of anomalies : alcalinity (2007-2015) - surface  
  

```{r, plot anomalies alcalinity 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 0m of alcalinity (2007-2015)")

plot_ta_0715
plot_ano_ta_0715
```
  
  
###### Plot of anomalies : pCO2 (2007-2015) - surface  
  

```{r, plot anomalies CO2 1 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_pCO2_0715 <- ggplot(data = ano_0m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_0m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715 <- data_0715 %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations of pCO2 (2007-2015)")

plot_pCO2_0715
plot_ano_pCO2_0715
```
  
  
### DEPTH 50 m  
  
##### [Table of monthly means (2007-2015) - 50m data]{style="color:blue"}  
  
➝ Comparaison supplement, Tab S1 (Kapsenberg) same period : results ok ✓   
  

```{r Calcul monthly means 0715 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0715 <- ungroup(data_0715_50m) %>% 
  group_by(monthd) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    dic_month = mean(dic, na.rm = TRUE),
    ta_month = mean(ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH18, na.rm = TRUE),
    pCO2_month = mean(pCO2, na.rm = TRUE),
    OmegaCalcite_month = mean(OmegaCalcite, na.rm = TRUE),
    OmegaAragonite_month = mean(OmegaAragonite, na.rm = TRUE),
    Nta_month = mean(Nta, na.rm = TRUE),
    Ndic_month = mean(dic, na.rm = TRUE))
monthly_means_50m_0715
```
  
  
##### [Table of time series anomalies regression analyses (2007-2015) - 50m data]{style="color:green"}  
  
➝ Comparison Table 2 (Kapsenberg) same period: results ok  ✓   
    

```{r anomalies + regressions 2007-2015 (Kapsenberg) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0715 <- left_join(ungroup(data_0715_50m), monthly_means_50m_0715, by = "monthd") %>%
  mutate(
    Salinity_ano = salinity - Salinity_month,
    Temperature_ano = temperature - Temperature_month,
    dic_ano = dic - dic_month,
    ta_ano = ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH18 - pH18_month,
    pCO2_ano = pCO2 - pCO2_month,
    OmegaCalcite_ano = OmegaCalcite - OmegaCalcite_month,
    OmegaAragonite_ano = OmegaAragonite - OmegaAragonite_month,
    Nta_ano = Nta - Nta_month,
    Ndic_ano = dic - Ndic_month)

# Regressions and tables of key parameters
var_list_50 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH18",
    "pCO2",
    "OmegaCalcite",
    "OmegaAragonite",
    "Nta",
    "Ndic")

lm.test_50 <- vector("list", length(var_list_50))
 
 for(i in seq_along(var_list_50)){
     lm.test_50[[i]] <- lm(reformulate(var_list_50[i], "sampling_date"), data = ano_50m_0715)
 }


lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})

reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50m <- reg_50

# Regression and table anomalies
var_list_50 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano",
    "OmegaCalcite_ano",
    "OmegaAragonite_ano",
    "Nta_ano",
    "Ndic_ano"
  )
lms_50 <- lapply(var_list_50, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0715))
})
reg_50 <- NULL
for (i in 1:length(var_list_50)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms_50[[i]]$fstatistic[1],
       lms_50[[i]]$fstatistic[2],
       lms_50[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_50 <-
    rbind(reg_50, as.numeric(
      c(
        lms_50[[i]]$coefficients[2, 1],
        lms_50[[i]]$coefficients[2, 2],
        lms_50[[i]]$coefficients[2, 4],
        lms_50[[i]]$coefficients[1, 1],
        lms_50[[i]]$coefficients[1, 2],
        lms_50[[i]]$coefficients[1, 4],
        lms_50[[i]]$fstatistic[1],
        lms_50[[i]]$fstatistic[3],
        lms_50[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg_50) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_50) <- var_list_50
reg_ano_50 <- reg_50

reg_ano_50

```
  
  
###### Plot of anomalies : temperature (2007-2015) - 50m  
  

```{r, plot anomalies temperature 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

#Anomalies 50 m
plot_ano_temp_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Temp. (°C)") +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$Temperature_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) + 
  ggtitle("Temperature anomalies + trend")

plot_temp_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=temperature) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (°C) 2007-2015")

plot_temp_0715_50m
plot_ano_temp_0715_50m

```
  
  
###### Plot of anomalies : salinity (2007-2015) - 50m  
  

```{r, plot anomalies salinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 years", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-0.50,-0.25,0,0.25)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="", y="Salinity") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank()) +
  ggtitle("Salinity anomalies + trend")

plot_sal_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity 2007-2015")

plot_sal_0715_50m
plot_ano_sal_0715_50m
```
  
  
###### Plot of anomalies : pH (2007-2015) - 50m  
  

```{r, plot anomalies pH 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL, x="", y=expression(paste(pH[T]," calculated"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pH_calc_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ph_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2015)")

plot_ph_0715_50m
plot_ano_ph_0715_50m
```
  
  
###### Plot of anomalies : alcalinity (2007-2015) - 50m  
  

```{r, plot anomalies alcalinity 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$ta_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_ta_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=ta) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg") +
  ggtitle("Time series observations at 50m of alcalinity (2007-2015)")

plot_ta_0715_50m
plot_ano_ta_0715_50m
```
  
  
###### Plot of anomalies : pCO2 (2007-2015) - 50m  
  

```{r, plot anomalies CO2 2007-2015 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO2_0715_50m <- ggplot(data = ano_50m_0715, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title=NULL,x="",y=expression(paste(pCO[2], " (",mu, "atm)"))) +
  annotate("text", x =as.POSIXct("2016-01-01"), y= min(ano_50m_0715$pCO2_ano, na.rm=TRUE), 
           label="", colour="black", size=9, fontface="plain") +
  coord_fixed() +
  Mytheme(size_labs = 8) +
  theme(axis.text.x=element_blank())

plot_pCO2_0715_50m <- data_0715_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pCO2) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2015)")

plot_pCO2_0715_50m
plot_ano_pCO2_0715_50m
```
  
  
  
  
## 2007-2022  
  
  
*→ SOMLIT clean + interpolations ok ☑*   
  
### SURFACE  
  
##### [Table of monthly means (2007-2022) - surface data]{style="color:blue"}  
  

```{r import data 2007-2022 at 0m and 50m, echo=FALSE, warning=FALSE, message=FALSE}

#data surface
data_0722 <- read_delim("../Data/DATA_SOMLIT_07-22_impute_0m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
    mutate(Month = as.numeric(Month))

#data 50m
 # data_0722_50m <- read_delim("../Data/DATA_SOMLIT_07-22_CLEAN.csv", 
 #     delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
 #   dplyr::filter(depth == 50) %>% 
 #   mutate(Month = as.numeric(Month),
 #          impute_temp = na_interpolation(temperature, option="linear"),
 #          impute_sal = na_interpolation(salinity, option="linear"),
 #          impute_ta = na_interpolation(ta, option="linear"),
 #          impute_dic = na_interpolation(dic, option="linear"),
 #          impute_pCO2_w = na_interpolation(pCO2, option="linear"))
 # 
 # #save :
 # write.table(data_0722_50m, "DATA_SOMLIT_07-22_impute_50m.csv", sep=";", col.names = TRUE, row.names = FALSE)

data_0722_50m <- read_delim("../Data/DATA_SOMLIT_07-22_impute_50m.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
    mutate(Month = as.numeric(Month))


```

```{r calculate monthly means 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

#choix pH 18 car moyenne temperature sur toute la periode 2007-2022 : 18.83

monthly_means_0m_0722 <- ungroup(data_0722) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    SD_sal = sd(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE),
    SD_temp = sd(impute_temp, na.rm = TRUE),
    dic_month = mean(impute_dic, na.rm = TRUE),
    SD_dic = sd(impute_dic, na.rm = TRUE),
    ta_month = mean(impute_ta, na.rm = TRUE),
    SD_ta = sd(impute_ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    SD_PH = sd(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH_18, na.rm = TRUE),
    SD_PH18 = sd(pH_18, na.rm = TRUE),
    pCO2_month = mean(impute_pCO2_w, na.rm = TRUE),
    SD_pCO2 = sd(impute_pCO2_w, na.rm = TRUE))

monthly_means_0m_0722




## TEST TDT : 
test_tdt <- data_0722 %>% 
  group_by(Year.Month) %>% 
  mutate(monthly = mean(impute_temp)) %>% 
  group_by(Month) %>% 
  mutate(Temperature_month = mean(impute_temp))
  
annual = mean(monthly_means_0m_0722$Temperature_month)

test_monthly_means <- monthly_means_0m_0722 %>% 
  mutate(adj = Temperature_month - annual)

test_tdt <- test_tdt %>% 
  mutate(adj = Temperature_month - annual, 
         new = monthly - adj)

rm(test_tdt)



test_monthly_means %>% 
  ggplot() + 
  geom_histogram(aes(x=Month, y=adj), stat = "identity") 
  #geom_point(aes(x=Month, y=new), col = "red")

test_tdt %>% 
  ggplot() + 
  geom_line(aes(x=datetime, y=impute_temp), col="grey") +
  geom_point(aes(x=datetime, y=monthly), col="darkblue") + 
  geom_point(aes(x=datetime, y=new), col="red") + 
  geom_smooth(method=lm, aes(x=datetime, y=new), col="red")


SD <- sd(test_tdt$new)



```
  
  
##### [Table of time series anomaly regression analyses (2007-2022) - surface data]{style="color:green"}  
  

```{r calculate anomalies + regression 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE}

ano_0m_0722 <- left_join(ungroup(data_0722), monthly_means_0m_0722, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal - Salinity_month,
    Temperature_ano = impute_temp - Temperature_month,
    dic_ano = impute_dic - dic_month,
    ta_ano = impute_ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH_18 - pH18_month,
    pCO2_ano = pCO2_w - pCO2_month)

# Regressions and tables of key parameters
var_list2 <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH_18",
    "pCO2_w")

lm.test2 <- vector("list", length(var_list2))

for(i in seq_along(var_list2)){
  lm.test2[[i]] <- lm(reformulate(var_list2[i], "datetime"), data = ano_0m_0722)
}


lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_0m_0722))
})

reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}

colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2

# Regression and table anomalies
var_list2 <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano"
  )
lms2 <- lapply(var_list2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_0m_0722))
})
reg2 <- NULL
for (i in 1:length(var_list2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob2 <-
    pf(lms2[[i]]$fstatistic[1],
       lms2[[i]]$fstatistic[2],
       lms2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg2 <-
    rbind(reg2, as.numeric(
      c(
        lms2[[i]]$coefficients[2, 1],
        lms2[[i]]$coefficients[2, 2],
        lms2[[i]]$coefficients[2, 4],
        lms2[[i]]$coefficients[1, 1],
        lms2[[i]]$coefficients[1, 2],
        lms2[[i]]$coefficients[1, 4],
        lms2[[i]]$fstatistic[1],
        lms2[[i]]$fstatistic[3],
        lms2[[i]]$r.squared,
        prob2
      )
    ))
}
colnames(reg2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg2) <- var_list2
reg_ano_surf2 <- reg2

reg_ano_surf2

```
  
  
###### Plot of anomalies : Temperature (2007-2022) - surface  
  

```{r, plot anomalies temperature 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for temperature (2007-2022)",x="", y="Temp. (°C)")
  

plot_temp_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp) + 
  geom_line(size=0.8, col = "#303030") +
  scale_x_date(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2007-2022)")

plot_temp_0722
plot_ano_temp2
```
  
  

###### Plot of anomalies : salinity (2007-2022) - surface  
  

```{r, plot anomalies salinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}
plot_ano_sal2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for salinity (2007-2022)",x="", y="Salinity")

plot_sal_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal) + 
  geom_line(size=0.8, col = "#175732") +
  scale_x_date(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series at Point B (2007-2022)")

plot_sal_0722
plot_ano_sal2
```
   
   
###### Plot of anomalies : pH (2007-2022) - surface  
  

```{r, plot anomalies pH 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for pH calculated (2007-2022)", x="", y="pH_calc")

plot_ph_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 0m of pH (2007-2022)")

plot_ph_0722
plot_ano_ph2
```
  
  
###### Plot of anomalies : alcalinity (2007-2022) - surface  
  

```{r, plot anomalies alcalinity 2007-2022 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = ta_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for AT (2007-2022)",x="",y= "Total alcalinity (µmol/kg)")

plot_ta_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_ta) + 
  geom_line(size=0.8, col = "#723E64") +
  scale_x_date(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg)") +
  ggtitle("Surface total alcalinity time series (2007-2022)")

plot_ta_0722
plot_ano_ta_0722
```
  
  
###### Plot of anomalies : pCO2 (2007-2022) - surface  
  

```{r, plot anomalies CO2 2007-2015 - surface, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22 <- ggplot(data = ano_0m_0722, aes(x = datetime, y = pCO2_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Anomalies trend for pCO2 (2007-2022)",x="",y=expression(paste(pCO[2], " (",mu, "atm)")))

plot_pCO2_0722 <- data_0722 %>% 
  ggplot() +
  aes(x=datetime, y=impute_pCO2_w) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 0m of pCO2 (2007-2022)")

plot_pCO2_0722
plot_ano_pCO22
```
  
  
  
### DEPTH 50 m  
  
##### [Table of monthly means (2007-2022) - 50m data]{style="color:blue"}  
  
*(rajouter les SD)*

```{r calculate monthly means 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_0722 <- ungroup(data_0722_50m) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    SD_sal = sd(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE),
    SD_temp = sd(impute_temp, na.rm = TRUE),
    dic_month = mean(impute_dic, na.rm = TRUE),
    SD_dic = sd(impute_dic, na.rm = TRUE),
    ta_month = mean(impute_ta, na.rm = TRUE),
    SD_ta = sd(impute_ta, na.rm = TRUE),
    pH_calc_month = mean(pH_calc, na.rm = TRUE),
    SD_PH = sd(pH_calc, na.rm = TRUE),
    pH18_month = mean(pH_18, na.rm = TRUE),
    SD_PH18 = sd(pH_18, na.rm = TRUE),
    pCO2_month = mean(impute_pCO2_w, na.rm = TRUE),
    SD_pCO2 = sd(impute_pCO2_w, na.rm = TRUE))

monthly_means_50m_0722

```
  
  
##### [Table of time series anomaly regression analyses (2007-2022) - 50m data]{style="color:green"}  
  

```{r calculate anomalies + regression 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_0722 <- left_join(ungroup(data_0722_50m), monthly_means_50m_0722, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal - Salinity_month,
    Temperature_ano = impute_temp - Temperature_month,
    dic_ano = impute_dic - dic_month,
    ta_ano = impute_ta - ta_month,
    pH_calc_ano = pH_calc - pH_calc_month,
    pH18_ano = pH_18 - pH18_month,
    pCO2_ano = impute_pCO2_w - pCO2_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature",
    "dic",
    "ta",
    "pH_calc",
    "pH_18",
    "pCO2")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list2)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "sampling_date"), data = ano_50m_0722)
}


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), 
             data = ano_50m_0722))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano",
    "dic_ano",
    "ta_ano",
    "pH_calc_ano",
    "pH18_ano",
    "pCO2_ano"
  )
lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(sampling_date), list(i = as.name(x))), data = ano_50m_0722))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m <- reg

reg_ano_50m

```
  
  
###### Plot of anomalies : Temperature (2007-2022) - 50m  
  

```{r, plot anomalies temperature 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Temperature_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend", x="", y="Temp. (°C)")

plot_temp_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_temp) + 
  geom_line(size=0.8, linetype="dashed", col = "#5A5E6B") +
  scale_x_date(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("50m temperature time series (2007-2022)")

plot_temp_0722_50m
plot_ano_temp2_50m
```
  
  
###### Plot of anomalies : salinity (2007-2022) - 50m  
  

```{r, plot anomalies salinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = Salinity_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend",x="", y="Salinity") 

plot_sal_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_sal) + 
  geom_line(size=0.8, linetype="dashed", col = "#22780F") +
  scale_x_date(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("50m salinity time series (2007-2022)")

plot_sal_0722_50m
plot_ano_sal2_50m
```
  
  
###### Plot of anomalies : pH (2007-2022) - 50m  
  

```{r, plot anomalies pH 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ph2_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pH_calc_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="pH anomalies + trend", x="", y="pH_calc")

plot_ph_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=pH_calc) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pH") +
  ggtitle("Time series observations at 50m of pH (2007-2022)")

plot_ph_0722_50m
plot_ano_ph2_50m
```
  
  
###### Plot of anomalies : alcalinity (2007-2022) - 50m  
  

```{r, plot anomalies alcalinity 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_ta_0722_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = ta_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="AT anomalies + trend",x="",y=expression(paste(pCO[2], " (",mu, "atm)")))

plot_ta_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_ta) + 
  geom_line(size=0.8, linetype="dashed", col = "#C4698F") +
  scale_x_date(name="") +
  scale_y_continuous(name="Alcalinity (umol/kg)") +
  ggtitle("50m total alcalinity time series (2007-2022)")

plot_ta_0722_50m
plot_ano_ta_0722_50m

```
  

###### Plot of anomalies : pCO2 (2007-2022) - 50m  
  

```{r, plot anomalies CO2 2007-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_pCO22_50m <- ggplot(data = ano_50m_0722, aes(x = sampling_date, y = pCO2_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="pCO2 water anomalies + trend",x="",y=expression(paste(pCO[2], " (",mu, "atm)")))

plot_pCO2_0722_50m <- data_0722_50m %>% 
  ggplot() +
  aes(x=sampling_date, y=impute_pCO2_w) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="pCO2 (uatm)") +
  ggtitle("Time series observations at 50m of pCO2 (2007-2022)")

plot_pCO2_0722_50m
plot_ano_pCO22_50m
```
  
  
  
  
## 1992-2022 : temperature & salinity  
  
05-92 to 12-22  
  
### SURFACE  
  

```{r import data temperature + salinity Point B - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

data_raw_surf <- data_raw %>% dplyr::filter(depth==0) %>% 
  mutate(datetime = as.character(sampling_date))
data_raw_prof <- data_raw %>% dplyr::filter(depth==50)%>% 
  mutate(datetime = as.character(sampling_date))

##

####Data filled SAMIR (B > B+ quand B+ empty), mean profondeur 1 - 3m
##period : 05/1992 - 05/2022

##surface
RAW_SOMLIT_1m <- readRDS("../Data/rh_B_Bplus_1m_mean.rds")
###tri
SOMLIT_1m <- RAW_SOMLIT_1m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_1m = SOMLIT_1m %>% arrange(datetime)


####Rename
SOMLIT_1m <- SOMLIT_1m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)

##

##50m
RAW_SOMLIT_50m <- readRDS("../Data/rh_B_Bplus_50m_mean.rds")
###tri
SOMLIT_50m <- RAW_SOMLIT_50m %>%
  dplyr::select(datetime, mean_temp_rhBplus_B, mean_sal_rhBplus_B) %>% 
  mutate(datetime = format(datetime, format = "%Y-%m-%d"))

SOMLIT_50m = SOMLIT_50m %>% arrange(datetime)


####Rename
SOMLIT_50m <- SOMLIT_50m %>%
  dplyr::rename(temperature = mean_temp_rhBplus_B,
                salinity = mean_sal_rhBplus_B)
```


```{r data temperature + salinity Point B - year 2022 - 0m et 50m, echo=FALSE, warning=FALSE, message=FALSE}

#period : 2022

##surface
Data_TS_2022 <- read_delim("../Data/PtB_data_TS_2022.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

#select depth = 1m
#46 observations
#3 NA
Data_TS_2022_surf <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 1) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  dplyr::filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_surf <- Data_TS_2022_surf %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_surf <- dplyr::mutate(Data_TS_2022_surf, salinity = case_when(salinity <= 35 ~ NA_real_ , 
                                                                           TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_surf <- rbind(SOMLIT_1m, Data_TS_2022_surf) 

Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.POSIXct(datetime))

#save :
#write.table(Data_SOMLIT_9222_surf, "DATA_SOMLIT_92-22_TS_0m.csv", sep=";", col.names = TRUE, row.names = FALSE)

##

##50m
#select depth = 50m
Data_TS_2022_prof <- Data_TS_2022 %>% 
  dplyr::filter(Data_TS_2022$Depth == 50) %>% 
  mutate(datetime = as.character(Date)) %>% 
  rename(temperature = T, salinity = S) %>% 
  dplyr::filter(Date > "2022-05-02") #pour eviter les doublons avec l annee 2022


#select date, T et S
Data_TS_2022_prof <- Data_TS_2022_prof %>%
  dplyr::select(datetime, temperature, salinity)


#select salinity > 35 and 9999 by NA
Data_TS_2022_prof <- dplyr::mutate(Data_TS_2022_prof, salinity = case_when(salinity <= 35 ~ NA_real_ , 
                                                                           TRUE ~ salinity),
                                   salinity = case_when(salinity > 39 ~ NA_real_ , TRUE ~ salinity),
                              temperature = case_when(temperature >= 999 ~ NA_real_ ,TRUE ~ temperature),
                              salinity = case_when(salinity >= 999 ~ NA_real_ ,TRUE ~ salinity))

#fusionner les 2 datasets (SOMLIT_1m + Data_TS_2022) = Data_SOMLIT_9222

Data_SOMLIT_9222_prof <- rbind(SOMLIT_50m, Data_TS_2022_prof)

Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.POSIXct(datetime))

#save :
#write.table(Data_SOMLIT_9222_prof, "DATA_SOMLIT_92-22_TS_50m.csv", sep=";", col.names = TRUE, row.names = FALSE)

```
  
→ Linear interpolation for temperature & salinity (surface) :  
  

```{r interpolation temperature & salinity - surface, echo=FALSE, warning=FALSE, message=FALSE}

#temperature :
impute_temp_9222_0m <- na_interpolation(Data_SOMLIT_9222_surf$temperature, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_surf$temperature, impute_temp_9222_0m, x_axis_labels = Data_SOMLIT_9222_surf$datetime, 
                      xlab = "", ylab="Temp. (°C)", 
                      title="Surface temperature (°C) time series interpolation - period 1992-2022")

#salinity :
impute_sal_9222_0m <- na_interpolation(Data_SOMLIT_9222_surf$salinity, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_surf$salinity, impute_sal_9222_0m, x_axis_labels = Data_SOMLIT_9222_surf$datetime, 
                      xlab = "", ylab="Salinity", 
                      title="Surface salinity time series interpolation - period 1992-2022")

```
  
  
→ Linear interpolation for temperature & salinity (50m) :  
  

```{r interpolation temperature & salinity - 50m, echo=FALSE, warning=FALSE, message=FALSE}

#temperature :
impute_temp_9222_50m <- na_interpolation(Data_SOMLIT_9222_prof$temperature, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_prof$temperature, impute_temp_9222_50m, x_axis_labels = Data_SOMLIT_9222_prof$datetime, 
                      xlab = "", ylab="Temp. (°C)", 
                      title="Temperature (°C) at 50m time series interpolation - period 1992-2022")

#salinity :
impute_sal_9222_50m <- na_interpolation(Data_SOMLIT_9222_prof$salinity, option="linear")

ggplot_na_imputations(Data_SOMLIT_9222_prof$salinity, impute_sal_9222_50m, x_axis_labels = Data_SOMLIT_9222_prof$datetime, 
                      xlab = "", ylab="Salinity", 
                      title="Salinity at 50m time series interpolation - period 1992-2022")

#merge :
impute_temp_9222_surf <- data.frame(datetime = Data_SOMLIT_9222_surf$datetime, impute_temp_9222_0m = impute_temp_9222_0m,
                                    impute_sal_9222_0m = impute_sal_9222_0m)
Data_SOMLIT_9222_surf <- left_join(Data_SOMLIT_9222_surf, impute_temp_9222_surf, by="datetime")
Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.character(datetime))
##
impute_temp_9222_prof <- data.frame(datetime = Data_SOMLIT_9222_prof$datetime, impute_temp_9222_50m = impute_temp_9222_50m,
                                    impute_sal_9222_50m = impute_sal_9222_50m)
Data_SOMLIT_9222_prof <- left_join(Data_SOMLIT_9222_prof, impute_temp_9222_prof, by="datetime")
Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.character(datetime))

```
  
  

```{r arrange datasets 0 & 50m, echo=FALSE, warning=FALSE, message=FALSE}


##surface
Data_SOMLIT_9222_surf <- Data_SOMLIT_9222_surf %>% 
  mutate(datetime = as.POSIXct(datetime),
         Month = as.numeric(format(datetime, format="%m")))


##50m
Data_SOMLIT_9222_prof <- Data_SOMLIT_9222_prof %>% 
  mutate(datetime = as.POSIXct(datetime),
         Month = as.numeric(format(datetime, format="%m")))

# #save :
# write.table(Data_SOMLIT_9222_surf, "DATA_SOMLIT_92-22_TS_0m_impute.csv", sep=";", col.names = TRUE, row.names = FALSE)
# write.table(Data_SOMLIT_9222_prof, "DATA_SOMLIT_92-22_TS_50m_impute.csv", sep=";", col.names = TRUE, row.names = FALSE)
```
  
##### [Table of monthly means for salinity and temperature (1992-2022) - 0m data]{style="color:blue"}  
  

```{r calculate monthly means 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_0m_9222 <- Data_SOMLIT_9222_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            SD_sal = sd(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m),
            SD_temp = sd(impute_temp_9222_0m))

monthly_means_0m_9222

```
  
  
##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 0m data]{style="color:green"}  
  

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_0m_9222 <- left_join(ungroup(Data_SOMLIT_9222_surf), monthly_means_0m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_0m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_0m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_0m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_0m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_0m_9222 <- reg_ST2

reg_ano_ST_0m_9222

```
  
  
###### Plot of anomalies : Temperature (1992-2022) - 0m  
  

```{r plot anomalies temperature 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend",x="", y="Temp. (°C)")

plot_temp_9222_0m <- Data_SOMLIT_9222_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.8, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (1992-2022)")

plot_temp_9222_0m
plot_ano_temp_9222_0m

```
  
  
###### Plot of anomalies : salinity (1992-2022) - 0m  
  

```{r plot anomalies salinity 1992-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_0m <- ggplot(data = ano_ST_0m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend", x="", y="Salinity")

plot_sal_9222_0m <- Data_SOMLIT_9222_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_0m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 0m of salinity (1992-2022)")

plot_sal_9222_0m
plot_ano_sal_9222_0m

```
  
  
##### [Table of monthly means for salinity and temperature (1992-2022) - 50m data]{style="color:blue"}  
  

```{r calculate monthly means 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

monthly_means_50m_9222 <- ungroup(Data_SOMLIT_9222_prof) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal_9222_50m, na.rm = TRUE),
    SD_sal = sd(impute_sal_9222_50m, na.rm = TRUE),
    Temperature_month = mean(impute_temp_9222_50m, na.rm = TRUE),
    SD_temp = sd(impute_temp_9222_50m, na.rm = TRUE))

monthly_means_50m_9222

```
  
  
##### [Table of salinity and temperature time series anomaly regression analyses (1992-2022) - 50m data]{style="color:green"}  
  

```{r calculate anomalies + regression on salinity and temperature (1992-2022) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_ST_50m_9222 <- left_join(ungroup(Data_SOMLIT_9222_prof), monthly_means_50m_9222, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_50m - Salinity_month,
    Temperature_ano = impute_temp_9222_50m - Temperature_month)

# Regressions and tables of key parameters
var_list_ST <-
  c("salinity",
    "temperature")

lm.test_ST <- vector("list", length(var_list_ST))

for(i in seq_along(var_list_ST)){
  lm.test_ST[[i]] <- lm(reformulate(var_list_ST[i], "datetime"), data = ano_ST_50m_9222)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms_ST <- lapply(var_list_ST, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_ST_50m_9222))
})

reg_ST <- NULL
for (i in 1:length(var_list_ST)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST <-
    pf(lms_ST[[i]]$fstatistic[1],
       lms_ST[[i]]$fstatistic[2],
       lms_ST[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST <-
    rbind(reg_ST, as.numeric(
      c(
        lms_ST[[i]]$coefficients[2, 1],
        lms_ST[[i]]$coefficients[2, 2],
        lms_ST[[i]]$coefficients[2, 4],
        lms_ST[[i]]$coefficients[1, 1],
        lms_ST[[i]]$coefficients[1, 2],
        lms_ST[[i]]$coefficients[1, 4],
        lms_ST[[i]]$fstatistic[1],
        lms_ST[[i]]$fstatistic[3],
        lms_ST[[i]]$r.squared,
        prob_ST
      )
    ))
}

colnames(reg_ST) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST) <- var_list_ST
reg_ano_ST_50m_9222 <- reg_ST

# Regression and table anomalies
var_list_ST2 <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms_ST2 <- lapply(var_list_ST2, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_ST_50m_9222))
})

reg_ST2 <- NULL
for (i in 1:length(var_list_ST2)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob_ST2 <-
    pf(lms_ST2[[i]]$fstatistic[1],
       lms_ST2[[i]]$fstatistic[2],
       lms_ST2[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg_ST2 <-
    rbind(reg_ST2, as.numeric(
      c(
        lms_ST2[[i]]$coefficients[2, 1],
        lms_ST2[[i]]$coefficients[2, 2],
        lms_ST2[[i]]$coefficients[2, 4],
        lms_ST2[[i]]$coefficients[1, 1],
        lms_ST2[[i]]$coefficients[1, 2],
        lms_ST2[[i]]$coefficients[1, 4],
        lms_ST2[[i]]$fstatistic[1],
        lms_ST2[[i]]$fstatistic[3],
        lms_ST2[[i]]$r.squared,
        prob_ST2
      )
    ))
}
colnames(reg_ST2) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg_ST2) <- var_list_ST2
reg_ano_ST_50m_9222 <- reg_ST2

reg_ano_ST_50m_9222

```
  
  
###### Plot of anomalies : Temperature (1992-2022) - 50m  
  

```{r plot anomalies temperature 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend", x="", y="Temp. (°C)")

plot_temp_9222_50m <- Data_SOMLIT_9222_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_50m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Time series observations at 50m of temperature (1992-2022)")

plot_temp_9222_50m
plot_ano_temp_9222_50m

```
  
  
###### Plot of anomalies : salinity (1992-2022) - 50m  
  

```{r plot anomalies salinity 1992-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_9222_50m <- ggplot(data = ano_ST_50m_9222, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="4 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  scale_y_continuous(breaks=c(-2,-1,0,0.5)) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend",x="", y="Salinity")

plot_sal_9222_50m <- Data_SOMLIT_9222_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_50m) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Time series observations at 50m of salinity (1992-2022)")

plot_sal_9222_50m
plot_ano_sal_9222_50m

```
  
  
  
## 2000-2022 : Analysis every 10 years  
  
  
  
### SURFACE  
  
#### Jan.2000 - Dec.2009  
  
##### [Table of monthly means (2000-2009) - 0m data]{style="color:blue"}  
  

```{r calculate monthly means 2000-2009 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_2000_surf <- Data_SOMLIT_9222_surf %>% 
  dplyr::filter(datetime >= "2000-01-05" & datetime <= "2009-12-22")
##

monthly_means_0m_2000 <- Data_SOMLIT_2000_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            SD_sal = sd(impute_sal_9222_0m), 
            Temperature_month = mean(impute_temp_9222_0m),
            SD_temp = sd(impute_temp_9222_0m))

monthly_means_0m_2000

```
  
  
##### [Table of anomaly regression analyses (2000-2009) - 0m data]{style="color:green"}

```{r calculate anomalies + regression (2000-2009) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_0m_2000 <- left_join(ungroup(Data_SOMLIT_2000_surf), monthly_means_0m_2000, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_0m_2000)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_0m_2000))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_0m_2000 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_0m_2000))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_0m_2000 <- reg

reg_ano_0m_2000

```
  
  
###### Plot of anomalies : Temperature (2000-2009) - 0m  
  

```{r plot anomalies temperature 2000-2009 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_2000_0m <- ggplot(data = ano_0m_2000, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2000-2009)",x="", y="Temp. (°C)")

plot_temp_2000_0m <- Data_SOMLIT_2000_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.7, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2000-2009)")

plot_temp_2000_0m
plot_ano_temp_2000_0m

```
  
  
###### Plot of anomalies : Salinity (2000-2009) - 0m  
  

```{r plot anomalies salinity 2000-2009 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_2000_0m <- ggplot(data = ano_0m_2000, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2000-2009)",x="", y="Salinity")

plot_sal_2000_0m <- Data_SOMLIT_2000_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_0m) + 
  geom_line(size=0.7, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series (2000-2009)")

plot_sal_2000_0m
plot_ano_sal_2000_0m

```
  
  
#### Jan.2010 - Dec.2022  
  
  
##### [Table of monthly means (2010-2022) - 0m data]{style="color:blue"}  
  

```{r calculate monthly means 2010-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_2010_surf <- Data_SOMLIT_9222_surf %>% 
  dplyr::filter(datetime >= "2010-01-04")
##

monthly_means_0m_2010 <- Data_SOMLIT_2010_surf %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_0m),
            SD_sal = sd(impute_sal_9222_0m),
            Temperature_month = mean(impute_temp_9222_0m),
            SD_temp = sd(impute_temp_9222_0m))

monthly_means_0m_2010

```
  
  
##### [Table of anomaly regression analyses (2010-2022) - 0m data]{style="color:green"}  
  

```{r calculate anomalies + regression (2010-2022) - 0m, echo=FALSE, warning=FALSE, message=FALSE}

ano_0m_2010 <- left_join(ungroup(Data_SOMLIT_2010_surf), monthly_means_0m_2010, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_0m - Salinity_month,
    Temperature_ano = impute_temp_9222_0m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_0m_2010)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_0m_2010))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_0m_2010 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_0m_2010))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_0m_2010 <- reg

reg_ano_0m_2010

```
  
  
###### Plot of anomalies : Temperature (2010-2022) - 0m

```{r plot anomalies temperature 2010-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_2010_0m <- ggplot(data = ano_0m_2010, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2010-2022)",x="", y="Temp. (°C)")

plot_temp_2010_0m <- Data_SOMLIT_2010_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_0m) + 
  geom_line(size=0.7, col = "#0F056B") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2010-2022)")

plot_temp_2010_0m
plot_ano_temp_2010_0m

```
  
  
###### Plot of anomalies : Salinity (2010-2022) - 0m

```{r plot anomalies salinity 2010-2022 - 0m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_2010_0m <- ggplot(data = ano_0m_2010, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2010-2022)",x="", y="Salinity")

plot_sal_2010_0m <- Data_SOMLIT_2010_surf %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_0m) + 
  geom_line(size=0.7, col = "#0F056B") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series (2010-2022)")

plot_sal_2010_0m
plot_ano_sal_2010_0m

```
  
  
  
### DEPTH 50  
  
#### Jan.2000 - Dec.2009  
  
##### [Table of monthly means (2000-2009) - 50m data]{style="color:blue"}  
  

```{r calculate monthly means 2000-2009 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_2000_prof <- Data_SOMLIT_9222_prof %>% 
  dplyr::filter(datetime >= "2000-01-05" & datetime <= "2009-12-22")
##

monthly_means_50m_2000 <- Data_SOMLIT_2000_prof %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_50m),
            SD_sal = sd(impute_sal_9222_50m), 
            Temperature_month = mean(impute_temp_9222_50m),
            SD_temp = sd(impute_temp_9222_50m))

monthly_means_50m_2000

```
  
  
##### [Table of anomaly regression analyses (2000-2009) - 50m data]{style="color:green"}

```{r calculate anomalies + regression (2000-2009) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_2000 <- left_join(ungroup(Data_SOMLIT_2000_prof), monthly_means_50m_2000, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_50m - Salinity_month,
    Temperature_ano = impute_temp_9222_50m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_50m_2000)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_50m_2000))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m_2000 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_50m_2000))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m_2000 <- reg

reg_ano_50m_2000

```
  
  
###### Plot of anomalies : Temperature (2000-2009) - 50m  
  

```{r plot anomalies temperature 2000-2009 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_2000_50m <- ggplot(data = ano_50m_2000, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2000-2009)",x="", y="Temp. (°C)")

plot_temp_2000_50m <- Data_SOMLIT_2000_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_50m) + 
  geom_line(size=0.7, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2000-2009)")

plot_temp_2000_50m
plot_ano_temp_2000_50m

```
  
  
###### Plot of anomalies : Salinity (2000-2009) - 50m  
  

```{r plot anomalies salinity 2000-2009 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_2000_50m <- ggplot(data = ano_50m_2000, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2000-2009)",x="", y="Salinity")

plot_sal_2000_50m <- Data_SOMLIT_2000_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_50m) + 
  geom_line(size=0.7, col = "#24445C") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series (2000-2009)")

plot_sal_2000_50m
plot_ano_sal_2000_50m

```
  
  
#### Jan.2010 - Dec.2022  
  
  
##### [Table of monthly means (2010-2022) - 50m data]{style="color:blue"}  
  

```{r calculate monthly means 2010-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE}

Data_SOMLIT_2010_prof <- Data_SOMLIT_9222_prof %>% 
  dplyr::filter(datetime >= "2010-01-04")
##

monthly_means_50m_2010 <- Data_SOMLIT_2010_prof %>% 
  group_by(Month) %>%
  summarise(Salinity_month = mean(impute_sal_9222_50m),
            SD_sal = sd(impute_sal_9222_50m),
            Temperature_month = mean(impute_temp_9222_50m),
            SD_temp = sd(impute_temp_9222_50m))

monthly_means_50m_2010

```
  
  
##### [Table of anomaly regression analyses (2010-2022) - 50m data]{style="color:green"}  
  

```{r calculate anomalies + regression (2010-2022) - 50m, echo=FALSE, warning=FALSE, message=FALSE}

ano_50m_2010 <- left_join(ungroup(Data_SOMLIT_2010_prof), monthly_means_50m_2010, by = "Month") %>%
  mutate(
    Salinity_ano = impute_sal_9222_50m - Salinity_month,
    Temperature_ano = impute_temp_9222_50m - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))

for(i in seq_along(var_list)){
  lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = ano_50m_2010)
}

#cutoff_date <- "2016-01-01" #to limit regressions on complete years

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = ano_50m_2010))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m_2010 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), data = ano_50m_2010))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_50m_2010 <- reg

reg_ano_50m_2010

```
  
  
###### Plot of anomalies : Temperature (2010-2022) - 50m

```{r plot anomalies temperature 2010-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_temp_2010_50m <- ggplot(data = ano_50m_2010, aes(x = datetime, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2010-2022)",x="", y="Temp. (°C)")

plot_temp_2010_50m <- Data_SOMLIT_2010_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_temp_9222_50m) + 
  geom_line(size=0.7, col = "#0F056B") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("Surface temperature time series (2010-2022)")

plot_temp_2010_50m
plot_ano_temp_2010_50m

```
  
  
###### Plot of anomalies : Salinity (2010-2022) - 50m

```{r plot anomalies salinity 2010-2022 - 50m, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8,fig.height=4,fig.align='center'}

plot_ano_sal_2010_50m <- ggplot(data = ano_50m_2010, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="2 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=1) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2010-2022)",x="", y="Salinity")

plot_sal_2010_50m <- Data_SOMLIT_2010_prof %>% 
  ggplot() +
  aes(x=datetime, y=impute_sal_9222_50m) + 
  geom_line(size=0.7, col = "#0F056B") +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("Surface salinity time series (2010-2022)")

plot_sal_2010_50m
plot_ano_sal_2010_50m

```
  
  
  
  
--------------------------s  
  
  
## Comparison SOMLIT - EOL results : 2018-2022 
  
### SURFACE  
  
temperature (°C) & salinity  
  
  
##### [Table and plot of monthly means (2017-2022) - EOL temperature & salinity]{style="color:blue"}


```{r importation Data EOL hourly + creation SOMLIT 18-22, echo=FALSE, warning=FALSE, message=FALSE}

#period : Jan.2018 - Dec.2022

#EOL :
EOL_hourly_1822 <- read_delim("../Data/EOL_18-22_hourly.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
  rename(temperature=temp_eol_c, salinity=sal_eol_psu) %>% 
  mutate(datetime = as.POSIXct(datetime, format = "%Y-%m-%d")) %>% 
  dplyr::filter(datetime <= "2022-12-31 01:00:00")

#SOMLIT :
SOMLIT_1822 <- data_0722 %>% 
  dplyr::filter(datetime >= "2018-01-03") %>% 
  mutate(Month = format(datetime, format="%m"))

```



```{r calcul monthly means - temperature & salinity - EOL - 2018-2022, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_EOL_1822 <- ungroup(EOL_hourly_1822) %>% 
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(salinity, na.rm = TRUE),
    SD_sal = sd(salinity, na.rm = TRUE),
    Temperature_month = mean(temperature, na.rm = TRUE),
    SD_temp = sd(temperature, na.rm = TRUE))

monthly_means_EOL_1822

```
  
  

```{r calcul monthly means - temperature & salinity - SOMLIT - 2018-2022, echo=TRUE, warning=FALSE, message=FALSE}

monthly_means_somlit_1822 <- ungroup(SOMLIT_1822) %>%
  group_by(Month) %>%
  summarise(
    Salinity_month = mean(impute_sal, na.rm = TRUE),
    SD_sal = sd(impute_sal, na.rm = TRUE),
    Temperature_month = mean(impute_temp, na.rm = TRUE),
    SD_temp = sd(impute_temp, na.rm = TRUE))

monthly_means_somlit_1822

```
  
  

##### [Table of anomalies regression analyses (2018-2022) - EOL temperature & salinity]{style="color:green"}  
  

```{r regression analysis - temperature & salinity - EOL - 2018-2022, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_EOL_1822 <- left_join(ungroup(EOL_hourly_1822), monthly_means_EOL_1822, by = "Month") %>%
  mutate(Salinity_ano = salinity - Salinity_month,
         Temperature_ano = temperature - Temperature_month) %>% 
  unite(col=datetime_fusion, "datetime", "Hour", sep=" ") %>% 
  mutate(datetime_fusion = as.POSIXct(datetime_fusion, format = "%Y-%m-%d %H:%M:%S"))

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime_fusion"), data = anomalies_EOL_1822)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime_fusion), list(i = as.name(x))), 
             data = anomalies_EOL_1822))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_EOL_1822_surf <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime_fusion), list(i = as.name(x))), 
             data = anomalies_EOL_1822))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg) <- var_list
reg_ano_EOL_1822_surf <- reg

reg_ano_EOL_1822_surf
```
  
  
##### [Table of anomalies regression analyses (2018-2022) - SOMLIT temperature & salinity]{style="color:green"}  
  

```{r regression analysis - temperature & salinity - SOMLIT - 2018-2022, echo=FALSE, warning=FALSE, message=FALSE}

anomalies_SOM_1822 <- left_join(ungroup(SOMLIT_1822), monthly_means_somlit_1822, by = "Month") %>% 
  mutate(Salinity_ano = impute_sal - Salinity_month,
         Temperature_ano = impute_temp - Temperature_month)

# Regressions and tables of key parameters
var_list <-
  c("salinity",
    "temperature")

lm.test <- vector("list", length(var_list))
 
 for(i in seq_along(var_list)){
     lm.test[[i]] <- lm(reformulate(var_list[i], "datetime"), data = anomalies_SOM_1822)
 }


lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_SOM_1822))
})

reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}

colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")
row.names(reg) <- var_list
reg_ano_SOM_1822 <- reg

# Regression and table anomalies
var_list <-
  c(
    "Salinity_ano",
    "Temperature_ano")

lms <- lapply(var_list, function(x) {
  summary(lm(substitute(i ~ decimal_date(datetime), list(i = as.name(x))), 
             data = anomalies_SOM_1822))
})
reg <- NULL
for (i in 1:length(var_list)) {
  #one loops through all anomalies
  # calculate probability of fstatistic because it cannot be extracted from lms above
  # see http://stats.stackexchange.com/questions/92824/extracting-the-model-p-value-for-a-multiple-regression-in-r
  # slope returned by lm is per second
  prob <-
    pf(lms[[i]]$fstatistic[1],
       lms[[i]]$fstatistic[2],
       lms[[i]]$fstatistic[3],
       lower.tail = FALSE)
  reg <-
    rbind(reg, as.numeric(
      c(
        lms[[i]]$coefficients[2, 1],
        lms[[i]]$coefficients[2, 2],
        lms[[i]]$coefficients[2, 4],
        lms[[i]]$coefficients[1, 1],
        lms[[i]]$coefficients[1, 2],
        lms[[i]]$coefficients[1, 4],
        lms[[i]]$fstatistic[1],
        lms[[i]]$fstatistic[3],
        lms[[i]]$r.squared,
        prob
      )
    ))
}
colnames(reg) <-
  c("Slope",
    "SE Slope",
    "P Slope",
    "Intercept",
    "SE int.",
    "P int.",
    "F",
    "df",
    "R2",
    "P value")

row.names(reg) <- var_list
reg_ano_SOM_1822 <- reg

reg_ano_SOM_1822
```
  
  
###### EOL : Plot of anomalies : Temperature (°C) (2018-2022)  
  

```{r plot anomalies + trends - temperature - EOL 1822, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_EOL_1822 <- ggplot(data = anomalies_EOL_1822, aes(x = datetime_fusion, y = Temperature_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="1 year", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2018-2022)",x="", y="Temp. (°C)") 

plot_temperature_EOL_1822 <- EOL_hourly_1822 %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_line(size=0.7) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("EOL time series observations of temperature (°C) 2018-2022")

plot_temperature_EOL_1822
plot_ano_temp_EOL_1822
```
  
  
###### EOL : Plot of anomalies : Salinity (2018-2022)  
  
*without interpolation*  
  

```{r plot anomalies + trends - salinity - EOL 1822, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_sal_EOL_1822 <- ggplot(data = anomalies_EOL_1822, aes(x = datetime_fusion, y = Salinity_ano), na.rm=TRUE) +
  scale_x_datetime(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2018-2022)",x="", y="Salinity")

plot_salinity_EOL_1822 <- EOL_hourly_1822 %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_datetime(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("EOL time series observations of salinity  2018-2022")

plot_salinity_EOL_1822
plot_ano_sal_EOL_1822
```
  
  
###### SOMLIT : Plot of anomalies : Temperature (°C) (2018-2022)  
  

```{r plot anomalies + trends - temperature - SOMLIT 1822, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_temp_SOM_1822 <- ggplot(data = anomalies_SOM_1822, aes(x = datetime, y = Temperature_ano), 
                                 na.rm=TRUE) +
  scale_x_date(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Temperature anomalies + trend (2018-2022)",x="", y="Temp. (°C)")

plot_temperature_SOM_1822 <- SOMLIT_1822 %>% 
  ggplot() +
  aes(x=datetime, y=temperature) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="Temp. (°C)") +
  ggtitle("SOMLIT time series observations of temperature (°C) 2018-2022")

plot_temperature_SOM_1822
plot_ano_temp_SOM_1822
```
  
  
###### SOMLIT : Plot of anomalies : Salinity (2018-2022)  
  

```{r plot anomalies + trends - salinity - SOMLIT 1822, echo=FALSE, warning=FALSE, message=FALSE}


plot_ano_sal_SOM_1822 <- ggplot(data = anomalies_SOM_1822, aes(x = datetime, y = Salinity_ano), na.rm=TRUE) +
  scale_x_date(date_breaks="1 year", date_minor_breaks="1 years", labels = date_format("%Y")) +
  geom_point(colour="blue", na.rm=TRUE, size=0.65) + 
  geom_smooth(method=lm, colour="black", fill="grey", linewidth=0.6, na.rm=TRUE) +
  labs(title="Salinity anomalies + trend (2018-2022)",x="", y="Salinity")

plot_salinity_SOM_1822 <- SOMLIT_1822 %>% 
  ggplot() +
  aes(x=datetime, y=salinity) + 
  geom_point(size=1) +
  scale_x_date(name="") +
  scale_y_continuous(name="Salinity") +
  ggtitle("SOMLIT time series observations of salinity  2018-2022")

plot_salinity_SOM_1822
plot_ano_sal_SOM_1822
```





